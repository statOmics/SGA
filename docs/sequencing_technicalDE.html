<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Lieven Clement &amp; Koen Van den Berge" />


<title>Sequencing: Selected technical topics</title>

<script src="site_libs/header-attrs-2.28/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="site_libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="site_libs/plotly-binding-4.10.4/plotly.js"></script>
<script src="site_libs/typedarray-0.1/typedarray.min.js"></script>
<link href="site_libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
<script src="site_libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<link href="site_libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="site_libs/plotly-main-2.11.1/plotly-latest.min.js"></script>
<link href="site_libs/font-awesome-6.4.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #204a87; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #204a87; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">SGA</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-chalkboard-teacher"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">---- INTRODUCTION ----</li>
    <li>
      <a href="intro.html">1.1 Position</a>
    </li>
    <li>
      <a href="recapGeneralLinearModel.html">1.2 Recap linear model</a>
    </li>
    <li class="dropdown-header">---- MODULE I PROTEOMICS ----</li>
    <li>
      <a href="./figs/part1_ms_basics.pdf">1.1 MS Basics</a>
    </li>
    <li>
      <a href="./figs/part1_ms_basics.pdf">1.2 Identification</a>
    </li>
    <li>
      <a href="TargetDecoy.html">2.1 Identification - FDR - QC</a>
    </li>
    <li>
      <a href="pda_quantification_preprocessing.html">2.2.1 Quantification - Preprocessing</a>
    </li>
    <li>
      <a href="pda_robustSummarisation_peptideModels.html">2.2.2 Wrap-up Preprocessing - Peptide-Level-Models</a>
    </li>
    <li>
      <a href="pda_quantification_inference.html">2.3.1 Quantification - Differential Abundance Analysis</a>
    </li>
    <li>
      <a href="pda_blocking_wrapup.html">2.3.2. Wrap-up DA - Blocking</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">---- INTRODUCTION ----</li>
    <li>
      <a href="multipleRegression_KPNA2.html">1 Intro KPNA2</a>
    </li>
    <li class="dropdown-header">---- MODULE I PROTEOMICS ----</li>
    <li>
      <a href="https://www.compomics.com/bioinformatics-for-proteomics/">1. Bioinformatics for Proteomics</a>
    </li>
    <li>
      <a href="TargetDecoyTutorial.html">2.1. Target Decoy QC</a>
    </li>
    <li>
      <a href="pda_tutorialPreprocessing.html">2.2. Quantification - Preprocessing</a>
    </li>
    <li>
      <a href="pda_tutorialDesign.html">2.3. Quantification - Design</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Sequencing: Selected technical topics</h1>
<h4 class="author">Lieven Clement &amp; Koen Van den Berge</h4>
<h4 class="date">Last edited on 23 October, 2025</h4>

</div>


<div
id="parameter-estimation-and-inference-in-generalized-linear-models"
class="section level1" number="1">
<h1><span class="header-section-number">1</span> Parameter Estimation
and Inference in Generalized linear models</h1>
<div id="simulate-poisson-data" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Simulate Poisson
Data</h2>
<ul>
<li>We simulate data for 100 observations.</li>
<li>Covariates x are simulated from normal distribution</li>
<li>The <span class="math inline">\(\beta\)</span> are chosen at <span
class="math inline">\(\beta_0=2\)</span>, <span
class="math inline">\(\beta_1=0.8\)</span>, <span
class="math inline">\(\beta_2=1.2\)</span></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">300</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>xhlp<span class="ot">&lt;-</span><span class="fu">cbind</span>(<span class="dv">1</span>,<span class="fu">rnorm</span>(<span class="dv">100</span>),<span class="fu">rnorm</span>(<span class="dv">100</span>))</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>betasTrue<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="fl">0.8</span>,<span class="fl">1.2</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>etaTrue<span class="ot">&lt;-</span>xhlp<span class="sc">%*%</span>betasTrue</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>y<span class="ot">&lt;-</span><span class="fu">rpois</span>(<span class="dv">100</span>,<span class="fu">exp</span>(etaTrue))</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">coef =</span><span class="dv">0</span><span class="sc">:</span><span class="dv">2</span>,<span class="at">betasTrue=</span>betasTrue) <span class="sc">%&gt;%</span> </span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>coef,<span class="at">y=</span>betasTrue)) <span class="sc">+</span> </span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;parameter value&quot;</span>) <span class="sc">+</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;beta&quot;</span>) <span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>))</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<div class="plotly html-widget html-fill-item" id="htmlwidget-480fa3e06a73f5c42de4" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-480fa3e06a73f5c42de4">{"x":{"visdat":{"3b1c53fed96a":["function () ","plotlyVisDat"]},"cur_data":"3b1c53fed96a","attrs":{"3b1c53fed96a":{"x":{},"y":{},"z":{},"mode":"markers","size":0.5,"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter3d","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"aspectmode":"cube","xaxis":{"range":[-2.3424957105876252,2.5745294317880107],"title":"x1"},"yaxis":{"title":"x2"},"zaxis":{"title":"y"}},"yaxis":{"range":[-2.0896111015455219,2.1056439009136327]},"zaxis":{"range":[0,496]},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1.3737908809195094,0.86210687172823852,0.47348910439561598,0.70126281414690683,-0.085055274125850941,1.568702123415022,0.8173919735882893,0.39476860270947117,1.2126985527906875,0.35508065933832028,2.2162742059926384,-0.09054038613482876,-1.3165281108188345,0.066534789021790094,0.51217261794843105,0.050029740995909143,1.4673971806795283,-1.2895205172910114,-0.25769151249919464,0.29305131488208713,-0.33742027524420537,0.63325794588540507,-0.31317859524643482,0.13489312485259145,-1.1447550750922821,-0.31139820998045953,0.23490838742006326,1.3386738166137495,-0.099362220925867828,1.0368993492963112,-0.3455232470647539,0.36289479803801339,-0.80546817274725757,-0.16105157281120572,0.78568505725921145,0.33678422685966014,-0.6797621241984606,0.018678048219562173,-0.20502278988425368,-1.1730775274302627,0.89228159664815843,-0.8211799317287205,-0.21010543321852929,0.39126296753632678,1.3301609843194473,1.3787259492289523,0.97554036432451519,0.66610969595663294,0.45522248121936859,0.25168538999288714,1.0180587408136983,1.6678041857980805,-1.5259593576454331,0.070677460146053653,0.13349706423647448,-0.054982746171481592,-0.71287693284389864,0.085301940023051817,-0.70592842098519293,-0.86302551607147249,-0.061228914782895209,2.5005080753494009,0.65033499678505247,-0.40100817244992781,1.3031543367610237,-0.80739868670466419,1.4529592632023594,-1.2218494802781135,-0.061687461288743882,-0.34623046018732651,-0.031577700937192074,-2.3424957105876252,-0.79534969520878607,-0.72793432146930404,-0.046372881788747038,1.3360597508078036,2.0843301862183536,-0.14673934634900765,-0.50541290556062546,-0.82226985945525843,0.60168269235803784,-0.38096474106048805,-0.1203016323046881,-0.022104041719181559,-1.3633553057537686,0.70334347582582246,0.60318568895455771,-1.0008425814390611,-0.12856218566967104,0.18070804625697853,-0.17666494408157277,1.0653730188555501,0.83114953863099961,-1.2824447706737669,2.5745294317880107,1.4786610032302421,-0.47370913720839569,0.50881297385662894,0.39315021759197727,1.5882712569547759],"y":[1.1831719813830279,0.33215594869814852,-1.4970230980757466,-0.10589397510465613,-0.44454213473616694,0.38237522458763845,0.56396794685742702,-0.045993285138678258,0.018071300813195041,0.73127704118846804,-0.40444925603536569,1.4266006477725905,1.1009521403547411,-0.57506095267543067,1.2515410378803822,0.35922537035482593,-1.7912071199992543,-0.93734439057992791,0.86509203001415791,-0.79285555869134872,0.70306587833317713,-0.010114321310096821,-0.29576001091049736,-0.51354097385034425,-2.0896111015455219,0.21556496049811413,-0.3178444470962955,0.42299048275507811,-1.8115890469776681,2.0608120807864703,-1.6615335396099036,-0.028901886183595953,0.66020084321902883,-0.9756289507831889,-0.23118486517753045,-0.1379223480617644,0.42719909191411204,1.9201828707431676,-1.0861396958995537,0.90641342589605445,0.73113373673963955,1.4915199343245162,0.53701877901546269,0.48483583871872638,0.19441289844731213,0.30564826606121837,0.069130809723756445,-0.066386302015005852,1.2276370130443011,-0.34689383155733711,0.90200909738107871,0.95460500621415934,1.0911873399152492,1.540251054624816,0.79100193444724876,1.2550421354873287,2.1056439009136327,0.47631653070163898,0.86085664807532336,0.99547031906294903,0.58438371265851541,-0.091809183250119816,-0.29349159703352684,-0.96399694498954958,-1.270934818540624,0.41950750781845486,0.57934433973211608,-1.8743365539325871,-0.7316044641806162,-0.48263864877395668,1.4728030439569511,-0.9178944454338297,-1.6001671518501557,-0.67994468074839554,1.745864161657348,1.8733654520252763,0.13503293730943111,-0.68656924450691403,1.2352931283474327,-1.7184028971546526,-0.39469999766938596,-1.5068059534610918,0.29309737109356127,0.1625442984776331,0.61671865101524248,-0.81669214852254701,-0.83873881088451907,0.33924118900133499,0.54325872409221432,0.47390222120824976,1.2363931386521021,-0.81406598906384453,0.038110282211458506,1.003685285757181,1.8495535448814142,0.39837868180483982,-0.77653859209713605,-0.97248382607769046,-0.14595488058437386,1.5966865379161956],"z":[101,23,2,8,3,29,27,9,16,23,21,32,13,7,47,12,1,1,18,2,11,12,1,3,0,6,5,25,1,179,0,8,3,0,5,13,4,65,1,4,40,33,8,23,29,20,22,15,51,6,48,94,11,43,28,32,52,16,16,10,16,47,8,2,4,9,47,0,1,4,47,1,0,1,56,202,35,1,20,0,10,0,18,8,4,3,2,7,9,12,49,6,19,13,496,44,0,1,7,174],"mode":"markers","type":"scatter3d","marker":{"color":"rgba(31,119,180,1)","size":[55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55],"sizemode":"area","line":{"color":"rgba(31,119,180,1)"}},"textfont":{"size":55},"error_y":{"color":"rgba(31,119,180,1)","width":55},"error_x":{"color":"rgba(31,119,180,1)","width":55},"line":{"color":"rgba(31,119,180,1)","width":55},"frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<div class="plotly html-widget html-fill-item" id="htmlwidget-a60541631e7863eb7ae0" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-a60541631e7863eb7ae0">{"x":{"visdat":{"3b1c57572db1":["function () ","plotlyVisDat"]},"cur_data":"3b1c57572db1","attrs":{"3b1c57572db1":{"x":{},"y":{},"z":{},"mode":"markers","size":0.5,"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter3d","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"aspectmode":"cube","xaxis":{"range":[-2.3424957105876252,2.5745294317880107],"title":"x1"},"yaxis":{"title":"x2"},"zaxis":{"title":"log2(y + 0.5)"}},"yaxis":{"range":[-2.0896111015455219,2.1056439009136327]},"zaxis":{"range":[0,496]},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"data":[{"x":[1.3737908809195094,0.86210687172823852,0.47348910439561598,0.70126281414690683,-0.085055274125850941,1.568702123415022,0.8173919735882893,0.39476860270947117,1.2126985527906875,0.35508065933832028,2.2162742059926384,-0.09054038613482876,-1.3165281108188345,0.066534789021790094,0.51217261794843105,0.050029740995909143,1.4673971806795283,-1.2895205172910114,-0.25769151249919464,0.29305131488208713,-0.33742027524420537,0.63325794588540507,-0.31317859524643482,0.13489312485259145,-1.1447550750922821,-0.31139820998045953,0.23490838742006326,1.3386738166137495,-0.099362220925867828,1.0368993492963112,-0.3455232470647539,0.36289479803801339,-0.80546817274725757,-0.16105157281120572,0.78568505725921145,0.33678422685966014,-0.6797621241984606,0.018678048219562173,-0.20502278988425368,-1.1730775274302627,0.89228159664815843,-0.8211799317287205,-0.21010543321852929,0.39126296753632678,1.3301609843194473,1.3787259492289523,0.97554036432451519,0.66610969595663294,0.45522248121936859,0.25168538999288714,1.0180587408136983,1.6678041857980805,-1.5259593576454331,0.070677460146053653,0.13349706423647448,-0.054982746171481592,-0.71287693284389864,0.085301940023051817,-0.70592842098519293,-0.86302551607147249,-0.061228914782895209,2.5005080753494009,0.65033499678505247,-0.40100817244992781,1.3031543367610237,-0.80739868670466419,1.4529592632023594,-1.2218494802781135,-0.061687461288743882,-0.34623046018732651,-0.031577700937192074,-2.3424957105876252,-0.79534969520878607,-0.72793432146930404,-0.046372881788747038,1.3360597508078036,2.0843301862183536,-0.14673934634900765,-0.50541290556062546,-0.82226985945525843,0.60168269235803784,-0.38096474106048805,-0.1203016323046881,-0.022104041719181559,-1.3633553057537686,0.70334347582582246,0.60318568895455771,-1.0008425814390611,-0.12856218566967104,0.18070804625697853,-0.17666494408157277,1.0653730188555501,0.83114953863099961,-1.2824447706737669,2.5745294317880107,1.4786610032302421,-0.47370913720839569,0.50881297385662894,0.39315021759197727,1.5882712569547759],"y":[1.1831719813830279,0.33215594869814852,-1.4970230980757466,-0.10589397510465613,-0.44454213473616694,0.38237522458763845,0.56396794685742702,-0.045993285138678258,0.018071300813195041,0.73127704118846804,-0.40444925603536569,1.4266006477725905,1.1009521403547411,-0.57506095267543067,1.2515410378803822,0.35922537035482593,-1.7912071199992543,-0.93734439057992791,0.86509203001415791,-0.79285555869134872,0.70306587833317713,-0.010114321310096821,-0.29576001091049736,-0.51354097385034425,-2.0896111015455219,0.21556496049811413,-0.3178444470962955,0.42299048275507811,-1.8115890469776681,2.0608120807864703,-1.6615335396099036,-0.028901886183595953,0.66020084321902883,-0.9756289507831889,-0.23118486517753045,-0.1379223480617644,0.42719909191411204,1.9201828707431676,-1.0861396958995537,0.90641342589605445,0.73113373673963955,1.4915199343245162,0.53701877901546269,0.48483583871872638,0.19441289844731213,0.30564826606121837,0.069130809723756445,-0.066386302015005852,1.2276370130443011,-0.34689383155733711,0.90200909738107871,0.95460500621415934,1.0911873399152492,1.540251054624816,0.79100193444724876,1.2550421354873287,2.1056439009136327,0.47631653070163898,0.86085664807532336,0.99547031906294903,0.58438371265851541,-0.091809183250119816,-0.29349159703352684,-0.96399694498954958,-1.270934818540624,0.41950750781845486,0.57934433973211608,-1.8743365539325871,-0.7316044641806162,-0.48263864877395668,1.4728030439569511,-0.9178944454338297,-1.6001671518501557,-0.67994468074839554,1.745864161657348,1.8733654520252763,0.13503293730943111,-0.68656924450691403,1.2352931283474327,-1.7184028971546526,-0.39469999766938596,-1.5068059534610918,0.29309737109356127,0.1625442984776331,0.61671865101524248,-0.81669214852254701,-0.83873881088451907,0.33924118900133499,0.54325872409221432,0.47390222120824976,1.2363931386521021,-0.81406598906384453,0.038110282211458506,1.003685285757181,1.8495535448814142,0.39837868180483982,-0.77653859209713605,-0.97248382607769046,-0.14595488058437386,1.5966865379161956],"z":[6.6653359171851765,4.5545888516776376,1.3219280948873624,3.0874628412503395,1.8073549220576042,4.8826430493618416,4.7813597135246599,3.2479275134435857,4.0443941193584534,4.5545888516776376,4.4262647547020979,5.0223678130284544,3.7548875021634687,2.9068905956085187,5.5698556083309478,3.6438561897747248,0.58496250072115619,0.58496250072115619,4.2094533656289501,1.3219280948873624,3.5235619560570131,3.6438561897747248,0.58496250072115619,1.8073549220576042,-1,2.7004397181410922,2.4594316186372973,4.6724253419714952,0.58496250072115619,7.4878400338230513,-1,3.0874628412503395,1.8073549220576042,-1,2.4594316186372973,3.7548875021634687,2.1699250014423122,6.0334230015374501,0.58496250072115619,2.1699250014423122,5.3398500028846243,5.0660891904577721,3.0874628412503395,4.5545888516776376,4.8826430493618416,4.3575520046180838,4.4918530963296748,3.9541963103868754,5.6865005271832185,2.7004397181410922,5.5999128421871278,6.5622424242210728,3.5235619560570131,5.4429434958487279,4.8328900141647413,5.0223678130284544,5.7142455176661224,4.0443941193584534,4.0443941193584534,3.3923174227787602,4.0443941193584534,5.5698556083309478,3.0874628412503395,1.3219280948873624,2.1699250014423122,3.2479275134435857,5.5698556083309478,-1,0.58496250072115619,2.1699250014423122,5.5698556083309478,0.58496250072115619,-1,0.58496250072115619,5.8201789624151878,7.6617780977719869,5.1497471195046822,0.58496250072115619,4.3575520046180838,-1,3.3923174227787602,-1,4.2094533656289501,3.0874628412503395,2.1699250014423122,1.8073549220576042,1.3219280948873624,2.9068905956085187,3.2479275134435857,3.6438561897747248,5.6293566200796095,2.7004397181410922,4.2854022188622487,3.7548875021634687,8.9556499075283735,5.4757334309663976,-1,0.58496250072115619,2.9068905956085187,7.447083226209652],"mode":"markers","type":"scatter3d","marker":{"color":"rgba(31,119,180,1)","size":[55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55,55],"sizemode":"area","line":{"color":"rgba(31,119,180,1)"}},"textfont":{"size":55},"error_y":{"color":"rgba(31,119,180,1)","width":55},"error_x":{"color":"rgba(31,119,180,1)","width":55},"line":{"color":"rgba(31,119,180,1)","width":55},"frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
</div>
<div id="exponential-family" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Exponential
Family</h2>
<p><span class="math display">\[
f(y_i\vert \theta_i,\phi)=\exp\left\{ \frac{y_i\theta_i-
b(\theta_i)}{a(\phi)}+c(y_i,\phi)\right\}
\]</span></p>
<p>with</p>
<ul>
<li><span class="math inline">\(\theta_i\)</span>: canonical
parameters</li>
<li><span class="math inline">\(\phi\)</span>: dispersion parameter</li>
<li><span class="math inline">\(a(.)\)</span>, <span
class="math inline">\(b(.)\)</span>, <span
class="math inline">\(c(.)\)</span>: specific functions that depend on
the distribution,</li>
</ul>
<p>e.g. for normal distribution</p>
<ul>
<li><span class="math inline">\(\phi=\sigma^2\)</span>,</li>
<li><span class="math inline">\(\theta=\mu\)</span>,</li>
<li><span class="math inline">\(a(\phi)=\phi=\sigma^2\)</span>,</li>
<li><span class="math inline">\(b(\theta_i)=\theta_i^2/2\)</span>,</li>
<li><span
class="math inline">\(c(y_i,\phi)=-\frac{1}{2}[y^2/\phi+\log(2\pi\phi)]\)</span></li>
</ul>
<div id="poisson-distribution" class="section level3" number="1.2.1">
<h3><span class="header-section-number">1.2.1</span> Poisson
Distribution</h3>
<p><span class="math display">\[
y_i \sim \frac{\mu_i^{y_i}e^{-\mu_i}}{y_i!}
\]</span></p>
<p>In format of exponential family:</p>
<p><span class="math display">\[
y_i \sim \exp\left\{y_i\log(\mu_i) - \mu_i - \log(y_i!)\right\}
\]</span></p>
</div>
</div>
<div id="components-of-generalized-linear-model" class="section level2"
number="1.3">
<h2><span class="header-section-number">1.3</span> Components of
Generalized Linear Model</h2>
<p><span class="math display">\[
\left\{\begin{array}{ccc}
y_i\vert x_i&amp;\sim&amp;f(y_i\vert{\theta}_i,\phi)\\\\
\text{E}\left[ y_i\vert \mathbf{x}_i\right]&amp;=&amp;\mu_i\\\\
g(\mu_i)&amp;=&amp;\eta(\mathbf{x}_i)\\\\
\eta(\mathbf{x}_i)&amp;=&amp;\mathbf{x}_i^T\boldsymbol{\beta}
\end{array}\right.,
\]</span> with <span class="math inline">\(g(.)\)</span> the link
function, e.g. </p>
<ul>
<li><span class="math inline">\(g(.)=.\)</span> : identity link for
Normal distribution</li>
<li><span class="math inline">\(g(.)=\log(.)\)</span> : canonical link
for Poisson distribution</li>
<li><span
class="math inline">\(g(.)=\text{logit}(.)=\log\left[\frac{(.)}{(1-.)}\right]\)</span>
: canonical link for Bernouilli distribution.</li>
</ul>
<div id="poisson-glm" class="section level3" number="1.3.1">
<h3><span class="header-section-number">1.3.1</span> Poisson GLM</h3>
<p><span class="math display">\[\left\{\begin{array}{lcr}
y_i &amp;\sim&amp; Poisson(\mu_i)\\
E[y_i]&amp;=&amp;\mu_i\\
\log(\mu_i)&amp;=&amp;\eta_i\\
\eta_i&amp;=&amp;\mathbf{x}_i\boldsymbol{\beta}
\end{array}\right.\]</span></p>
</div>
</div>
<div id="likelihood" class="section level2" number="1.4">
<h2><span class="header-section-number">1.4</span> Likelihood</h2>
<p>We start from a sample, and consider it as fixed and known.</p>
<ul>
<li><p>In particular we do NOT consider the sample observations as
random variables.</p></li>
<li><p>Therefore we write the observed sample as <span
class="math inline">\(y_i, . . . , y_n\)</span></p></li>
<li><p>The theory is based on the likelihood function, which can be
interpreted as a measure for the probability that the given sample is
observed as a realisation of a sequence of random variables <span
class="math inline">\(Y_1, \ldots Y_n\)</span></p></li>
<li><p>The random variables <span class="math inline">\(Y_i\)</span> are
characterized by a distribution or density function which has typically
unknown parameters, e.g. a Poisson distribution <span
class="math inline">\(f(Y_i)\sim
\text{Poisson}(\theta_i)\)</span>.</p></li>
<li><p>When the subjects are mutually independent the joint likelihood
to observe <span class="math inline">\(y_1, \ldots, y_n\)</span> equals
<span class="math display">\[\prod\limits_{i=1}^n
f(y_i,\theta_i,\phi)\]</span></p></li>
<li><p>The densities are actually also a function of the parameters
<span class="math inline">\(\theta_i, \phi\)</span>. To stress this, we
indicated that in the density formulation.</p></li>
<li><p>The likelihood function is a function of all parameters</p></li>
</ul>
<p><span class="math display">\[
L(\boldsymbol{\theta},\phi\vert \boldsymbol{y})=\prod\limits_{i=1}^n
f(y_i,\theta_i,\phi)
\]</span></p>
<ul>
<li>The log-likelihood function is often used, which is defined as <span
class="math display">\[
l(\boldsymbol{\theta},\phi\vert \boldsymbol{y}) = \log
L(\boldsymbol{\theta},\phi\vert \boldsymbol{y}) =  \sum\limits_{i=1}^n
\log  f(y_i,\theta_i,\phi)
\]</span></li>
</ul>
<div id="poisson-example" class="section level3" number="1.4.1">
<h3><span class="header-section-number">1.4.1</span> Poisson
Example</h3>
<p>The log-likelihood for our simulated dataset given the real model
parameters is:</p>
<p>For one observation: <span class="math display">\[l(\mu_i \vert y_i)
= y_i \log \mu_i - \mu_i - \log y_i!\]</span></p>
<ul>
<li>Verify in R.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>muTrue <span class="ot">&lt;-</span> <span class="fu">exp</span>(etaTrue)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>loglikPois <span class="ot">&lt;-</span> <span class="fu">dpois</span>(y,muTrue,<span class="at">log =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>logLikSelf <span class="ot">&lt;-</span> y<span class="sc">*</span><span class="fu">log</span>(muTrue) <span class="sc">-</span> muTrue <span class="sc">-</span> <span class="fu">lfactorial</span>(y)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="fu">qplot</span>(loglikPois,logLikSelf) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span> <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope=</span><span class="dv">1</span>)</span></code></pre></div>
<pre><code>## Warning: `qplot()` was deprecated in ggplot2 3.4.0.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
## generated.</code></pre>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>The log-likelihood can also be written in terms of the canonical
model parameters <span class="math inline">\(\theta\)</span></p>
<p><span class="math display">\[l(\mu_i \vert y_i) = y_i \theta_i -
e^{\theta_i} - \log y_i!\]</span></p>
<ul>
<li>Note that <span class="math inline">\(\theta_i = \eta_i\)</span>.
The canonical parameter for the poisson equals the linear predictor!
<span
class="math display">\[\theta_i=\eta_i=\mathbf{x}_i^t\boldsymbol{\beta}\]</span></li>
</ul>
<p>Log-likelihood for all observations, given that they are independent:
<span class="math display">\[l(\boldsymbol{\mu} \vert \mathbf{y}) =
\sum\limits_{i=1}^n \left\{ y_i \theta_i - e^{\theta_i} - \log
y_i!\right\}\]</span></p>
<ul>
<li>Calculate in R:</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">dpois</span>(y,<span class="at">lambda =</span> muTrue, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">sum</span>()</span></code></pre></div>
<pre><code>## [1] -260.485</code></pre>
</div>
<div id="properties-of-the-log-likelihood" class="section level3"
number="1.4.2">
<h3><span class="header-section-number">1.4.2</span> Properties of the
Log-Likelihood</h3>
<p><span class="math display">\[
l(\theta_i,\phi\vert y_i)=\left\{ \frac{y_i\theta_i-
b(\theta_i)}{a(\phi)}+c(y_i,\phi)\right\}
\]</span></p>
<ul>
<li><span
class="math inline">\(E[y_i]=\mu_i=b^\prime(\theta_i)\)</span></li>
<li><span
class="math inline">\(\text{var}[y_i]=b^{\prime\prime}(\theta_i)
a(\phi)\)</span></li>
</ul>
<p>Note that,</p>
<ul>
<li>Variance <span class="math inline">\(\text{var}[y_i]\)</span>
depends on mean!</li>
<li>Often there is no dispersion parameter e.g. Bernouilli: <span
class="math inline">\(\text{var}[y_i]=\mu_i(1-\mu_i)\)</span>,</li>
</ul>
</div>
<div id="poisson-example-1" class="section level3" number="1.4.3">
<h3><span class="header-section-number">1.4.3</span> Poisson
Example</h3>
<ul>
<li>Canonical model parameter <span
class="math inline">\(\theta_i=\log{\mu_i}\)</span>.</li>
<li><span class="math inline">\(b(\theta_i) =
\exp(\theta_i)\)</span></li>
<li><span class="math inline">\(c(y_i,\phi) = - \log(y_i!)\)</span></li>
<li><span class="math inline">\(\phi = 1\)</span></li>
<li><span class="math inline">\(a(\phi)= 1\)</span></li>
<li><span class="math inline">\(\mu_i =\frac{\partial
b(\theta_i)}{\partial \theta_i}=  \frac{\partial
\exp(\theta_i)}{\partial \theta_i}=\exp(\theta_i)\)</span></li>
<li><span class="math inline">\(\text{Var}\left[y_i \right]=
a(\phi)\frac{\partial^2 b(\theta_i)}{(\partial
\theta_i)^2}=  \frac{\partial^2 \exp(\theta_i)}{\partial
\theta_i^2}=\exp(\theta_i)\)</span>.</li>
<li>Mean is equal to variance for Poisson!</li>
</ul>
</div>
</div>
<div id="parameter-estimation-maximum-likelihood" class="section level2"
number="1.5">
<h2><span class="header-section-number">1.5</span> Parameter Estimation:
Maximum Likelihood</h2>
<p>Choose the parameters <span
class="math inline">\(\boldsymbol{\beta}\)</span> so that the likelihood
to observe the sample under the statistical model is maximized.</p>
<p>It is easier and equivalent to maximize the log-likihood</p>
<p><span class="math display">\[\text{argmax}_{\boldsymbol{\beta}}
l(\boldsymbol{\mu} \vert \mathbf{y})\]</span></p>
<p><span class="math display">\[
\frac{\partial  l(\boldsymbol{\mu} \vert \mathbf{y})}{
\partial{\boldsymbol{\beta}}}=0
\]</span></p>
<p><span class="math inline">\(\frac{\partial  l(\boldsymbol{\mu} \vert
\mathbf{y})}{
\partial{\boldsymbol{\beta}}}\)</span> is also referred to as the score
function.</p>
<div id="score-function" class="section level3" number="1.5.1">
<h3><span class="header-section-number">1.5.1</span> Score function</h3>
<p><span class="math display">\[
S_i(\theta_i)= \frac{\partial l(\theta_i,\phi\vert y_i)}{\partial
\theta_i}
\]</span></p>
<p><span class="math display">\[
S_i(\theta_i)= \frac{\partial l(\theta_i,\phi\vert y_i)}{\partial
\theta_i}=\frac{y_i - \mu_i}{a(\phi)}
\]</span></p>
<p>when canonical link function is used:</p>
<ul>
<li><span class="math inline">\(\mu_i=b^\prime(\theta_i)\)</span></li>
</ul>
<p>Regression (chain rule and <span
class="math inline">\(i=1,\ldots,n\)</span> i.i.d observations)</p>
<p><span class="math display">\[\begin{eqnarray*}
S(\boldsymbol{\beta})&amp;=&amp;\frac{\partial  \sum\limits_{i=1}^n
\left\{ \frac{y_i \theta_i -
b(\theta_i)}{a(\phi)}+c(y_i,\phi)\right\}}{\partial \beta}\\
&amp;=&amp;\sum\limits_{i=1}^n\frac{\partial  \left\{ \frac{y_i \theta_i
- b(\theta_i)}{a(\phi)}+c(y_i,\phi)\right\}}{\partial
\theta}\frac{\partial
\theta}{\partial\mu}\frac{\partial\mu}{\partial\eta}\frac{\partial\eta}{\partial\beta}\\
&amp;=&amp;\sum\limits_{i=1}^n\frac{y_i-\mu_i}{a(\phi)}\frac{1}{b^{\prime\prime}(\theta)}\frac{\partial\mu}{\partial\eta}\mathbf{x}^t\\
&amp;=&amp;\mathbf{X}^T\mathbf{A}\left(\mathbf{y}-\boldsymbol{\mu}\right)
\end{eqnarray*}\]</span></p>
<ul>
<li><span class="math inline">\(\boldsymbol{A}\)</span> is a diagonal
matrix: <span
class="math inline">\(a_{ii}=\left(\text{var}[y_i]\frac{\partial
\eta_i}{\partial \mu_i}\right)^{-1}\)</span>, <span
class="math inline">\(\boldsymbol{y}=[y_1,\ldots, y_n]^T\)</span>, <span
class="math inline">\(\boldsymbol{\mu}=[\mu_1,\ldots,\mu_n]^T\)</span></li>
</ul>
<div id="poisson-example-2" class="section level4" number="1.5.1.1">
<h4><span class="header-section-number">1.5.1.1</span> Poisson
Example</h4>
<p>For poisson data: <span
class="math inline">\(a(\phi)b^{\prime\prime}(\theta)=\mu\)</span> and
<span class="math inline">\(\frac{\partial \mu}{\partial
\eta}=\mu\)</span>. So <span
class="math inline">\(\mathbf{A}=\mathbf{I}\)</span> and</p>
<p><span class="math display">\[ S(\beta)=\mathbf{X}^T
\left\{\mathbf{Y}-\boldsymbol{\mu}\right\}\]</span></p>
</div>
</div>
<div id="solve-score-equations" class="section level3" number="1.5.2">
<h3><span class="header-section-number">1.5.2</span> Solve Score
Equations</h3>
<p>Find parameter estimator <span
class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> so that <span
class="math display">\[ S(\boldsymbol{\beta}) = \mathbf{0}\]</span>
<span
class="math display">\[\mathbf{X}^T\mathbf{A}\left(\mathbf{y}-\boldsymbol{\mu}\right)
=\mathbf{0}\]</span> Problem! Non linear in <span
class="math inline">\(\beta\)</span> due to</p>
<ul>
<li>link function: <span
class="math inline">\(\boldsymbol{\mu}=h^{-1}(\eta)\)</span></li>
<li><span
class="math inline">\(a_{ii}=\left(\text{var}[y_i]\frac{\partial
\eta_i}{\partial \mu_i}\right)^{-1}\)</span></li>
</ul>
<p><span class="math inline">\(\rightarrow\)</span> Find roots of score
equation by using Newton-Raphson method.</p>
</div>
<div id="newton-raphson" class="section level3" number="1.5.3">
<h3><span class="header-section-number">1.5.3</span> Newton-Raphson</h3>
<div class="figure">
<img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-7-1.png" alt="Newton-Raphson algorithm: The algorithm starts at an initial guess bk for the root of the score function S. It walks along the tangent line of the score function in S(bk)  to move into the direction where the score function becomes zero (and where the log-likelihood function is maximal). The new estimate of the root is taken at bk+1 where the tangent line becomes zero. It then calculates the score for the updated parameter estimator and the whole process is repeated until the root is found." width="672" />
<p class="caption">
Newton-Raphson algorithm: The algorithm starts at an initial guess bk
for the root of the score function S. It walks along the tangent line of
the score function in S(bk) to move into the direction where the score
function becomes zero (and where the log-likelihood function is
maximal). The new estimate of the root is taken at bk+1 where the
tangent line becomes zero. It then calculates the score for the updated
parameter estimator and the whole process is repeated until the root is
found.
</p>
</div>
<p>Newton Raphson algorithm to find the root of the score function.</p>
<ol style="list-style-type: decimal">
<li>Choose initial parameter estimate <span
class="math inline">\(\boldsymbol{\beta}^k=\boldsymbol{\beta}^0\)</span></li>
<li>Calculate score <span
class="math inline">\(S(\boldsymbol{\beta})\vert_{\boldsymbol{\beta}=\boldsymbol{\beta}^k}\)</span></li>
<li>Calculate derivative of the function for which you want to calculate
the roots</li>
<li>Walk along first derivative until line (plane) of the derivative
crosses zero</li>
<li>Update the betas <span
class="math inline">\(\boldsymbol{\beta}^{k+1}\)</span></li>
<li>Iterate from step 2 - 5 until convergence.</li>
</ol>
<div id="derivative-of-score" class="section level4" number="1.5.3.1">
<h4><span class="header-section-number">1.5.3.1</span> Derivative of
Score</h4>
<p>We have to implement an interative algorithm for optimisation. To
make things tractable we will act as if <span
class="math inline">\(\mathbf{A}\)</span> is known and fix it using the
current values of <span
class="math inline">\(\boldsymbol{\beta}^k\)</span>. Note, that for
Poisson regression <span
class="math inline">\(\mathbf{A}=\mathbf{I}\)</span>.</p>
<p><span class="math display">\[\begin{eqnarray*}
\frac{\partial S(\boldsymbol{\beta})}{\partial \boldsymbol{\beta}}
&amp;=&amp; \frac{ \mathbf{X}^T\mathbf{A}
\left\{\mathbf{Y}-\boldsymbol{\mu}\right\}}{\partial
\boldsymbol{\beta}}\\
&amp;=&amp; - \mathbf{X}^T \mathbf{A}\left[
\begin{array}{cccc} \frac{\partial \mu_1}{\partial \eta_1}
&amp;0&amp;\ldots&amp;0\\
0&amp;\frac{\partial \mu_2}{\partial \eta_2} &amp;\ldots&amp;0\\
\vdots&amp;\vdots&amp;\vdots&amp;\vdots\\
0&amp;0&amp;\ldots&amp; \frac{\partial \mu_n}{\partial \eta_n}\\
\end{array}\right] \frac{\partial \boldsymbol{\eta}}{\partial
\boldsymbol{\beta}}\\
&amp;=&amp;-\mathbf{X}^T\mathbf{WX}
\end{eqnarray*}\]</span></p>
</div>
<div id="define-equation-of-tangent-line-plane" class="section level4"
number="1.5.3.2">
<h4><span class="header-section-number">1.5.3.2</span> Define equation
of Tangent Line (Plane)</h4>
<ul>
<li><p>We know two points of the tangent plane <span
class="math inline">\((\boldsymbol{\beta}^k,S(\boldsymbol{\beta}^k))\)</span>
and <span
class="math inline">\((\boldsymbol{\beta}^{k+1},0)\)</span></p></li>
<li><p>We know the direction of the plane <span
class="math inline">\(S^\prime(\boldsymbol{\beta})=\frac{\partial
S(\boldsymbol{\beta})}{\partial \boldsymbol{\beta}}\)</span></p></li>
<li><p>Equation of Plane: <span
class="math display">\[S(\boldsymbol{\beta})={\alpha}_0+S^\prime\vert_{\boldsymbol{\beta}^k}
\boldsymbol{\beta}\]</span></p></li>
<li><p>Get <span class="math inline">\(\boldsymbol{\beta}_{k+1}\)</span>
<span class="math display">\[\begin{eqnarray*}
\mathbf{0}&amp;=&amp;{\alpha}_0+S^\prime\vert_{\boldsymbol{\beta}^{k}}
\boldsymbol{\beta}^{k+1}\\
\boldsymbol{\beta}^{k+1}&amp;=&amp;-\left(S^{\prime}\vert_{\boldsymbol{\beta}^{k}}\right)^{-1}{\alpha}_0\\
\end{eqnarray*}\]</span></p></li>
<li><p>Get <span class="math inline">\({\alpha}_0\)</span> <span
class="math display">\[\begin{eqnarray*}
S(\boldsymbol{\beta}^k)&amp;=&amp;\boldsymbol{\alpha}_0+S^\prime\vert_{\boldsymbol{\beta}^k}
\boldsymbol{\beta}^k\\
{\alpha}_0&amp;=&amp;-S^\prime\vert_{\boldsymbol{\beta}^k}
\boldsymbol{\beta}^k + S(\boldsymbol{\beta}^k)\\
\end{eqnarray*}\]</span></p></li>
<li><p>Get <span
class="math inline">\(\boldsymbol{\beta}_{k+1}\)</span></p></li>
</ul>
<p><span class="math display">\[\begin{eqnarray*}
\boldsymbol{\beta}^{k+1}&amp;=&amp;\boldsymbol{\beta}^k-\left(S^{\prime}\vert_{\boldsymbol{\beta}^{k}}\right)^{-1}S(\boldsymbol{\beta}^k)\\
\boldsymbol{\beta}^{k+1}&amp;=&amp;\boldsymbol{\beta}^k+
\left(\mathbf{X}^T\mathbf{WX}\right)^{-1} S(\boldsymbol{\beta}^k)
\end{eqnarray*}\]</span></p>
<p>With <span
class="math inline">\(J(\boldsymbol{\beta})=I(\boldsymbol{\beta})=\mathbf{X}^T\mathbf{WX}\)</span>
the Fisher information matrix.</p>
</div>
</div>
<div id="fisher-scoring" class="section level3" number="1.5.4">
<h3><span class="header-section-number">1.5.4</span> Fisher Scoring</h3>
<p>Because we use the canonical model parameters the observed Fisher
information matrix equals the expected Fisher information matrix <span
class="math inline">\(J(\boldsymbol{\beta})=I(\boldsymbol{\beta})\)</span>.
Indeed, the observed Fisher information matrix is not depending on the
observations, but only on the design and the variance of the data (via
the weights).</p>
<p>Hence, Newton-Raphson is equivalent to Fisher scoring when the
canonical link function is used.</p>
<p>Note, that the Fisher matrix, minus second derivative (or hessian) of
the likelihood to the model parameters, is also the inverse of the
variance covariance matrix of the model parameters. It is thus related
to the precision.</p>
</div>
<div id="iteratively-reweighted-least-squares-irls."
class="section level3" number="1.5.5">
<h3><span class="header-section-number">1.5.5</span> Iteratively
Reweighted Least Squares (IRLS).</h3>
<p>We can rewrite Newton Raphson or Fisher scoring as IRLS.</p>
<p><span class="math display">\[\begin{eqnarray*}
\boldsymbol{\beta}^{k+1}&amp;=&amp;\boldsymbol{\beta}^k+
\left(\mathbf{X}^T\mathbf{WX}\right)^{-1} S(\boldsymbol{\beta}^k)\\
\boldsymbol{\beta}^{k+1}&amp;=&amp;\boldsymbol{\beta}^k+
\left(\mathbf{X}^T\mathbf{WX}\right)^{-1} \mathbf{X}^T\mathbf{A}
\left(\mathbf{Y}-\boldsymbol{\mu}\right)\\
\boldsymbol{\beta}^{k+1}&amp;=&amp;
\left(\mathbf{X}^T\mathbf{WX}\right)^{-1}\mathbf{X}^T\mathbf{WX}\boldsymbol{\beta}^k+
\left(\boldsymbol{X}^T\mathbf{WX}\right)^{-1} \mathbf{X}^T
\mathbf{W}\frac{\partial \eta}{\partial
\mu}  \left(\mathbf{Y}-\boldsymbol{\mu}\right)\\
\boldsymbol{\beta}^{k+1}&amp;=&amp;
\left(\mathbf{X}^T\mathbf{WX}\right)^{-1}\mathbf{X}^T\mathbf{W}
\left[\mathbf{X}\boldsymbol{\beta}^k + \frac{\partial \eta}{\partial
\mu}  \left(\mathbf{Y}-\boldsymbol{\mu}\right)
\right]\\
\boldsymbol{\beta}^{k+1}&amp;=&amp;
\left(\mathbf{X}^T\mathbf{WX}\right)^{-1}\mathbf{X}^T\mathbf{Wz}
\end{eqnarray*}\]</span></p>
<p>with <span
class="math inline">\(\mathbf{z}=\left[\mathbf{X}\boldsymbol{\beta}^k +
\frac{\partial \eta}{\partial
\mu}  \left(\mathbf{Y}-\boldsymbol{\mu}\right)\right]\)</span></p>
<p>So we can fit the model by performing iterative regressions of the
pseudo data <span class="math inline">\(\mathbf{z}\)</span> on <span
class="math inline">\(\mathbf{X}\)</span>. In each iteration we will
update <span class="math inline">\(\mathbf{z}\)</span>, the weights
<span class="math inline">\(\mathbf{W}\)</span> and the model
parameters.</p>
<p>For Poisson data</p>
<ul>
<li><span class="math inline">\(\frac{\partial \eta}{\partial
\mu}=\frac{\partial\log
\mu}{\partial\mu}=\frac{1}{\mu}=\exp(-\eta)\)</span><br />
</li>
<li><span
class="math inline">\(\mathbf{W}=\mathbf{A}\frac{\partial{\mu}}{{\partial
\eta}}\)</span> is a diagonal matrix with <span
class="math inline">\([\frac{\partial{\mu_i}}{{\partial
\eta_i}}]_{ii}=[\mu_i]_{ii}=[\exp(\eta_i)]_{ii}\)</span> on its diagonal
elements.</li>
</ul>
</div>
<div id="variance-covariance-matrix-of-mean-model-parameters"
class="section level3" number="1.5.6">
<h3><span class="header-section-number">1.5.6</span> Variance-Covariance
Matrix of Mean Model Parameters?</h3>
<p>In the IRWLS algorithm, the data is weighted according to the
variance of <span class="math inline">\(\mathbf{Y}\)</span>. We correct
for the fact that the data are heteroscedastic.</p>
<p>Count data have a mean variance relation (e.g. in Poisson case <span
class="math inline">\(\text{E}\left[Y \right]=\text{var}\left[Y
\right]=\mu\)</span>). The IRWLS also corrects for the scale parameter
<span class="math inline">\(\phi\)</span> in <span
class="math inline">\(\mathbf{W}\)</span>. (Note that the scale
parameter for Poisson is <span
class="math inline">\(\phi=1\)</span>).</p>
<p>So IRWLS the variance-covariance matrix for the model parameter
equals <span
class="math display">\[\mathbf{\Sigma}_{\hat\beta}=\left(\mathbf{X}^T\mathbf{WX}\right)^{-1}.\]</span></p>
<p>Note, that the Fisher Information Matrix equals the inverse of the
variance-covariance matrix of the experiment. The larger the Fisher
Information Matrix the more information we have on the experiment to
estimate the model parameters. FIM <span
class="math inline">\(\uparrow\)</span>, precision <span
class="math inline">\(\uparrow\)</span>, <span
class="math inline">\(\text{SE}\downarrow\)</span></p>
</div>
</div>
<div id="poisson-example-3" class="section level2" number="1.6">
<h2><span class="header-section-number">1.6</span> Poisson Example</h2>
<div id="initial-estimate" class="section level3" number="1.6.1">
<h3><span class="header-section-number">1.6.1</span> Initial
Estimate</h3>
<p>This is a very poor initial estimate used to illustrate the
algorithm. Otherwise convergence for this simple example is way too
quick</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>iteration<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>betas<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">log</span>(<span class="fu">mean</span>(y)),<span class="dv">0</span>,<span class="dv">0</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="fu">plot</span>(betasTrue,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>     <span class="at">ylab=</span><span class="fu">expression</span>(beta),</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>     <span class="at">pch=</span><span class="dv">19</span>,</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>     <span class="at">type=</span><span class="st">&quot;b&quot;</span>, </span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>     <span class="at">main=</span><span class="fu">paste0</span>(<span class="st">&quot;likelihood real beta=&quot;</span>,</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>                 <span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">dpois</span>(y,<span class="fu">exp</span>(etaTrue),<span class="at">log=</span><span class="cn">TRUE</span>)),<span class="dv">1</span>),<span class="st">&quot;</span><span class="sc">\n</span><span class="st">likelihood fit=&quot;</span>, <span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">dpois</span>(y,<span class="fu">exp</span>(xhlp<span class="sc">%*%</span>betas),<span class="at">log=</span><span class="cn">TRUE</span>)),<span class="dv">1</span>))</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>)</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="fu">lines</span>(betas,<span class="at">type=</span><span class="st">&quot;b&quot;</span>,<span class="at">lty=</span><span class="dv">2</span> )</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
</div>
<div id="iteratively-reweighted-least-squares" class="section level3"
number="1.6.2">
<h3><span class="header-section-number">1.6.2</span> Iteratively
Reweighted Least Squares</h3>
<div id="pseudo-data" class="section level4" number="1.6.2.1">
<h4><span class="header-section-number">1.6.2.1</span> Pseudo Data</h4>
<p><span class="math display">\[z_i= \eta_i + \frac{\partial
\eta_i}{\partial \mu_i}(y_i -\mu_i)\]</span> <span
class="math display">\[z_i= \eta_i + e^{-\eta_i} y_i -1\]</span></p>
</div>
<div id="weight-matrix" class="section level4" number="1.6.2.2">
<h4><span class="header-section-number">1.6.2.2</span> Weight
Matrix?</h4>
<p><span class="math display">\[[w_{ii}]= var_{y_i}^{-1}
\left(\frac{\partial \mu}{\partial \eta}\right)^2\]</span> <span
class="math display">\[[w_{ii}]= e^{\eta_i}\]</span></p>
</div>
<div id="run-update-step-multiple-times" class="section level4"
number="1.6.2.3">
<h4><span class="header-section-number">1.6.2.3</span> Run Update Step
Multiple Times</h4>
<p>First 3 times (colors are black 0, red iteration 1, green iteration
2, blue iteration 3)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="fu">plot</span>(betasTrue,<span class="at">ylab=</span><span class="fu">expression</span>(beta),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),<span class="at">pch=</span><span class="dv">19</span>,<span class="at">type=</span><span class="st">&quot;b&quot;</span>)</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">lines</span>(betas,<span class="at">type=</span><span class="st">&quot;b&quot;</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">likelihood TRUE=&quot;</span>, <span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">dpois</span>(y,<span class="fu">exp</span>(xhlp<span class="sc">%*%</span>betasTrue),<span class="at">log=</span><span class="cn">TRUE</span>)),<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 
## likelihood TRUE= -260.5</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">likelihood initial fit=&quot;</span>, <span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">dpois</span>(y,<span class="fu">exp</span>(xhlp<span class="sc">%*%</span>betas),<span class="at">log=</span><span class="cn">TRUE</span>)),<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 
## likelihood initial fit= -2891.5</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">#Calculate current eta</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>eta<span class="ot">&lt;-</span>xhlp<span class="sc">%*%</span>betas</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>iteration<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>{</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">#start IRLS UPDATE STEP</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>iteration<span class="ot">=</span>iteration<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#calculate pseudo data based on current betas</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>z<span class="ot">=</span>eta<span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>eta)<span class="sc">*</span>(y<span class="sc">-</span><span class="fu">exp</span>(eta))</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#calculate new weights: diagonal elements</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>w<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">exp</span>(eta))</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">#update betas</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>lmUpdate<span class="ot">&lt;-</span><span class="fu">lm</span>(z<span class="sc">~-</span><span class="dv">1</span><span class="sc">+</span>xhlp,<span class="at">weight=</span>w)</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co">#eta&lt;-xhlp%*%betas</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>eta<span class="ot">&lt;-</span>lmUpdate<span class="sc">$</span>fitted</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>betas<span class="ot">&lt;-</span>lmUpdate<span class="sc">$</span>coef</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="fu">lines</span>(betas,<span class="at">type=</span><span class="st">&quot;b&quot;</span>,<span class="at">col=</span>iteration<span class="sc">+</span><span class="dv">1</span>,<span class="at">pch=</span>iteration,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">likelihood current fit=&quot;</span>, <span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">dpois</span>(y,<span class="fu">exp</span>(xhlp<span class="sc">%*%</span>betas),<span class="at">log=</span><span class="cn">TRUE</span>)),<span class="dv">1</span>))</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<pre><code>## 
## likelihood current fit= -1883.9
## likelihood current fit= -431.8
## likelihood current fit= -261.7</code></pre>
</div>
</div>
</div>
<div id="comparison-with-glm-function" class="section level2"
number="1.7">
<h2><span class="header-section-number">1.7</span> Comparison with GLM
Function</h2>
<div id="smarter-initialisation" class="section level3" number="1.7.1">
<h3><span class="header-section-number">1.7.1</span> Smarter
Initialisation</h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>z<span class="ot">&lt;-</span><span class="fu">log</span>(y<span class="fl">+.5</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>betas<span class="ot">&lt;-</span><span class="fu">lm</span>(z<span class="sc">~-</span><span class="dv">1</span><span class="sc">+</span>xhlp)<span class="sc">$</span>coef</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="fu">plot</span>(betasTrue,<span class="at">ylab=</span><span class="fu">expression</span>(beta),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),<span class="at">pch=</span><span class="dv">19</span>,<span class="at">type=</span><span class="st">&quot;b&quot;</span>)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="fu">lines</span>(betas,<span class="at">col=</span><span class="dv">2</span>,<span class="at">type=</span><span class="st">&quot;b&quot;</span>,<span class="at">lty=</span><span class="dv">2</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co">#calculate current eta</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>eta<span class="ot">&lt;-</span>xhlp<span class="sc">%*%</span>betas</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">likelihood TRUE=&quot;</span>, <span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">dpois</span>(y,<span class="fu">exp</span>(xhlp<span class="sc">%*%</span>betasTrue),<span class="at">log=</span><span class="cn">TRUE</span>)),<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 
## likelihood TRUE= -260.5</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;</span><span class="sc">\n</span><span class="st">likelihood initial fit=&quot;</span>, <span class="fu">round</span>(<span class="fu">sum</span>(<span class="fu">dpois</span>(y,<span class="fu">exp</span>(xhlp<span class="sc">%*%</span>betas),<span class="at">log=</span><span class="cn">TRUE</span>)),<span class="dv">1</span>))</span></code></pre></div>
<pre><code>## 
## likelihood initial fit= -263.8</code></pre>
</div>
<div id="evaluation-stopping-criterion" class="section level3"
number="1.7.2">
<h3><span class="header-section-number">1.7.2</span> Evaluation Stopping
Criterion</h3>
<ul>
<li>Residual deviance: Is 2 log of LR between best possible fit and
current fit <span
class="math display">\[LR=\frac{L_\text{best}}{L_\text{current}}\]</span>
<span class="math display">\[D=2 (\log L_\text{best}- \log
L_\text{current})\]</span> <span class="math display">\[D=2
(l_\text{best}-l_\text{current})\]</span></li>
<li>Best fit: <span class="math inline">\(\mu=y\)</span></li>
<li>Optimal poisson: <span class="math display">\[
l_\text{best}=\sum\left[y_i \log(y_i) - y_i -
\log\left(y_i!\right)\right]\]</span></li>
<li>Current fit <span class="math display">\[ l_\text{current}=\sum
\left[y_i \eta_i -e^{\eta_i} - log\left(y_i!\right)\right]\]</span></li>
<li>Deviance D: <span class="math display">\[D = 2 \sum \left[ y_i
log(y_i) - y_i \eta_i - (y_i -e^{\eta_i})\right]\]</span></li>
<li>Problem to calculate it if y=0 but by apply l’Hopital’s rule we know
<span class="math display">\[\lim_{y_i \to 0} y_i \log(y_i)
=0\]</span></li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>ylogy<span class="ot">&lt;-</span><span class="cf">function</span>(y)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>{</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="fu">return</span>(<span class="fu">ifelse</span>(y<span class="sc">==</span><span class="dv">0</span>,<span class="fu">rep</span>(<span class="dv">0</span>,<span class="fu">length</span>(y)),y<span class="sc">*</span><span class="fu">log</span>(y)))</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>}</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>deviance<span class="ot">&lt;-</span><span class="dv">2</span><span class="sc">*</span><span class="fu">sum</span>(<span class="fu">ylogy</span>(y)<span class="sc">-</span>y<span class="sc">*</span>eta<span class="sc">-</span>(y<span class="sc">-</span><span class="fu">exp</span>(eta)))</span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>devianceOld<span class="ot">&lt;-</span><span class="fl">1e30</span></span></code></pre></div>
</div>
<div id="run-update-step-until-convergence" class="section level3"
number="1.7.3">
<h3><span class="header-section-number">1.7.3</span> Run Update Step
until Convergence</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">plot</span>(betasTrue,<span class="at">ylab=</span><span class="fu">expression</span>(beta),<span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">4</span>),<span class="at">pch=</span><span class="dv">19</span>,<span class="at">type=</span><span class="st">&quot;b&quot;</span>)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="fu">lines</span>(betas,<span class="at">type=</span><span class="st">&quot;b&quot;</span>,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>tol<span class="ot">&lt;-</span><span class="fl">1e-6</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>iteration<span class="ot">=</span><span class="dv">0</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="cf">while</span>(((devianceOld<span class="sc">-</span>deviance)<span class="sc">/</span>devianceOld)<span class="sc">&gt;</span>tol)</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>{</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="co">#start IRLS UPDATE STEP</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>iteration<span class="ot">=</span>iteration<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a><span class="co">#calculate pseudo data based on current betas</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>z<span class="ot">=</span>eta<span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>eta)<span class="sc">*</span>(y<span class="sc">-</span><span class="fu">exp</span>(eta))</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="co">#calculate new weights: diagonal elements</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>w<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="fu">exp</span>(eta))</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="co">#update betas</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>lmUpdate<span class="ot">&lt;-</span><span class="fu">lm</span>(z<span class="sc">~-</span><span class="dv">1</span><span class="sc">+</span>xhlp,<span class="at">weight=</span>w)</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="co">#eta&lt;-xhlp%*%betas</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>eta<span class="ot">&lt;-</span>lmUpdate<span class="sc">$</span>fitted</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>betas<span class="ot">&lt;-</span>lmUpdate<span class="sc">$</span>coef</span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="fu">lines</span>(betas,<span class="at">type=</span><span class="st">&quot;b&quot;</span>,<span class="at">col=</span>iteration<span class="sc">+</span><span class="dv">1</span>,<span class="at">pch=</span>iteration,<span class="at">lty=</span><span class="dv">2</span>)</span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="co">#criterion for convergence</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>devianceOld<span class="ot">&lt;-</span>deviance</span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a>deviance<span class="ot">&lt;-</span><span class="dv">2</span><span class="sc">*</span><span class="fu">sum</span>(<span class="fu">ylogy</span>(y)<span class="sc">-</span>y<span class="sc">*</span>eta<span class="sc">-</span>(y<span class="sc">-</span><span class="fu">exp</span>(eta)))</span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;iteration&quot;</span>,iteration,<span class="st">&quot;Deviance Old&quot;</span>,devianceOld,<span class="st">&quot;Deviance&quot;</span>, deviance,<span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<pre><code>## iteration 1 Deviance Old 129.1127 Deviance 114.3748 
## iteration 2 Deviance Old 114.3748 Deviance 114.3374 
## iteration 3 Deviance Old 114.3374 Deviance 114.3374</code></pre>
</div>
<div id="variance-beta" class="section level3" number="1.7.4">
<h3><span class="header-section-number">1.7.4</span> Variance <span
class="math inline">\(\beta\)</span>?</h3>
<p><span
class="math display">\[\Sigma_{\beta}=\left(\mathbf{X}^T\mathbf{W}
\mathbf{X}\right)^{-1}\]</span></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>varBeta<span class="ot">=</span><span class="fu">solve</span>(<span class="fu">t</span>(xhlp)<span class="sc">%*%</span><span class="fu">diag</span>(w)<span class="sc">%*%</span>xhlp)</span></code></pre></div>
</div>
<div id="comparison-with-glm-fit" class="section level3" number="1.7.5">
<h3><span class="header-section-number">1.7.5</span> Comparison with GLM
fit</h3>
<p>Use -1 because intercept is already in xhlp</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>glmfit<span class="ot">=</span><span class="fu">glm</span>(y<span class="sc">~-</span><span class="dv">1</span><span class="sc">+</span>xhlp,<span class="at">family=</span>poisson)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>comp<span class="ot">=</span><span class="fu">data.frame</span>(<span class="at">glmfit=</span><span class="fu">c</span>(glmfit<span class="sc">$</span>deviance,glmfit<span class="sc">$</span>coef,<span class="fu">summary</span>(glmfit)<span class="sc">$</span>coef[,<span class="dv">2</span>]),<span class="at">ourFit=</span><span class="fu">c</span>(deviance,betas,<span class="fu">sqrt</span>(<span class="fu">diag</span>(varBeta))))</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="fu">row.names</span>(comp)<span class="ot">=</span><span class="fu">c</span>(<span class="st">&quot;deviance&quot;</span>,<span class="fu">paste</span>(<span class="st">&quot;beta&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>),<span class="fu">paste</span>(<span class="st">&quot;se&quot;</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="at">sep=</span><span class="st">&quot;&quot;</span>))</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>comp</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left"></th>
<th align="right">glmfit</th>
<th align="right">ourFit</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">deviance</td>
<td align="right">114.3373950</td>
<td align="right">114.3373950</td>
</tr>
<tr class="even">
<td align="left">beta1</td>
<td align="right">1.9680569</td>
<td align="right">1.9680569</td>
</tr>
<tr class="odd">
<td align="left">beta2</td>
<td align="right">0.7613664</td>
<td align="right">0.7613664</td>
</tr>
<tr class="even">
<td align="left">beta3</td>
<td align="right">1.2333003</td>
<td align="right">1.2333003</td>
</tr>
<tr class="odd">
<td align="left">se1</td>
<td align="right">0.0381438</td>
<td align="right">0.0381438</td>
</tr>
<tr class="even">
<td align="left">se2</td>
<td align="right">0.0189121</td>
<td align="right">0.0189120</td>
</tr>
<tr class="odd">
<td align="left">se3</td>
<td align="right">0.0255667</td>
<td align="right">0.0255666</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="hypothesis-testing-large-sample-theory" class="section level2"
number="1.8">
<h2><span class="header-section-number">1.8</span> Hypothesis testing:
Large sample theory</h2>
<div id="wald-test" class="section level3" number="1.8.1">
<h3><span class="header-section-number">1.8.1</span> Wald test</h3>
<ul>
<li>Follows immediately from the information matrix for generalized
linear models <span class="math display">\[I(\boldsymbol{\beta}) =
\mathbf{X}^T\mathbf{WX}\]</span></li>
</ul>
<p>so large sample distribution of the maximum likelihood estimator
<span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> is
multivariate normal <span class="math display">\[
\hat{\boldsymbol{\beta}} \sim
MVN\left[\boldsymbol{\beta},\left(\mathbf{X}^T\mathbf{WX}\right)^{-1}\right]
\]</span></p>
<p>We can perform a Wald Test for a single model parameter</p>
<p><span class="math display">\[
W = \frac{\hat\beta_m}{\hat{\text{se}}_{\hat\beta_m}} \approx
N(0,1)\vert H_0
\]</span> to test for</p>
<p><span class="math display">\[
H_0: \beta_p=0 \leftrightarrow H_1:\beta_p\neq0
\]</span></p>
<p>Again, we can also assess contrasts! Indeed, linear combinations of
model parameter estimators also follow a normal distribution.</p>
<p><span class="math display">\[
\mathbf{L}^T\hat{\boldsymbol{\beta}} \sim
N\left[\mathbf{L}^T\boldsymbol{\beta},\mathbf{L}^T\hat{\boldsymbol{\Sigma}}_{\hat{\boldsymbol{\beta}}}\mathbf{L}\right]
\]</span></p>
<p>With <span class="math inline">\(\mathbf{L}\)</span> a vector for a
single contrast.</p>
<p><span class="math display">\[
W =
\frac{\mathbf{L}^T\hat{\boldsymbol{\beta}}}{\hat{\text{se}}_{\mathbf{L}^T\hat{\boldsymbol{\beta}}}}
\approx N(0,1)\vert H_0
\]</span> testing for <span class="math display">\[
H_0: \mathbf{L}^T\boldsymbol{\beta}=0 \leftrightarrow
H_1:\mathbf{L}^T\boldsymbol{\beta}\neq0
\]</span></p>
<p>We can also test for multiple contrasts simultaneously, e.g. by
assuming that multiple model parameters are zero. Suppose that <span
class="math inline">\(\mathbf{L}\)</span> is the contrast matrix that
corresponds testing for <span class="math inline">\(c\)</span> model
parameters, simultaneously. Then</p>
<p><span class="math display">\[
\mathbf{L}^T\hat{\boldsymbol{\beta}} \sim
MVN\left[\mathbf{L}^T\boldsymbol{\beta},\mathbf{L}^T\hat{\boldsymbol{\Sigma}}_{\hat{\boldsymbol{\beta}}}\mathbf{L}\right]
\]</span></p>
<p>and</p>
<p><span class="math display">\[
W =
\mathbf{L}^T\hat{\boldsymbol{\beta}}\left(\mathbf{L}^T\hat{\boldsymbol{\Sigma}}_{\hat{\boldsymbol{\beta}}}\mathbf{L}\right)^{-1}\hat{\boldsymbol{\beta}}\mathbf{L}
\sim \chi^2_c\vert H_0
\]</span> to test for</p>
<p><span class="math display">\[
H_0: \mathbf{L}^T\boldsymbol{\beta}=\mathbf{0} \leftrightarrow
H_1:\mathbf{L}^T\boldsymbol{\beta}=\mathbf{0}\neq0
\]</span></p>
<p>In general, when we test for <span
class="math inline">\(c\geq1\)</span> contrasts, then the test statistic
<span class="math inline">\(W∼\chi^2_r|H_0\)</span>, with <span
class="math inline">\(r\)</span> the rank of the contrast matrix.</p>
</div>
<div id="likelihood-ratio-test" class="section level3" number="1.8.2">
<h3><span class="header-section-number">1.8.2</span> Likelihood ratio
test</h3>
<p>The likelihood ratio test (LRT) measures the discrepancy in
log-likelihood between our current model (sometimes also referred to as
full model) and a reduced model (sometimes also referred to as null or
alternative model).</p>
<p>The reduced model must be nested in (and therefore of lower dimension
as compared to) the full model.</p>
<p>While adding more covariates will always explain more variability in
our response variable, the LRT tests whether this is actually
significant.</p>
<p>For example, in the example of gene differential expression between
healthy versus tumoral tissue, the full model could be a GLM where the
mean is modeled according to an intercept and a tissue indicator
variable (healthy / tumor), while the alternative model could be a GLM
with just an intercept. Indeed, if the gene is similarly expressed
between healthy and tumor tissue, the log-likelihood of the alternative
model will decrease only a little as compared to the full model.</p>
<p>As the name suggests, the likelihood ratio test assesses whether the
ratio of the log-likelihoods provides sufficient evidence for a worse
fit of the alternative versus full model</p>
<p><span class="math display">\[
\lambda=2\left[l(\hat{\boldsymbol{\beta}}_\text{full})-2l(\hat{\boldsymbol{\beta}}_\text{0})\right]
\]</span></p>
<pre><code>Asymptotically, under the null hypothesis it can be shown that</code></pre>
<p><span class="math display">\[ L \sim \chi_c^2 | H_0, \]</span> with
<span class="math inline">\(c\)</span> the number of parameters dropped
in the alternative model versus the full model.</p>
<p>Let <span class="math inline">\(\mathbf{C}\)</span> denote the <span
class="math inline">\(c \times p\)</span> contrast matrix denoting the
contrast for the parameters being dropped, the null and alternative
hypothesis are as in the Wald test setting: <span
class="math display">\[ H_0: \mathbf{C} \beta = 0\]</span> <span
class="math display">\[ H_1: \mathbf{C} \beta \ne 0\]</span></p>
<ul>
<li>It is important to keep in mind that standard statistical inference
theory in GLMs works <strong>asymptotically in terms of the sample
size</strong>.</li>
</ul>
<p>Thus we need many data points in order for the theory to hold in
practice. In order for the <span class="math inline">\(p\)</span>-values
to be correct, our parametric (distributional) assumptions as well as
the independence assumption, must also hold.</p>
<ul>
<li>In bulk RNA-seq, we are often working with a limited number of
samples and so we typically do not expect asymptotic theory to hold yet.
In single-cell RNA-seq, we often perform several preprocessing steps
before calculating <span class="math inline">\(p\)</span>-values for
each gene and so we may be ‘using the data multiple times’. Rather than
attaching strong probabilistic interpretations to the <span
class="math inline">\(p\)</span>-values, we therefore advice to view the
<span class="math inline">\(p\)</span>-values simply as useful numerical
summaries for ranking the genes for further inspection in genomics
applications.</li>
</ul>
<p><img src="images_sequencing/likTests.png" width="425" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="edger" class="section level1" number="2">
<h1><span class="header-section-number">2</span> EdgeR</h1>
<p><a
href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3378882/">McCarthy
and Smyth, 2012</a></p>
<p><img src="figs/McCarthySmyth2012.png" width="2551" /></p>
<p><img src="figs/McCarthySmyth2012_testing.png" width="2551" /></p>
</div>
<div id="edger---quasi-likelihood" class="section level1" number="3">
<h1><span class="header-section-number">3</span> EdgeR -
Quasi-Likelihood</h1>
<p><a href="https://publications.wehi.edu.au/documentaspdf/256.pdf">Lund
et al. 2012</a></p>
<p>For quasi-likelihood we do not specify the full distribution, only
the first two moments: the mean and variance.</p>
<p><span class="math display">\[
\left\{
\begin{array}{lcl}
E[y_{ig}\vert \mathbf{x}_{ig}]&amp;=&amp;\mu_{ig}\\
log(\mu_{ig})&amp;=&amp;\eta_{ig}\\
\eta_{ig}&amp;=&amp; \mathbf{x}_{i}^T\boldsymbol{\beta}+ \log N_i\\
\text{Var}[y_{ig}\vert
\mathbf{x}_{ig}]&amp;=&amp;\sigma^2_g\left(\mu_{ig}+\phi\mu_{ig}^2\right)
\end{array}\right.
\]</span></p>
<p>We will look-up the details in the paper.</p>
</div>
<div id="limma---voom" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Limma - Voom</h1>
<p><a
href="https://genomebiology.biomedcentral.com/articles/10.1186/gb-2014-15-2-r29">Law
et al. (2013). Genome Biology</a></p>
<ul>
<li>Count models vs transformation: Poisson counts, <span
class="math inline">\(\sqrt(y)\)</span> stabilises the variance,
insufficient for negative binomial. Log transformation: the transformed
data are still heteroscedastic.<span
class="math inline">\(\rightarrow\)</span> limma-voom</li>
<li>Use normalized log-cpm Limma pipeline for sequencing</li>
</ul>
<p>Problem: counts have a mean variance relationship:
heteroscedastic</p>
<p>How do we deal with heteroscedasticity in traditional linear
models?</p>
<p>Two stage approach:</p>
<ol style="list-style-type: decimal">
<li>Stage I</li>
</ol>
<ul>
<li>OLS</li>
<li>Estimate variances at each data point</li>
<li>Use variances as weights: <span
class="math inline">\(W=\text{diag}[1/\hat\sigma_i^2]\)</span></li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>Stage II WLS <span
class="math inline">\(\text{argmin}_{\boldsymbol{\beta}} \{
(\mathbf{y}-\mathbf{X}\boldsymbol{\beta})^T\mathbf{W}
(\mathbf{y}-\mathbf{X}\boldsymbol{\beta})\}\)</span></li>
</ol>
<p>Port this idea to RNA-seq pipeline</p>
<p><img src="figs/limmaVoomPaperChunk1.png" width="2030" /></p>
<p><img src="figs/limmaVoomPaperChunk2.png" width="1983" /></p>
<p><img src="figs/limmaVoomPaperFig2.png" width="2040" /></p>
</div>
<div id="independent-filtering" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Independent
Filtering</h1>
<p>Independent filtering is a strategy to remove features (in this case,
genes) prior to the analysis. Removal of these features may lower the
multiple testing correction for other genes that pass the filter. We try
to remove genes that have a low power to be found statistically
significant, and/or that are biologically less relevant. A common
filtering strategy is to remove genes with a generally low expression,
as low counts have lower relative uncertainty (hence lower statistical
power), and may be considered biologically less relevant.</p>
<p>Implementation in edgeR.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>?filterByExpr</span></code></pre></div>
<pre><code>## No documentation for &#39;filterByExpr&#39; in specified packages and libraries</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>  <span class="fu">library</span>(limma)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  <span class="fu">library</span>(edgeR)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  <span class="fu">library</span>(DESeq2)</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>## Warning: multiple methods tables found for &#39;union&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;intersect&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;setdiff&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;setequal&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;IRanges&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;union&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;intersect&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;setdiff&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;GenomeInfoDb&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;intersect&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;GenomicRanges&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;XVector&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;union&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;intersect&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;setdiff&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;SummarizedExperiment&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;S4Arrays&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;DelayedArray&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;SparseArray&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;DESeq2&#39;</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>dds <span class="ot">&lt;-</span> <span class="fu">makeExampleDESeqDataSet</span>()</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>simCounts <span class="ot">&lt;-</span><span class="fu">counts</span>(dds)</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>group <span class="ot">&lt;-</span> dds<span class="sc">$</span>condition</span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>dge <span class="ot">&lt;-</span> edgeR<span class="sc">::</span><span class="fu">DGEList</span>(simCounts)</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a>design <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span>group)</span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a>keep <span class="ot">&lt;-</span> <span class="fu">filterByExpr</span>(dge, design)</span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a><span class="fu">table</span>(keep)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">FALSE</th>
<th align="right">TRUE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">373</td>
<td align="right">627</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>lib.size <span class="ot">&lt;-</span> dge<span class="sc">$</span>samples<span class="sc">$</span>lib.size <span class="sc">*</span> dge<span class="sc">$</span>samples<span class="sc">$</span>norm.factors</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>cpmMinCount <span class="ot">&lt;-</span> <span class="dv">10</span><span class="sc">/</span><span class="fu">median</span>(lib.size)<span class="sc">*</span><span class="fl">1e6</span></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="fu">summary</span>(group)</span></code></pre></div>
<pre><code>## A B 
## 6 6</code></pre>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>minSampSize <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">summary</span>(group))</span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>minSampSize</span></code></pre></div>
<pre><code>## [1] 6</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>keep <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">cpm</span>(dge) <span class="sc">&gt;</span> cpmMinCount) <span class="sc">&gt;=</span> minSampSize</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a><span class="fu">table</span>(keep)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">FALSE</th>
<th align="right">TRUE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">373</td>
<td align="right">627</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a>leverage <span class="ot">&lt;-</span> design<span class="sc">%*%</span> <span class="fu">solve</span>(<span class="fu">t</span>(design)<span class="sc">%*%</span>design)<span class="sc">%*%</span><span class="fu">t</span>(design) <span class="sc">%&gt;%</span><span class="fu">diag</span>()</span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a><span class="dv">1</span><span class="sc">/</span>leverage</span></code></pre></div>
<pre><code>##  1  2  3  4  5  6  7  8  9 10 11 12 
##  6  6  6  6  6  6  6  6  6  6  6  6</code></pre>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="fu">min</span>(<span class="dv">1</span><span class="sc">/</span>leverage)</span></code></pre></div>
<pre><code>## [1] 6</code></pre>
<p>Independent filtering has been formalized by <a
href="https://www.pnas.org/content/107/21/9546">Bourgon <em>et al.</em>
(2010)</a>.</p>
<div class="figure">
<img src="images_sequencing/independentFiltering.png" alt="Figure 1 from Bourgon *et al.* (2010)." width="1440" />
<p class="caption">
Figure 1 from Bourgon <em>et al.</em> (2010).
</p>
</div>
<hr />
<p>The concept of independent filtering can be summarized as
follows:</p>
<ul>
<li>For each feature we calculate two statistics, <span
class="math inline">\(S_F\)</span> and <span
class="math inline">\(S_T\)</span>, respectively used for two stages:
filtering and testing (e.g., differential expression).</li>
<li>In order for a feature to be deemed significant, both of its
statistics must be greater than some cut-off.</li>
<li>We want to control the type I error rate of the second stage
(testing). But note that <strong>the second stage is conditional on the
first stage</strong>, as we only test features passing the filter, and
basically ignore the fact that filtering was performed. Indeed, one
criticism is that computing and correcting the <span
class="math inline">\(p\)</span>-values as if filtering had not been
performed may lead to overoptimistic adjusted <span
class="math inline">\(p\)</span>-values.</li>
<li><a href="https://www.pnas.org/content/107/21/9546">Bourgon <em>et
al.</em> (2010)</a> show that filtering is only appropriate (i.e., does
not inflate type I error rate) if the conditional null distribution of
test statistics for features passing the filter is the same as the
unconditional null distribution. Therefore, <strong>filtering is
appropriate if the statistic used for filtering is independent of the
statistic used for testing under the null hypothesis</strong>.</li>
</ul>
<div class="figure" style="text-align: center">
<img src="images_sequencing/independentFiltering2.png" alt="Figure 2 from Bourgon *et al.* (2010)." width="1438" />
<p class="caption">
Figure 2 from Bourgon <em>et al.</em> (2010).
</p>
</div>
<hr />
<p>Let’s try a couple of examples to get some intuition using simulated
data.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(DESeq2))</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">24</span>)</span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a>dds <span class="ot">&lt;-</span> DESeq2<span class="sc">::</span><span class="fu">makeExampleDESeqDataSet</span>()</span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a>simCounts <span class="ot">&lt;-</span> <span class="fu">counts</span>(dds)</span>
<span id="cb57-5"><a href="#cb57-5" tabindex="-1"></a>group <span class="ot">&lt;-</span> dds<span class="sc">$</span>condition</span></code></pre></div>
<div id="a-dependent-test-statistic" class="section level2"
number="5.1">
<h2><span class="header-section-number">5.1</span> A Dependent Test
Statistic</h2>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a>filterStatEffectSize <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">rowMeans</span>(simCounts[,group <span class="sc">==</span> <span class="st">&quot;A&quot;</span>]) <span class="sc">-</span> <span class="fu">rowMeans</span>(simCounts[,group <span class="sc">==</span> <span class="st">&quot;B&quot;</span>]))</span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a>testStat <span class="ot">&lt;-</span> genefilter<span class="sc">::</span><span class="fu">rowttests</span>(simCounts, group)</span></code></pre></div>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;AnnotationDbi&#39;</code></pre>
<pre><code>## Warning: replacing previous import &#39;BiocGenerics::setequal&#39; by
## &#39;S4Vectors::setequal&#39; when loading &#39;Biostrings&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;union&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;intersect&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;setdiff&#39;</code></pre>
<pre><code>## Warning: multiple methods tables found for &#39;setequal&#39;</code></pre>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a><span class="do">## unconditional distribution</span></span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(testStat<span class="sc">$</span>statistic, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Test statistic&quot;</span>,</span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Unconditional distribution&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a><span class="do">## conditional distribution: very different!</span></span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a><span class="fu">mean</span>(filterStatEffectSize <span class="sc">&gt;</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 0.792</code></pre>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a><span class="fu">hist</span>(filterStatEffectSize, <span class="at">breaks=</span><span class="dv">40</span>)</span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v=</span><span class="dv">1</span>, <span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-28-2.png" width="672" /></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>keepEffectSize <span class="ot">&lt;-</span> filterStatEffectSize <span class="sc">&gt;</span> <span class="dv">1</span></span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(testStat<span class="sc">$</span>statistic[keepEffectSize], <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb69-3"><a href="#cb69-3" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Test statistic&quot;</span>,</span>
<span id="cb69-4"><a href="#cb69-4" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Conditional distribution&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-28-3.png" width="672" /></p>
</div>
<div id="an-independent-test-statistic" class="section level2"
number="5.2">
<h2><span class="header-section-number">5.2</span> An Independent Test
Statistic</h2>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>filterStatGlobalMean <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(simCounts)</span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a><span class="fu">mean</span>(filterStatGlobalMean <span class="sc">&gt;</span> <span class="dv">5</span>) <span class="co"># we remove a similar fraction</span></span></code></pre></div>
<pre><code>## [1] 0.771</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a>keepGlobalMean <span class="ot">&lt;-</span> filterStatGlobalMean <span class="sc">&gt;</span> <span class="dv">5</span></span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a><span class="do">## unconditional distribution</span></span>
<span id="cb72-4"><a href="#cb72-4" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(testStat<span class="sc">$</span>statistic, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb72-5"><a href="#cb72-5" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Test statistic&quot;</span>,</span>
<span id="cb72-6"><a href="#cb72-6" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Unconditional distribution&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="do">## conditional distribution: the same.</span></span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(testStat<span class="sc">$</span>statistic[keepGlobalMean], <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Test statistic&quot;</span>,</span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">&quot;Conditional distribution&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-29-2.png" width="672" /></p>
</div>
</div>
<div id="normalization" class="section level1" number="6">
<h1><span class="header-section-number">6</span> Normalization</h1>
<p>Normalization is necessary to correct for several sources of
technical variation:</p>
<ul>
<li><strong>Differences in sequencing depth</strong> between samples.
Some samples get sequenced deeper in the sense that they consist of more
(mapped) reads and therefore can be considered to contain a higher
amount of information, which we should be taking into account. In
addition, if a sample is sequenced deeper, it is natural that the counts
for each gene will be higher, jeopardizing a direct comparison of the
expression counts.</li>
<li><strong>Differences in RNA population composition</strong> between
samples. As an extreme example, suppose that two samples have been
sequenced to the exact same depth. One sample is contaminated and has a
very high concentration of the contaminant cDNA being sequenced, but
otherwise the two samples are identical. Since the contaminant will be
taking up a significant proportion of the reads being sequenced, the
counts will not be directly comparable between the samples. Hence, we
may also want to correct for differences in the composition of the RNA
population of the samples.</li>
<li><strong>Other technical variation</strong> such as sample-specific
GC-content or transcript length effects may also be accounted for.</li>
</ul>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;parathyroidGenesSE&quot;</span>, <span class="at">package=</span><span class="st">&quot;parathyroidSE&quot;</span>)</span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a>se1 <span class="ot">&lt;-</span> parathyroidGenesSE</span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a><span class="fu">rm</span>(parathyroidGenesSE)</span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" tabindex="-1"></a><span class="fu">colData</span>(se1) <span class="sc">%&gt;%</span> </span>
<span id="cb74-6"><a href="#cb74-6" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb74-7"><a href="#cb74-7" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">duplicated</span>(experiment)) </span></code></pre></div>
<table>
<colgroup>
<col width="13%" />
<col width="14%" />
<col width="10%" />
<col width="13%" />
<col width="6%" />
<col width="14%" />
<col width="13%" />
<col width="13%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">run</th>
<th align="left">experiment</th>
<th align="left">patient</th>
<th align="left">treatment</th>
<th align="left">time</th>
<th align="left">submission</th>
<th align="left">study</th>
<th align="left">sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">SRR479061</td>
<td align="left">SRX140511</td>
<td align="left">2</td>
<td align="left">DPN</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308873</td>
</tr>
<tr class="even">
<td align="left">SRR479064</td>
<td align="left">SRX140513</td>
<td align="left">2</td>
<td align="left">OHT</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308875</td>
</tr>
<tr class="odd">
<td align="left">SRR479075</td>
<td align="left">SRX140523</td>
<td align="left">4</td>
<td align="left">DPN</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308885</td>
</tr>
<tr class="even">
<td align="left">SRR479078</td>
<td align="left">SRX140525</td>
<td align="left">4</td>
<td align="left">OHT</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308887</td>
</tr>
</tbody>
</table>
<p>There are technical repeats in the data.</p>
<p>We mentioned previous lectures that we can sum over technical
repeats, because techical repeats are Poisson and the sum of two Poisson
variables is again Poisson.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a>dupExps <span class="ot">&lt;-</span> <span class="fu">colData</span>(se1) <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">duplicated</span>(experiment))  <span class="sc">%&gt;%</span> </span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a>  <span class="fu">pull</span>(experiment)</span>
<span id="cb75-5"><a href="#cb75-5" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">assays</span>(se1)<span class="sc">$</span>counts</span>
<span id="cb75-7"><a href="#cb75-7" tabindex="-1"></a>newCounts <span class="ot">&lt;-</span> counts</span>
<span id="cb75-8"><a href="#cb75-8" tabindex="-1"></a>cd <span class="ot">&lt;-</span> <span class="fu">colData</span>(se1)</span>
<span id="cb75-9"><a href="#cb75-9" tabindex="-1"></a><span class="cf">for</span>(ss <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(dupExps)){</span>
<span id="cb75-10"><a href="#cb75-10" tabindex="-1"></a>  <span class="co"># check which samples are duplicates</span></span>
<span id="cb75-11"><a href="#cb75-11" tabindex="-1"></a>  relevantId <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colData</span>(se1)<span class="sc">$</span>experiment <span class="sc">==</span> dupExps[ss])</span>
<span id="cb75-12"><a href="#cb75-12" tabindex="-1"></a>  <span class="co"># sum counts</span></span>
<span id="cb75-13"><a href="#cb75-13" tabindex="-1"></a>  newCounts[,relevantId[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(counts[,relevantId])</span>
<span id="cb75-14"><a href="#cb75-14" tabindex="-1"></a>  <span class="co"># keep which columns / rows to remove.</span></span>
<span id="cb75-15"><a href="#cb75-15" tabindex="-1"></a>  <span class="cf">if</span>(ss <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb75-16"><a href="#cb75-16" tabindex="-1"></a>    toRemove <span class="ot">&lt;-</span> relevantId[<span class="dv">2</span>]</span>
<span id="cb75-17"><a href="#cb75-17" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb75-18"><a href="#cb75-18" tabindex="-1"></a>    toRemove <span class="ot">&lt;-</span> <span class="fu">c</span>(toRemove, relevantId[<span class="dv">2</span>])</span>
<span id="cb75-19"><a href="#cb75-19" tabindex="-1"></a>  }</span>
<span id="cb75-20"><a href="#cb75-20" tabindex="-1"></a>}</span>
<span id="cb75-21"><a href="#cb75-21" tabindex="-1"></a></span>
<span id="cb75-22"><a href="#cb75-22" tabindex="-1"></a><span class="co"># remove after summing counts (otherwise IDs get mixed up)</span></span>
<span id="cb75-23"><a href="#cb75-23" tabindex="-1"></a>newCounts <span class="ot">&lt;-</span> newCounts[,<span class="sc">-</span>toRemove]</span>
<span id="cb75-24"><a href="#cb75-24" tabindex="-1"></a>newCD <span class="ot">&lt;-</span> cd[<span class="sc">-</span>toRemove,]</span>
<span id="cb75-25"><a href="#cb75-25" tabindex="-1"></a></span>
<span id="cb75-26"><a href="#cb75-26" tabindex="-1"></a><span class="co"># Create new SummarizedExperiment</span></span>
<span id="cb75-27"><a href="#cb75-27" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">SummarizedExperiment</span>(<span class="at">assays =</span> <span class="fu">list</span>(<span class="st">&quot;counts&quot;</span> <span class="ot">=</span> newCounts),</span>
<span id="cb75-28"><a href="#cb75-28" tabindex="-1"></a>                            <span class="at">colData =</span> newCD,</span>
<span id="cb75-29"><a href="#cb75-29" tabindex="-1"></a>                            <span class="at">metadata =</span> <span class="fu">metadata</span>(se1))</span>
<span id="cb75-30"><a href="#cb75-30" tabindex="-1"></a></span>
<span id="cb75-31"><a href="#cb75-31" tabindex="-1"></a>treatment <span class="ot">&lt;-</span> <span class="fu">colData</span>(se)<span class="sc">$</span>treatment</span>
<span id="cb75-32"><a href="#cb75-32" tabindex="-1"></a><span class="fu">table</span>(treatment)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="right">Control</th>
<th align="right">DPN</th>
<th align="right">OHT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">7</td>
<td align="right">8</td>
<td align="right">8</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="fu">qplot</span>(<span class="fu">colSums</span>(<span class="fu">assays</span>(se)<span class="sc">$</span>counts)<span class="sc">/</span><span class="fl">1e6</span>, <span class="at">geom=</span><span class="st">&quot;histogram&quot;</span>, <span class="at">bins=</span><span class="dv">10</span>,<span class="at">col=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span></span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;libsize (million reads)&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="fu">qplot</span>(</span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a>  <span class="fu">colData</span>(se)<span class="sc">$</span>treatment<span class="sc">:</span><span class="fu">colData</span>(se)<span class="sc">$</span>time,</span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a>  <span class="fu">colSums</span>(<span class="fu">assays</span>(se)<span class="sc">$</span>counts)<span class="sc">/</span><span class="fl">1e6</span>,<span class="at">geom=</span><span class="st">&quot;boxplot&quot;</span></span>
<span id="cb77-4"><a href="#cb77-4" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-5"><a href="#cb77-5" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;treatment&quot;</span>)<span class="sc">+</span></span>
<span id="cb77-6"><a href="#cb77-6" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;libsize (million reads)&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-32-2.png" width="672" /></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a><span class="fu">qplot</span>(</span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>  <span class="fu">colData</span>(se)<span class="sc">$</span>patient,</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a>  <span class="fu">colSums</span>(<span class="fu">assays</span>(se)<span class="sc">$</span>counts)<span class="sc">/</span><span class="fl">1e6</span>,<span class="at">geom=</span><span class="st">&quot;boxplot&quot;</span></span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Patient&quot;</span>)<span class="sc">+</span></span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;libsize (million reads)&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-32-3.png" width="672" /></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a>ma2Samp <span class="ot">&lt;-</span> <span class="cf">function</span>(countMx,<span class="at">libSize=</span><span class="cn">NULL</span>) {</span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="st">&quot;`countMx` is not a matrix with two columns&quot;</span> <span class="ot">=</span> <span class="fu">ncol</span>(countMx) <span class="sc">==</span> <span class="dv">2</span>)</span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a>A <span class="ot">&lt;-</span> countMx <span class="sc">%&gt;%</span> log2 <span class="sc">%&gt;%</span> rowMeans</span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">is.null</span>(libSize)) </span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a>  M <span class="ot">&lt;-</span> countMx <span class="sc">%&gt;%</span> log2 <span class="sc">%&gt;%</span> <span class="fu">apply</span>(.,<span class="dv">1</span>,diff) </span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a><span class="cf">else</span> </span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a>  M <span class="ot">&lt;-</span> countMx <span class="sc">%&gt;%</span> log2 <span class="sc">%&gt;%</span> <span class="fu">apply</span>(.,<span class="dv">1</span>,diff) <span class="sc">-</span> libSize <span class="sc">%&gt;%</span> log2 <span class="sc">%&gt;%</span> diff</span>
<span id="cb79-8"><a href="#cb79-8" tabindex="-1"></a>w <span class="ot">&lt;-</span> countMx[,<span class="dv">1</span>]<span class="sc">==</span><span class="fu">min</span>(countMx[,<span class="dv">1</span>]) <span class="sc">|</span> countMx[,<span class="dv">2</span>]<span class="sc">==</span><span class="fu">min</span>(countMx[,<span class="dv">2</span>])</span>
<span id="cb79-9"><a href="#cb79-9" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(w)) {</span>
<span id="cb79-10"><a href="#cb79-10" tabindex="-1"></a>            A[w] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">sum</span>(w), <span class="at">min =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">max =</span> .<span class="dv">1</span>)</span>
<span id="cb79-11"><a href="#cb79-11" tabindex="-1"></a>            M[w] <span class="ot">&lt;-</span> <span class="fu">log2</span>(countMx[w,<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">log2</span>(countMx[w,<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb79-12"><a href="#cb79-12" tabindex="-1"></a>}</span>
<span id="cb79-13"><a href="#cb79-13" tabindex="-1"></a>MAplot <span class="ot">&lt;-</span> <span class="fu">qplot</span>(A, M, <span class="at">col=</span>w) <span class="sc">+</span></span>
<span id="cb79-14"><a href="#cb79-14" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;none&quot;</span>) <span class="sc">+</span> </span>
<span id="cb79-15"><a href="#cb79-15" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;black&quot;</span>,<span class="st">&quot;orange&quot;</span>)) <span class="sc">+</span></span>
<span id="cb79-16"><a href="#cb79-16" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;A: log2 Average&quot;</span>) <span class="sc">+</span></span>
<span id="cb79-17"><a href="#cb79-17" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;M: log2 Fold Change&quot;</span>)</span>
<span id="cb79-18"><a href="#cb79-18" tabindex="-1"></a></span>
<span id="cb79-19"><a href="#cb79-19" tabindex="-1"></a>MAplot <span class="sc">+</span></span>
<span id="cb79-20"><a href="#cb79-20" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept=</span><span class="dv">0</span>,<span class="at">slope=</span><span class="dv">0</span>,<span class="at">col=</span><span class="st">&quot;blue&quot;</span>) <span class="sc">+</span></span>
<span id="cb79-21"><a href="#cb79-21" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept=</span><span class="fu">median</span>(M[<span class="sc">!</span>w],<span class="at">na.rm=</span><span class="cn">TRUE</span>),<span class="at">slope=</span><span class="dv">0</span>,<span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span>
<span id="cb79-22"><a href="#cb79-22" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s take a look at how comparable different replicates are in the
Control condition at 48h in our dataset. We will investigate this using
MD-plots (mean-difference plots as introduced by Dudoit et al. (2002)),
also sometimes referred to as MA-plots.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colData</span>(se)<span class="sc">$</span>treatment <span class="sc">==</span><span class="st">&quot;Control&quot;</span> <span class="sc">&amp;</span> <span class="fu">colData</span>(se)<span class="sc">$</span>time <span class="sc">==</span> <span class="st">&quot;48h&quot;</span>)</span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a>ids</span></code></pre></div>
<pre><code>## [1]  2  8 14 19</code></pre>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a><span class="fu">colSums</span>(<span class="fu">assays</span>(se)<span class="sc">$</span>counts[,ids]) <span class="sc">/</span> <span class="fl">1e6</span></span></code></pre></div>
<pre><code>## [1] 10.827109  6.844144  8.064268  7.701432</code></pre>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a>pairComb <span class="ot">&lt;-</span> <span class="fu">combn</span>(</span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a>  ids, </span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a>  <span class="at">m=</span><span class="dv">2</span>)</span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">apply</span>(pairComb,<span class="dv">2</span>,<span class="cf">function</span>(x) <span class="fu">ma2Samp</span>(<span class="fu">assay</span>(se)[,x]) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">&quot;samples&quot;</span>,x[<span class="dv">2</span>],<span class="st">&quot;vs&quot;</span>, x[<span class="dv">1</span>])))</span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a><span class="fu">do.call</span>(<span class="st">&quot;grid.arrange&quot;</span>,<span class="fu">c</span>(plots,<span class="at">ncol=</span><span class="dv">3</span>))</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
<p>We see clear bias for some pairwise comparisons. For example, in the
first plot comparing sample 8 versus sample 2, the log fold-changes are
biased downwards. This means that, on average, a gene is lower expressed
in sample 8 versus sample 2. Looking at the library sizes, we can indeed
see that the library size for sample 2 is about <span
class="math inline">\(11×10^6\)</span> while it is only about <span
class="math inline">\(7×10^6\)</span> for sample 8! This is a clear
library size effect that we should take into account.</p>
<p>We can solve these issues by introducing offsets in our model.</p>
<p><span class="math display">\[
  \left\{
  \begin{array}{ccc}
  Y_{gi} &amp; \sim &amp; Poi(\mu_{gi}) \\
  \log \mu_{gi} &amp; = &amp; \eta_{gi} \\
  \eta_{gi} &amp; = &amp; \mathbf{X}^T_i \beta_g + log(O_{gi}) \\
  \end{array}
  \right.
  \]</span></p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a>libSize <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">assay</span>(se))</span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a>plots2 <span class="ot">&lt;-</span> <span class="fu">apply</span>(pairComb,<span class="dv">2</span>,<span class="cf">function</span>(x) <span class="fu">ma2Samp</span>(<span class="fu">assay</span>(se)[,x],<span class="at">libSize =</span> libSize[x]) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">&quot;samples&quot;</span>,x[<span class="dv">2</span>],<span class="st">&quot;vs&quot;</span>, x[<span class="dv">1</span>])))</span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a><span class="fu">do.call</span>(<span class="st">&quot;grid.arrange&quot;</span>,<span class="fu">c</span>(plots2,<span class="at">ncol=</span><span class="dv">3</span>))</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-36-1.png" width="672" /></p>
<div id="tmm-method-default-of-edger" class="section level2"
number="6.1">
<h2><span class="header-section-number">6.1</span> TMM method (default
of <code>edgeR</code>)</h2>
<p><a
href="https://genomebiology.biomedcentral.com/articles/10.1186/gb-2010-11-3-r25">Robinson
and Oshlack (2010). Genome Biology</a></p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">&quot;./figs/edgeRNormIntro.png&quot;</span>)</span></code></pre></div>
<p><img src="figs/edgeRNormIntro.png" width="511" style="display: block; margin: auto;" /></p>
<ul>
<li>On the plot we see a clear effect on all genes</li>
<li>Correcting for library size tends to over correct.</li>
<li>Some DE genes are highly abundant and determine the library size to
a large extend</li>
</ul>
<p>The trimmed mean of M-values (TMM) method introduced by <a
href="https://genomebiology.biomedcentral.com/articles/10.1186/gb-2010-11-3-r25">Robinson
&amp; Oshlack (2010)</a> is a normalization procedure that calculates a
single normalization factor for each sample. As the name suggests, it is
based on a trimmed mean of fold-changes (<span
class="math inline">\(M\)</span>-values) as the scaling factor. A
trimmed mean is an average after removing a set of ``extreme’’ values.
Specifically, TMM calculates a normalization factor <span
class="math inline">\(F_i^{(r)}\)</span> across genes <span
class="math inline">\(g\)</span> for each sample <span
class="math inline">\(i\)</span> as compared to a reference sample <span
class="math inline">\(r\)</span>, <span class="math display">\[
\log_2(F_i^{(r)}) = \frac{\sum_{g \in {\cal G}^*} w_{gi}^r
M_{gi}^r}{\sum_{g \in {\cal G}^*} w_{gi}^r},
\]</span> where <span class="math inline">\(M_{gi}^r\)</span> represents
the <span class="math inline">\(\log_2\)</span>-fold-change of the gene
expression fraction as compared to a reference sample <span
class="math inline">\(r\)</span>, i.e., <span class="math display">\[
M_{gi}^r = \log_2\left( \frac{Y_{gi} / N_i}{ Y_{gr} / N_r} \right),
\]</span> and <span class="math inline">\(w_{gi}^r\)</span> represents a
precision weight calculated as <span class="math display">\[
w_{gi}^r = \frac{N_i - Y_{gi}}{N_i Y_{gi}} + \frac{N_r - Y_{gr}}{N_r
Y_{gr}},
\]</span> and <span class="math inline">\({\cal G}^*\)</span> represents
the set of genes after trimming those with the most extreme average
expression. The weights serve to account for the fact that fold-changes
for genes with lower read counts are more variable.</p>
<p>The procedure only takes genes into account where both <span
class="math inline">\(Y_{gi}&gt;0\)</span> and <span
class="math inline">\(Y_{gr}&gt;0\)</span>. By default, TMM trims genes
with the <span class="math inline">\(30\%\)</span> most extreme <span
class="math inline">\(M\)</span>-values and <span
class="math inline">\(5\%\)</span> most extreme average gene expression,
and chooses as reference <span class="math inline">\(r\)</span> the
sample whose upper-quartile is closest to the across-sample average
upper-quartile. The normalized counts are then given by <span
class="math inline">\(\tilde{Y}_{gi} = Y_{gi} / N_i^s\)</span>, where
<span class="math display">\[N_i^s = \frac{N_i F_i^{(r)}}{\sum_{i=1}^n
N_i F_i^{(r)}/n}.\]</span></p>
<p>TMM normalization may be performed from the
<code>calcNormFactors</code> function implemented in
<code>edgeR</code>:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a>dge <span class="ot">&lt;-</span> edgeR<span class="sc">::</span><span class="fu">calcNormFactors</span>(se)</span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a>dge<span class="sc">$</span>samples <span class="co">#normalization factors added to colData</span></span></code></pre></div>
<table>
<colgroup>
<col width="8%" />
<col width="5%" />
<col width="8%" />
<col width="11%" />
<col width="8%" />
<col width="9%" />
<col width="7%" />
<col width="8%" />
<col width="4%" />
<col width="9%" />
<col width="8%" />
<col width="8%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">group</th>
<th align="right">lib.size</th>
<th align="right">norm.factors</th>
<th align="left">run</th>
<th align="left">experiment</th>
<th align="left">patient</th>
<th align="left">treatment</th>
<th align="left">time</th>
<th align="left">submission</th>
<th align="left">study</th>
<th align="left">sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Sample1</td>
<td align="left">1</td>
<td align="right">9102683</td>
<td align="right">0.9782830</td>
<td align="left">SRR479052</td>
<td align="left">SRX140503</td>
<td align="left">1</td>
<td align="left">Control</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308865</td>
</tr>
<tr class="even">
<td align="left">Sample2</td>
<td align="left">1</td>
<td align="right">10827109</td>
<td align="right">0.9728700</td>
<td align="left">SRR479053</td>
<td align="left">SRX140504</td>
<td align="left">1</td>
<td align="left">Control</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308866</td>
</tr>
<tr class="odd">
<td align="left">Sample3</td>
<td align="left">1</td>
<td align="right">5217761</td>
<td align="right">0.9898593</td>
<td align="left">SRR479054</td>
<td align="left">SRX140505</td>
<td align="left">1</td>
<td align="left">DPN</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308867</td>
</tr>
<tr class="even">
<td align="left">Sample4</td>
<td align="left">1</td>
<td align="right">9706035</td>
<td align="right">0.9930169</td>
<td align="left">SRR479055</td>
<td align="left">SRX140506</td>
<td align="left">1</td>
<td align="left">DPN</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308868</td>
</tr>
<tr class="odd">
<td align="left">Sample5</td>
<td align="left">1</td>
<td align="right">5700022</td>
<td align="right">0.9850867</td>
<td align="left">SRR479056</td>
<td align="left">SRX140507</td>
<td align="left">1</td>
<td align="left">OHT</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308869</td>
</tr>
<tr class="even">
<td align="left">Sample6</td>
<td align="left">1</td>
<td align="right">7854568</td>
<td align="right">0.9897270</td>
<td align="left">SRR479057</td>
<td align="left">SRX140508</td>
<td align="left">1</td>
<td align="left">OHT</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308870</td>
</tr>
<tr class="odd">
<td align="left">Sample7</td>
<td align="left">1</td>
<td align="right">8610014</td>
<td align="right">0.9266581</td>
<td align="left">SRR479058</td>
<td align="left">SRX140509</td>
<td align="left">2</td>
<td align="left">Control</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308871</td>
</tr>
<tr class="even">
<td align="left">Sample8</td>
<td align="left">1</td>
<td align="right">6844144</td>
<td align="right">0.9544240</td>
<td align="left">SRR479059</td>
<td align="left">SRX140510</td>
<td align="left">2</td>
<td align="left">Control</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308872</td>
</tr>
<tr class="odd">
<td align="left">Sample9</td>
<td align="left">1</td>
<td align="right">24584280</td>
<td align="right">0.9188545</td>
<td align="left">SRR479060</td>
<td align="left">SRX140511</td>
<td align="left">2</td>
<td align="left">DPN</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308873</td>
</tr>
<tr class="even">
<td align="left">Sample10</td>
<td align="left">1</td>
<td align="right">8267977</td>
<td align="right">0.9398000</td>
<td align="left">SRR479062</td>
<td align="left">SRX140512</td>
<td align="left">2</td>
<td align="left">DPN</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308874</td>
</tr>
<tr class="odd">
<td align="left">Sample11</td>
<td align="left">1</td>
<td align="right">23590411</td>
<td align="right">0.9096695</td>
<td align="left">SRR479063</td>
<td align="left">SRX140513</td>
<td align="left">2</td>
<td align="left">OHT</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308875</td>
</tr>
<tr class="even">
<td align="left">Sample12</td>
<td align="left">1</td>
<td align="right">8247122</td>
<td align="right">0.9369050</td>
<td align="left">SRR479065</td>
<td align="left">SRX140514</td>
<td align="left">2</td>
<td align="left">OHT</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308876</td>
</tr>
<tr class="odd">
<td align="left">Sample13</td>
<td align="left">1</td>
<td align="right">7341000</td>
<td align="right">1.0668032</td>
<td align="left">SRR479066</td>
<td align="left">SRX140515</td>
<td align="left">3</td>
<td align="left">Control</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308877</td>
</tr>
<tr class="even">
<td align="left">Sample14</td>
<td align="left">1</td>
<td align="right">8064268</td>
<td align="right">1.0552688</td>
<td align="left">SRR479067</td>
<td align="left">SRX140516</td>
<td align="left">3</td>
<td align="left">Control</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308878</td>
</tr>
<tr class="odd">
<td align="left">Sample15</td>
<td align="left">1</td>
<td align="right">12481958</td>
<td align="right">1.0461698</td>
<td align="left">SRR479068</td>
<td align="left">SRX140517</td>
<td align="left">3</td>
<td align="left">DPN</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308879</td>
</tr>
<tr class="even">
<td align="left">Sample16</td>
<td align="left">1</td>
<td align="right">16310090</td>
<td align="right">1.0260056</td>
<td align="left">SRR479069</td>
<td align="left">SRX140518</td>
<td align="left">3</td>
<td align="left">DPN</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308880</td>
</tr>
<tr class="odd">
<td align="left">Sample17</td>
<td align="left">1</td>
<td align="right">23697329</td>
<td align="right">1.0268459</td>
<td align="left">SRR479070</td>
<td align="left">SRX140519</td>
<td align="left">3</td>
<td align="left">OHT</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308881</td>
</tr>
<tr class="even">
<td align="left">Sample18</td>
<td align="left">1</td>
<td align="right">7642648</td>
<td align="right">1.0409451</td>
<td align="left">SRR479071</td>
<td align="left">SRX140520</td>
<td align="left">3</td>
<td align="left">OHT</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308882</td>
</tr>
<tr class="odd">
<td align="left">Sample19</td>
<td align="left">1</td>
<td align="right">7701432</td>
<td align="right">1.0559132</td>
<td align="left">SRR479072</td>
<td align="left">SRX140521</td>
<td align="left">4</td>
<td align="left">Control</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308883</td>
</tr>
<tr class="even">
<td align="left">Sample20</td>
<td align="left">1</td>
<td align="right">7135899</td>
<td align="right">1.0675040</td>
<td align="left">SRR479073</td>
<td align="left">SRX140522</td>
<td align="left">4</td>
<td align="left">DPN</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308884</td>
</tr>
<tr class="odd">
<td align="left">Sample21</td>
<td align="left">1</td>
<td align="right">13818393</td>
<td align="right">1.0327004</td>
<td align="left">SRR479074</td>
<td align="left">SRX140523</td>
<td align="left">4</td>
<td align="left">DPN</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308885</td>
</tr>
<tr class="even">
<td align="left">Sample22</td>
<td align="left">1</td>
<td align="right">6099942</td>
<td align="right">1.0890994</td>
<td align="left">SRR479076</td>
<td align="left">SRX140524</td>
<td align="left">4</td>
<td align="left">OHT</td>
<td align="left">24h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308886</td>
</tr>
<tr class="odd">
<td align="left">Sample23</td>
<td align="left">1</td>
<td align="right">15825211</td>
<td align="right">1.0286470</td>
<td align="left">SRR479077</td>
<td align="left">SRX140525</td>
<td align="left">4</td>
<td align="left">OHT</td>
<td align="left">48h</td>
<td align="left">SRA051611</td>
<td align="left">SRP012167</td>
<td align="left">SRS308887</td>
</tr>
</tbody>
</table>
<p>Let’s check how our MD-plots look like after normalization. Note
that, we can rewrite the GLM as <span class="math display">\[ \log\left(
\frac{\mu_{gi}}{N_i^s} \right) = \mathbf{X}_i^T \beta_g \]</span> and so
<span class="math inline">\(\frac{\mu_{gi}}{N_i^s}\)</span> can be
considered as an ‘offset-corrected count’.</p>
<p>We see that all MD-plots are now nicely centered around a
log-fold-change of zero!</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a><span class="do">## normalize</span></span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a>effLibSize <span class="ot">&lt;-</span> dge<span class="sc">$</span>samples<span class="sc">$</span>lib.size <span class="sc">*</span> dge<span class="sc">$</span>samples<span class="sc">$</span>norm.factors</span>
<span id="cb88-3"><a href="#cb88-3" tabindex="-1"></a><span class="co">#normCountTMM &lt;- sweep(assays(se)$counts, 2, FUN=&quot;/&quot;, effLibSize)</span></span>
<span id="cb88-4"><a href="#cb88-4" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" tabindex="-1"></a>plotsNorm <span class="ot">&lt;-</span> <span class="fu">apply</span>(pairComb,<span class="dv">2</span>,<span class="cf">function</span>(x) </span>
<span id="cb88-6"><a href="#cb88-6" tabindex="-1"></a>  <span class="fu">ma2Samp</span>(<span class="fu">assays</span>(se)<span class="sc">$</span>counts[,x], effLibSize[x]) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">&quot;samples&quot;</span>,x[<span class="dv">2</span>],<span class="st">&quot;vs&quot;</span>, x[<span class="dv">1</span>])))</span>
<span id="cb88-7"><a href="#cb88-7" tabindex="-1"></a><span class="fu">do.call</span>(<span class="st">&quot;grid.arrange&quot;</span>,<span class="fu">c</span>(plotsNorm,<span class="at">ncol=</span><span class="dv">3</span>))</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
</div>
<div id="median-of-ratios-method-default-of-deseq2"
class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Median-of-Ratios
Method (default of <code>DESeq2</code>)</h2>
<p>The median-of-ratios method is used in <code>DESeq2</code> as
described in <a
href="https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0550-8">Love
<em>et al.</em> (2014)</a>. It assumes that the expected value <span
class="math inline">\(\mu_{gi} = E(Y_{gi})\)</span> is proportional to
the true expression of the gene, <span
class="math inline">\(q_{gi}\)</span>, scaled by a normalization factor
<span class="math inline">\(s_{i}\)</span> for each sample, <span
class="math display">\[ \mu_{gi} = s_{i}q_{gi}. \]</span></p>
<p>The normalization factor <span class="math inline">\(s_{i}\)</span>
is then estimated using the median-of-ratios method compared to a
synthetic reference sample <span class="math inline">\(r\)</span>
defined based on geometric means of counts across samples <span
class="math display">\[
s_i = \text{median}_{\{{g:Y^{*}_{gr} \ne 0}\}}
\frac{Y_{gi}}{Y^{*}_{gr}},
\]</span> with <span class="math display">\[ Y^{*}_{gr} = \left(
\prod_{i=1}^n Y_{gi} \right)^{1/n}. \]</span></p>
<p>We can then use the size factors <span
class="math inline">\(s_i\)</span> as offsets to the GLM.</p>
<p>Median-of-ratios normalization is implemented in the
<code>DESeq2</code> package:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a>dds <span class="ot">&lt;-</span> DESeq2<span class="sc">::</span><span class="fu">DESeqDataSetFromMatrix</span>(<span class="at">countData =</span> <span class="fu">assays</span>(se)<span class="sc">$</span>counts,</span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a>                                      <span class="at">colData =</span> <span class="fu">colData</span>(se),</span>
<span id="cb89-3"><a href="#cb89-3" tabindex="-1"></a>                                      <span class="at">design =</span> <span class="sc">~</span> <span class="dv">1</span>) <span class="co">#just add intercept to showcase normalization</span></span></code></pre></div>
<pre><code>## converting counts to integer mode</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a>dds <span class="ot">&lt;-</span> DESeq2<span class="sc">::</span><span class="fu">estimateSizeFactors</span>(dds)</span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a><span class="fu">sizeFactors</span>(dds)</span></code></pre></div>
<pre><code>##  [1] 0.9187624 1.0644717 0.5232069 0.9826698 0.5676212 0.7807662 0.8284089
##  [8] 0.6600848 2.3955069 0.7906917 2.2784591 0.7860386 0.7807842 0.8445577
## [15] 1.3345483 1.7011973 2.5001652 0.7889061 0.8138720 0.7632306 1.4518320
## [22] 0.6553677 1.6696064</code></pre>
<p>You may also want to check out the <a
href="https://www.youtube.com/watch?v=UFB993xufUU">StatQuest video on
DESeq2 normalization</a>.</p>
<div id="comparing-tmm-with-deseq2-normalization" class="section level3"
number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Comparing TMM with
DESeq2 Normalization</h3>
<p>We can compare the size factors for both normalizations to verify if
they agree on the normalization factors. Note we need to scale the
effective library sizes from <code>edgeR</code> to enforce a similar
scale as the size factors from <code>DESeq2</code>. While below we are
using an arithmetic mean, a geometric mean may be used as well, which
will be more robust to outlying effective library sizes.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a><span class="fu">plot</span>(effLibSize <span class="sc">/</span> <span class="fu">mean</span>(effLibSize), <span class="fu">sizeFactors</span>(dds),</span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;edgeR size factor&quot;</span>,</span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;DESeq2 size factor&quot;</span>)</span></code></pre></div>
<p><img src="sequencing_technicalDE_files/figure-html/unnamed-chunk-40-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="aliasing" class="section level1" number="7">
<h1><span class="header-section-number">7</span> Aliasing</h1>
<p>Suppose we are working with the following experimental design on
colon cancer. Studying the effect of a drug on gene expression,
researchers gather RNA-seq data from four colon cancer patients and four
healthy individuals. For each individual, they obtain RNA-seq data from
a blood sample before as well as two weeks after taking a daily dose of
the drug. The research question relates to differential expression after
vs. before taking the drug, in particular whether this is different for
the diseased versus healthy group (i.e., the interaction between time
(before/after taking the drug) and disease status (healthy/colon
cancer)).</p>
<p>In terms of the model matrix, we could imagine a design such as
<code>~ patient + disease*time</code>, where</p>
<ul>
<li><code>disease</code> is a binary indicator referring to colon cancer
versus control sample.</li>
<li><code>time</code> defines if the sample is taken before or after
taking the drug.</li>
<li><code>patient</code> defines the individual donor the sample comes
from.</li>
</ul>
<p>The research question could then amount to testing the
<code>disease * time</code> interaction.</p>
<p>Let’s try this, by simulating random data for one gene.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a><span class="co"># 2 samples per patient for 8 patients</span></span>
<span id="cb94-3"><a href="#cb94-3" tabindex="-1"></a>patient <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>], <span class="at">each=</span><span class="dv">2</span>)) </span>
<span id="cb94-4"><a href="#cb94-4" tabindex="-1"></a><span class="co"># first four are healthy, next four are diseased</span></span>
<span id="cb94-5"><a href="#cb94-5" tabindex="-1"></a>disease <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;healthy&quot;</span>,<span class="dv">8</span>), <span class="fu">rep</span>(<span class="st">&quot;cancer&quot;</span>,<span class="dv">8</span>)), <span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;healthy&quot;</span>, <span class="st">&quot;cancer&quot;</span>)) </span>
<span id="cb94-6"><a href="#cb94-6" tabindex="-1"></a><span class="co"># one before and one after sample for each</span></span>
<span id="cb94-7"><a href="#cb94-7" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">&quot;before&quot;</span>, <span class="st">&quot;after&quot;</span>), <span class="dv">8</span>), <span class="at">levels=</span><span class="fu">c</span>(<span class="st">&quot;before&quot;</span>, <span class="st">&quot;after&quot;</span>)) </span>
<span id="cb94-8"><a href="#cb94-8" tabindex="-1"></a></span>
<span id="cb94-9"><a href="#cb94-9" tabindex="-1"></a><span class="fu">table</span>(patient, disease, time)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">patient</th>
<th align="left">disease</th>
<th align="left">time</th>
<th align="right">Freq</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">a</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">b</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">c</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">d</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">e</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">f</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">g</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">h</td>
<td align="left">cancer</td>
<td align="left">after</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left"></td>
<td align="left">healthy</td>
<td align="left">after</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left"></td>
<td align="left"></td>
<td align="left">before</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="do">## simulate data for one gene</span></span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">16</span></span>
<span id="cb95-3"><a href="#cb95-3" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="at">n =</span> n, <span class="at">lambda =</span> <span class="dv">50</span>)</span>
<span id="cb95-4"><a href="#cb95-4" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" tabindex="-1"></a><span class="do">## fit a Poisson model</span></span>
<span id="cb95-6"><a href="#cb95-6" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> patient <span class="sc">+</span> disease<span class="sc">*</span>time,</span>
<span id="cb95-7"><a href="#cb95-7" tabindex="-1"></a>         <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>)</span>
<span id="cb95-8"><a href="#cb95-8" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ patient + disease * time, family = &quot;poisson&quot;)
## 
## Coefficients: (1 not defined because of singularities)
##                         Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)              3.76900    0.11916  31.631   &lt;2e-16 ***
## patientb                 0.06744    0.14999   0.450   0.6530    
## patientc                 0.06744    0.14999   0.450   0.6530    
## patientd                 0.27304    0.14310   1.908   0.0564 .  
## patiente                 0.16449    0.16224   1.014   0.3107    
## patientf                 0.02565    0.16644   0.154   0.8775    
## patientg                -0.01784    0.16785  -0.106   0.9154    
## patienth                 0.05706    0.16544   0.345   0.7302    
## diseasecancer                 NA         NA      NA       NA    
## timeafter               -0.01567    0.10220  -0.153   0.8782    
## diseasecancer:timeafter  0.12374    0.14407   0.859   0.3904    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 16.1200  on 15  degrees of freedom
## Residual deviance:  8.8417  on  6  degrees of freedom
## AIC: 120.16
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<hr />
<p>We find that one of the coefficients is <code>NA</code>! This is
obviously not because we’re dealing with <code>NA</code> values in the
data as we’ve just simulated the response variable ourselves. What’s
going on?</p>
<p>One of the parameters, in this case the parameter distinguishing
cancer from healthy patients <strong>cannot be estimated as it is a
linear combination of other parameters</strong>. In our case, estimating
the diseased effect would use information that is already used to
estimate the patient-level intercepts. In other words, <strong>once you
know the patient, you immediately also know the disease status</strong>,
so estimating the diseased vs healthy effect on top of the patient
effect provides no additional information if we have already estimated
the patient-level effects. This concept is called aliasing, and is a
common technical issue in ’omics experiments with complex experimental
designs.</p>
<hr />
<p>While to understand the origin of the aliasing it is crucial to
understand the relationship between the variables in the experimental
design, we can also investigate it in detail using the
<code>alias</code> function, to give us an idea.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a><span class="fu">alias</span>(m)</span></code></pre></div>
<pre><code>## Model :
## y ~ patient + disease * time
## 
## Complete :
##               (Intercept) patientb patientc patientd patiente patientf patientg
## diseasecancer 0           0        0        0        1        1        1       
##               patienth timeafter diseasecancer:timeafter
## diseasecancer 1        0         0</code></pre>
<p>We see that the effect <code>diseasecancer</code> is a linear
combination of the patient-specific effects of the cancer patients. This
makes sense!</p>
<hr />
<p>For clarity, let’s reproduce this using our design matrix.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> patient <span class="sc">+</span> disease<span class="sc">*</span>time) <span class="co"># this is the design used in glm()</span></span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a></span>
<span id="cb99-3"><a href="#cb99-3" tabindex="-1"></a><span class="do">## these are indeed identical.</span></span>
<span id="cb99-4"><a href="#cb99-4" tabindex="-1"></a>X[,<span class="st">&quot;diseasecancer&quot;</span>]</span></code></pre></div>
<pre><code>##  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 
##  0  0  0  0  0  0  0  0  1  1  1  1  1  1  1  1</code></pre>
<div class="sourceCode" id="cb101"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" tabindex="-1"></a>X[,<span class="st">&quot;patiente&quot;</span>] <span class="sc">+</span> X[,<span class="st">&quot;patientf&quot;</span>] <span class="sc">+</span> X[,<span class="st">&quot;patientg&quot;</span>] <span class="sc">+</span> X[,<span class="st">&quot;patienth&quot;</span>]</span></code></pre></div>
<pre><code>##  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 
##  0  0  0  0  0  0  0  0  1  1  1  1  1  1  1  1</code></pre>
<p>Since one of our parameters is a linear combination of other
parameters, it cannot be estimated simultaneously with the other
parameters. In this case, we can actually drop the <code>disease</code>
main effect from the model, since we know that it is already included in
the <code>patient</code> effect.</p>
<hr />
<p>We will have to carefully construct our design matrix in order to
account for all important sources of variation while still allowing us
to answer the research question of interest. The aliasing exploration
above has made it clear we may drop the <code>disease</code> main
effect, so let’s start by constructing this design matrix.</p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(<span class="sc">~</span> patient <span class="sc">+</span> time <span class="sc">+</span> disease<span class="sc">:</span>time)</span>
<span id="cb103-2"><a href="#cb103-2" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> X,</span>
<span id="cb103-4"><a href="#cb103-4" tabindex="-1"></a>         <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>)</span>
<span id="cb103-5"><a href="#cb103-5" tabindex="-1"></a><span class="fu">summary</span>(m2)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ -1 + X, family = &quot;poisson&quot;)
## 
## Coefficients: (1 not defined because of singularities)
##                           Estimate Std. Error z value Pr(&gt;|z|)    
## X(Intercept)               3.76900    0.11916  31.631   &lt;2e-16 ***
## Xpatientb                  0.06744    0.14999   0.450   0.6530    
## Xpatientc                  0.06744    0.14999   0.450   0.6530    
## Xpatientd                  0.27304    0.14310   1.908   0.0564 .  
## Xpatiente                  0.28823    0.16077   1.793   0.0730 .  
## Xpatientf                  0.14939    0.16500   0.905   0.3653    
## Xpatientg                  0.10590    0.16643   0.636   0.5246    
## Xpatienth                  0.18081    0.16400   1.102   0.2703    
## Xtimeafter                -0.01567    0.10220  -0.153   0.8782    
## Xtimebefore:diseasecancer -0.12374    0.14407  -0.859   0.3904    
## Xtimeafter:diseasecancer        NA         NA      NA       NA    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 4489.2752  on 16  degrees of freedom
## Residual deviance:    8.8417  on  6  degrees of freedom
## AIC: 120.16
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode" id="cb105"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a><span class="fu">alias</span>(m2)</span></code></pre></div>
<pre><code>## Model :
## y ~ -1 + X
## 
## Complete :
##                          X(Intercept) Xpatientb Xpatientc Xpatientd Xpatiente
## Xtimeafter:diseasecancer  0            0         0         0         1       
##                          Xpatientf Xpatientg Xpatienth Xtimeafter
## Xtimeafter:diseasecancer  1         1         1         0        
##                          Xtimebefore:diseasecancer
## Xtimeafter:diseasecancer -1</code></pre>
<p>We are still confronted with aliasing as the model matrix contains an
interaction effect <code>timebefore:diseasecancer</code> as well as
<code>timeafter:diseasecancer</code>, while only the latter is relevant.
Indeed, we know that we can derive the
<code>timebefore:diseasecancer</code> effect by averaging the patient
effects of the cancer patients.</p>
<hr />
<div class="sourceCode" id="cb107"><pre
class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a>X <span class="ot">&lt;-</span> X[,<span class="sc">!</span><span class="fu">colnames</span>(X) <span class="sc">%in%</span> <span class="st">&quot;timebefore:diseasecancer&quot;</span>]</span>
<span id="cb107-2"><a href="#cb107-2" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" tabindex="-1"></a></span>
<span id="cb107-4"><a href="#cb107-4" tabindex="-1"></a><span class="do">## fit a Poisson model</span></span>
<span id="cb107-5"><a href="#cb107-5" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> X,</span>
<span id="cb107-6"><a href="#cb107-6" tabindex="-1"></a>         <span class="at">family =</span> <span class="st">&quot;poisson&quot;</span>)</span>
<span id="cb107-7"><a href="#cb107-7" tabindex="-1"></a><span class="fu">summary</span>(m2)</span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = y ~ -1 + X, family = &quot;poisson&quot;)
## 
## Coefficients:
##                          Estimate Std. Error z value Pr(&gt;|z|)    
## X(Intercept)              3.76900    0.11916  31.631   &lt;2e-16 ***
## Xpatientb                 0.06744    0.14999   0.450   0.6530    
## Xpatientc                 0.06744    0.14999   0.450   0.6530    
## Xpatientd                 0.27304    0.14310   1.908   0.0564 .  
## Xpatiente                 0.16449    0.16224   1.014   0.3107    
## Xpatientf                 0.02565    0.16644   0.154   0.8775    
## Xpatientg                -0.01784    0.16785  -0.106   0.9154    
## Xpatienth                 0.05706    0.16544   0.345   0.7302    
## Xtimeafter               -0.01567    0.10220  -0.153   0.8782    
## Xtimeafter:diseasecancer  0.12374    0.14407   0.859   0.3904    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 4489.2752  on 16  degrees of freedom
## Residual deviance:    8.8417  on  6  degrees of freedom
## AIC: 120.16
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>We see that all coefficients can now be estimated. The
<code>timeafter</code> effect may be interpreted as the time effect for
healthy patients, while the <code>timeafter:diseasecancer</code> effect
may be interpreted as the difference in the time effect for cancer
patients as compared to healthy patients, i.e., it is the relevant
interaction effect we are interested in.</p>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAnU2VxdWVuY2luZzogU2VsZWN0ZWQgdGVjaG5pY2FsIHRvcGljcycKYXV0aG9yOiAiTGlldmVuIENsZW1lbnQgJiBLb2VuIFZhbiBkZW4gQmVyZ2UiCmRhdGU6ICJMYXN0IGVkaXRlZCBvbiBgciBmb3JtYXQoU3lzLnRpbWUoKSwgJyVkICVCLCAlWScpYCIKb3V0cHV0OiAKICBodG1sX2RvY3VtZW50OgogICAgdG9jOiB0cnVlCiAgICB0b2NfZmxvYXQ6IHRydWUKICBwZGZfZG9jdW1lbnQ6CiAgICB0b2M6IHRydWUKICAgIG51bWJlcl9zZWN0aW9uczogdHJ1ZQogICAgbGF0ZXhfZW5naW5lOiB4ZWxhdGV4CmFsd2F5c19hbGxvd19odG1sOiB0cnVlCmxpbmtjb2xvcjogYmx1ZQp1cmxjb2xvcjogYmx1ZSAKY2l0ZWNvbG9yOiBibHVlCmxpbmstY2l0YXRpb25zOiB5ZXMKCi0tLQoKYGBge3IgZnVuY3Rpb25zLCBpbmNsdWRlPUZBTFNFfQojIEEgZnVuY3Rpb24gZm9yIGNhcHRpb25pbmcgYW5kIHJlZmVyZW5jaW5nIGltYWdlcwpmaWcgPC0gbG9jYWwoewogICAgaSA8LSAwCiAgICByZWYgPC0gbGlzdCgpCiAgICBsaXN0KAogICAgICAgIGNhcD1mdW5jdGlvbihyZWZOYW1lLCB0ZXh0KSB7CiAgICAgICAgICAgIGkgPDwtIGkgKyAxCiAgICAgICAgICAgIHJlZltbcmVmTmFtZV1dIDw8LSBpCiAgICAgICAgICAgIHBhc3RlKCJGaWd1cmUgIiwgaSwgIjogIiwgdGV4dCwgc2VwPSIiKQogICAgICAgIH0sCiAgICAgICAgcmVmPWZ1bmN0aW9uKHJlZk5hbWUpIHsKICAgICAgICAgICAgcmVmW1tyZWZOYW1lXV0KICAgICAgICB9KQp9KQpgYGAKCmBgYHtyLCBlY2hvPUZBTFNFLCBtZXNzYWdlPUZBTFNFLCBldmFsPVRSVUV9CnN1cHByZXNzUGFja2FnZVN0YXJ0dXBNZXNzYWdlcyh7CiAgbGlicmFyeShrbml0cikKICBsaWJyYXJ5KHJtYXJrZG93bikKICBsaWJyYXJ5KGdncGxvdDIpCiAgbGlicmFyeShwcmludHIpCiAgbGlicmFyeShncmlkRXh0cmEpCiAgbGlicmFyeSh0aWR5dmVyc2UpCiAgbGlicmFyeShwbG90bHkpCn0pCmBgYAoKIyBQYXJhbWV0ZXIgRXN0aW1hdGlvbiBhbmQgSW5mZXJlbmNlIGluIEdlbmVyYWxpemVkIGxpbmVhciBtb2RlbHMgCgojIyBTaW11bGF0ZSBQb2lzc29uIERhdGEKCi0gV2Ugc2ltdWxhdGUgZGF0YSBmb3IgMTAwIG9ic2VydmF0aW9ucy4KLSBDb3ZhcmlhdGVzIHggYXJlIHNpbXVsYXRlZCBmcm9tIG5vcm1hbCBkaXN0cmlidXRpb24KLSBUaGUgJFxiZXRhJCBhcmUgY2hvc2VuIGF0ICRcYmV0YV8wPTIkLCAkXGJldGFfMT0wLjgkLCAkXGJldGFfMj0xLjIkCgpgYGB7cn0Kc2V0LnNlZWQoMzAwKQp4aGxwPC1jYmluZCgxLHJub3JtKDEwMCkscm5vcm0oMTAwKSkKYmV0YXNUcnVlPC1jKDIsMC44LDEuMikKZXRhVHJ1ZTwteGhscCUqJWJldGFzVHJ1ZQp5PC1ycG9pcygxMDAsZXhwKGV0YVRydWUpKQpkYXRhLmZyYW1lKGNvZWYgPTA6MixiZXRhc1RydWU9YmV0YXNUcnVlKSAlPiUgCiAgZ2dwbG90KGFlcyh4PWNvZWYseT1iZXRhc1RydWUpKSArIAogIGdlb21fcG9pbnQoKSArCiAgZ2VvbV9saW5lKCkgKwogIHlsYWIoInBhcmFtZXRlciB2YWx1ZSIpICsKICB4bGFiKCJiZXRhIikgKwogIHlsaW0oMCw0KSArCiAgdGhlbWVfYncoKSArCiAgc2NhbGVfeF9jb250aW51b3VzKGJyZWFrcz1jKDAsMSwyKSkKCgpgYGAKCmBgYHtyIGVjaG89RkFMU0UsIHdhcm5pbmc9RkFMU0V9CngxIDwtIHhobHBbLDJdCngyIDwtIHhobHBbLDNdCnAxIDwtIHBsb3RfbHkoCiAgICB4ID0gfngxLAogICAgeSA9IH54MiwKICAgIHo9IH55LAogICAgbW9kZT0ibWFya2VycyIsCiAgICBzaXplPS41KSAlPiUKICBhZGRfbWFya2Vycyh0eXBlPSJzY2F0dGVyM2QiKSAlPiUKICBsYXlvdXQoCiAgICBzY2VuZSA9IGxpc3QoCiAgICAgIGFzcGVjdG1vZGU9ImN1YmUiLAogICAgICB4YXhpcyA9IGxpc3QocmFuZ2U9cmFuZ2UoeGhscFssMl0pKSksIHlheGlzID0gbGlzdChyYW5nZT1yYW5nZSh4aGxwWywzXSkpLCB6YXhpcyA9IGxpc3QocmFuZ2U9cmFuZ2UoeSkpCiAgICAgICkKcDEKYGBgCgpgYGB7ciBlY2hvPUZBTFNFLCB3YXJuaW5nPUZBTFNFfQp4MSA8LSB4aGxwWywyXQp4MiA8LSB4aGxwWywzXQpwMSA8LSBwbG90X2x5KAogICAgeCA9IH54MSwKICAgIHkgPSB+eDIsCiAgICB6PSB+IGxvZzIoeSsuNSksCiAgICBtb2RlPSJtYXJrZXJzIiwKICAgIHNpemU9LjUpICU+JQogIGFkZF9tYXJrZXJzKHR5cGU9InNjYXR0ZXIzZCIpICU+JQogIGxheW91dCgKICAgIHNjZW5lID0gbGlzdCgKICAgICAgYXNwZWN0bW9kZT0iY3ViZSIsCiAgICAgIHhheGlzID0gbGlzdChyYW5nZT1yYW5nZSh4aGxwWywyXSkpKSwgeWF4aXMgPSBsaXN0KHJhbmdlPXJhbmdlKHhobHBbLDNdKSksIHpheGlzID0gbGlzdChyYW5nZT1yYW5nZSh5KSkKICAgICAgKQpwMQpgYGAKCgojIyBFeHBvbmVudGlhbCBGYW1pbHkKCiQkCmYoeV9pXHZlcnQgXHRoZXRhX2ksXHBoaSk9XGV4cFxsZWZ0XHsgXGZyYWN7eV9pXHRoZXRhX2ktIGIoXHRoZXRhX2kpfXthKFxwaGkpfStjKHlfaSxccGhpKVxyaWdodFx9CiQkCgp3aXRoCgotICRcdGhldGFfaSQ6IGNhbm9uaWNhbCBwYXJhbWV0ZXJzCi0gJFxwaGkkOiBkaXNwZXJzaW9uIHBhcmFtZXRlcgotICRhKC4pJCwgJGIoLikkLCAkYyguKSQ6IHNwZWNpZmljIGZ1bmN0aW9ucyB0aGF0IGRlcGVuZCBvbiB0aGUgZGlzdHJpYnV0aW9uLCAKCmUuZy4gZm9yIG5vcm1hbCBkaXN0cmlidXRpb24gCgotICRccGhpPVxzaWdtYV4yJCwgCi0gJFx0aGV0YT1cbXUkLCAKLSAkYShccGhpKT1ccGhpPVxzaWdtYV4yJCwgCi0gJGIoXHRoZXRhX2kpPVx0aGV0YV9pXjIvMiQsIAotICRjKHlfaSxccGhpKT0tXGZyYWN7MX17Mn1beV4yL1xwaGkrXGxvZygyXHBpXHBoaSldJAoKIyMjIFBvaXNzb24gRGlzdHJpYnV0aW9uCgokJAp5X2kgXHNpbSBcZnJhY3tcbXVfaV57eV9pfWVeey1cbXVfaX19e3lfaSF9CiQkCgpJbiBmb3JtYXQgb2YgZXhwb25lbnRpYWwgZmFtaWx5OiAKCiQkCnlfaSBcc2ltIFxleHBcbGVmdFx7eV9pXGxvZyhcbXVfaSkgLSBcbXVfaSAtIFxsb2coeV9pISlccmlnaHRcfQokJAoKIyMgQ29tcG9uZW50cyBvZiBHZW5lcmFsaXplZCBMaW5lYXIgTW9kZWwKCiQkClxsZWZ0XHtcYmVnaW57YXJyYXl9e2NjY30KeV9pXHZlcnQgeF9pJlxzaW0mZih5X2lcdmVydHtcdGhldGF9X2ksXHBoaSlcXFxcClx0ZXh0e0V9XGxlZnRbIHlfaVx2ZXJ0IFxtYXRoYmZ7eH1faVxyaWdodF0mPSZcbXVfaVxcXFwKZyhcbXVfaSkmPSZcZXRhKFxtYXRoYmZ7eH1faSlcXFxcClxldGEoXG1hdGhiZnt4fV9pKSY9JlxtYXRoYmZ7eH1faV5UXGJvbGRzeW1ib2x7XGJldGF9ClxlbmR7YXJyYXl9XHJpZ2h0LiwKJCQKd2l0aCAkZyguKSQgdGhlIGxpbmsgZnVuY3Rpb24sIGUuZy4gCgotICRnKC4pPS4kIDogaWRlbnRpdHkgbGluayBmb3IgTm9ybWFsIGRpc3RyaWJ1dGlvbgotICRnKC4pPVxsb2coLikkIDogY2Fub25pY2FsIGxpbmsgZm9yIFBvaXNzb24gZGlzdHJpYnV0aW9uCi0gJGcoLik9XHRleHR7bG9naXR9KC4pPVxsb2dcbGVmdFtcZnJhY3soLil9eygxLS4pfVxyaWdodF0kIDogY2Fub25pY2FsIGxpbmsgZm9yIEJlcm5vdWlsbGkgZGlzdHJpYnV0aW9uLgoKIyMjIFBvaXNzb24gR0xNCgokJFxsZWZ0XHtcYmVnaW57YXJyYXl9e2xjcn0KeV9pICZcc2ltJiBQb2lzc29uKFxtdV9pKVxcCkVbeV9pXSY9JlxtdV9pXFwKXGxvZyhcbXVfaSkmPSZcZXRhX2lcXApcZXRhX2kmPSZcbWF0aGJme3h9X2lcYm9sZHN5bWJvbHtcYmV0YX0KXGVuZHthcnJheX1ccmlnaHQuJCQKCiMjIExpa2VsaWhvb2QKCldlIHN0YXJ0IGZyb20gYSBzYW1wbGUsIGFuZCBjb25zaWRlciBpdCBhcyBmaXhlZCBhbmQga25vd24uIAoKLSBJbiBwYXJ0aWN1bGFyIHdlIGRvIE5PVCBjb25zaWRlciB0aGUgc2FtcGxlIG9ic2VydmF0aW9ucyBhcyByYW5kb20gdmFyaWFibGVzLiAKCi0gVGhlcmVmb3JlIHdlIHdyaXRlIHRoZSBvYnNlcnZlZCBzYW1wbGUgYXMgJHlfaSwgLiAuIC4gLCB5X24kCgotIFRoZSB0aGVvcnkgaXMgYmFzZWQgb24gdGhlIGxpa2VsaWhvb2QgZnVuY3Rpb24sIHdoaWNoICBjYW4gYmUgaW50ZXJwcmV0ZWQgYXMgYSBtZWFzdXJlIGZvciB0aGUgcHJvYmFiaWxpdHkgdGhhdCB0aGUgZ2l2ZW4gc2FtcGxlIGlzIG9ic2VydmVkIGFzIGEgcmVhbGlzYXRpb24gb2YgYSBzZXF1ZW5jZSBvZiByYW5kb20gdmFyaWFibGVzICRZXzEsIFxsZG90cyBZX24kIAoKLSBUaGUgcmFuZG9tIHZhcmlhYmxlcyAkWV9pJCBhcmUgY2hhcmFjdGVyaXplZCBieSBhIGRpc3RyaWJ1dGlvbiBvciBkZW5zaXR5IGZ1bmN0aW9uIHdoaWNoIGhhcyB0eXBpY2FsbHkgdW5rbm93biBwYXJhbWV0ZXJzLCBlLmcuIGEgUG9pc3NvbiBkaXN0cmlidXRpb24gJGYoWV9pKVxzaW0gXHRleHR7UG9pc3Nvbn0oXHRoZXRhX2kpJC4KCi0gV2hlbiB0aGUgc3ViamVjdHMgYXJlIG11dHVhbGx5IGluZGVwZW5kZW50IHRoZSBqb2ludCBsaWtlbGlob29kIHRvIG9ic2VydmUgJHlfMSwgXGxkb3RzLCB5X24kIGVxdWFscyAKJCRccHJvZFxsaW1pdHNfe2k9MX1ebiBmKHlfaSxcdGhldGFfaSxccGhpKSQkCi0gVGhlIGRlbnNpdGllcyBhcmUgYWN0dWFsbHkgYWxzbyBhIGZ1bmN0aW9uIG9mIHRoZSBwYXJhbWV0ZXJzICRcdGhldGFfaSwgXHBoaSQuIFRvIHN0cmVzcyB0aGlzLCB3ZSBpbmRpY2F0ZWQgdGhhdCBpbiB0aGUgZGVuc2l0eSBmb3JtdWxhdGlvbi4KCi0gVGhlIGxpa2VsaWhvb2QgZnVuY3Rpb24gaXMgYSBmdW5jdGlvbiBvZiBhbGwgcGFyYW1ldGVycyAKCiQkCkwoXGJvbGRzeW1ib2x7XHRoZXRhfSxccGhpXHZlcnQgXGJvbGRzeW1ib2x7eX0pPVxwcm9kXGxpbWl0c197aT0xfV5uIGYoeV9pLFx0aGV0YV9pLFxwaGkpCiQkCgotIFRoZSBsb2ctbGlrZWxpaG9vZCBmdW5jdGlvbiBpcyBvZnRlbiB1c2VkLCB3aGljaCBpcyBkZWZpbmVkIGFzCiQkCmwoXGJvbGRzeW1ib2x7XHRoZXRhfSxccGhpXHZlcnQgXGJvbGRzeW1ib2x7eX0pID0gXGxvZyBMKFxib2xkc3ltYm9se1x0aGV0YX0sXHBoaVx2ZXJ0IFxib2xkc3ltYm9se3l9KSA9ICBcc3VtXGxpbWl0c197aT0xfV5uIFxsb2cgIGYoeV9pLFx0aGV0YV9pLFxwaGkpCiQkCiAKIyMjIFBvaXNzb24gRXhhbXBsZSAKClRoZSBsb2ctbGlrZWxpaG9vZCBmb3Igb3VyIHNpbXVsYXRlZCBkYXRhc2V0IGdpdmVuIHRoZSByZWFsIG1vZGVsIHBhcmFtZXRlcnMgaXM6IAoKRm9yIG9uZSBvYnNlcnZhdGlvbjoKJCRsKFxtdV9pIFx2ZXJ0IHlfaSkgPSB5X2kgXGxvZyBcbXVfaSAtIFxtdV9pIC0gXGxvZyB5X2khJCQKCi0gVmVyaWZ5IGluIFIuCgpgYGB7cn0KbXVUcnVlIDwtIGV4cChldGFUcnVlKQpsb2dsaWtQb2lzIDwtIGRwb2lzKHksbXVUcnVlLGxvZyA9IFRSVUUpCmxvZ0xpa1NlbGYgPC0geSpsb2cobXVUcnVlKSAtIG11VHJ1ZSAtIGxmYWN0b3JpYWwoeSkKcXBsb3QobG9nbGlrUG9pcyxsb2dMaWtTZWxmKSArIHRoZW1lX2J3KCkgKyBnZW9tX2FibGluZShpbnRlcmNlcHQgPSAwLCBzbG9wZT0xKQpgYGAKClRoZSBsb2ctbGlrZWxpaG9vZCBjYW4gYWxzbyBiZSB3cml0dGVuIGluIHRlcm1zIG9mIHRoZSBjYW5vbmljYWwgbW9kZWwgcGFyYW1ldGVycyAkXHRoZXRhJAoKJCRsKFxtdV9pIFx2ZXJ0IHlfaSkgPSB5X2kgXHRoZXRhX2kgLSBlXntcdGhldGFfaX0gLSBcbG9nIHlfaSEkJAoKLSBOb3RlIHRoYXQgJFx0aGV0YV9pID0gXGV0YV9pJC4gVGhlIGNhbm9uaWNhbCBwYXJhbWV0ZXIgZm9yIHRoZSBwb2lzc29uIGVxdWFscyB0aGUgbGluZWFyIHByZWRpY3RvciEKICAkJFx0aGV0YV9pPVxldGFfaT1cbWF0aGJme3h9X2ledFxib2xkc3ltYm9se1xiZXRhfSQkCgpMb2ctbGlrZWxpaG9vZCBmb3IgYWxsIG9ic2VydmF0aW9ucywgZ2l2ZW4gdGhhdCB0aGV5IGFyZSBpbmRlcGVuZGVudDoKJCRsKFxib2xkc3ltYm9se1xtdX0gXHZlcnQgXG1hdGhiZnt5fSkgPSBcc3VtXGxpbWl0c197aT0xfV5uIFxsZWZ0XHsgeV9pIFx0aGV0YV9pIC0gZV57XHRoZXRhX2l9IC0gXGxvZyB5X2khXHJpZ2h0XH0kJAoKLSBDYWxjdWxhdGUgaW4gUjogCgpgYGB7cn0KZHBvaXMoeSxsYW1iZGEgPSBtdVRydWUsIGxvZyA9IFRSVUUpICU+JSAKICBzdW0oKQpgYGAKCiMjIyBQcm9wZXJ0aWVzIG9mIHRoZSBMb2ctTGlrZWxpaG9vZAoKJCQKbChcdGhldGFfaSxccGhpXHZlcnQgeV9pKT1cbGVmdFx7IFxmcmFje3lfaVx0aGV0YV9pLSBiKFx0aGV0YV9pKX17YShccGhpKX0rYyh5X2ksXHBoaSlccmlnaHRcfQokJAoKLSAkRVt5X2ldPVxtdV9pPWJeXHByaW1lKFx0aGV0YV9pKSQKLSAkXHRleHR7dmFyfVt5X2ldPWJee1xwcmltZVxwcmltZX0oXHRoZXRhX2kpIGEoXHBoaSkkCgpOb3RlIHRoYXQsIAoKLSBWYXJpYW5jZSAkXHRleHR7dmFyfVt5X2ldJCBkZXBlbmRzIG9uIG1lYW4hIAotIE9mdGVuIHRoZXJlIGlzIG5vIGRpc3BlcnNpb24gcGFyYW1ldGVyIGUuZy4gQmVybm91aWxsaTogJFx0ZXh0e3Zhcn1beV9pXT1cbXVfaSgxLVxtdV9pKSQsIAoKIyMjIFBvaXNzb24gRXhhbXBsZSAKCi0gQ2Fub25pY2FsIG1vZGVsIHBhcmFtZXRlciAkXHRoZXRhX2k9XGxvZ3tcbXVfaX0kLgotICRiKFx0aGV0YV9pKSA9IFxleHAoXHRoZXRhX2kpJAotICRjKHlfaSxccGhpKSA9IC0gXGxvZyh5X2khKSQKLSAkXHBoaSA9IDEkCi0gJGEoXHBoaSk9IDEkCi0gJFxtdV9pID1cZnJhY3tccGFydGlhbCBiKFx0aGV0YV9pKX17XHBhcnRpYWwgXHRoZXRhX2l9PSAgXGZyYWN7XHBhcnRpYWwgXGV4cChcdGhldGFfaSl9e1xwYXJ0aWFsIFx0aGV0YV9pfT1cZXhwKFx0aGV0YV9pKSQKLSAkXHRleHR7VmFyfVxsZWZ0W3lfaSBccmlnaHRdPSBhKFxwaGkpXGZyYWN7XHBhcnRpYWxeMiBiKFx0aGV0YV9pKX17KFxwYXJ0aWFsIFx0aGV0YV9pKV4yfT0gIFxmcmFje1xwYXJ0aWFsXjIgXGV4cChcdGhldGFfaSl9e1xwYXJ0aWFsIFx0aGV0YV9pXjJ9PVxleHAoXHRoZXRhX2kpJC4KLSBNZWFuIGlzIGVxdWFsIHRvIHZhcmlhbmNlIGZvciBQb2lzc29uIQoKIyMgUGFyYW1ldGVyIEVzdGltYXRpb246IE1heGltdW0gTGlrZWxpaG9vZAoKQ2hvb3NlIHRoZSBwYXJhbWV0ZXJzICRcYm9sZHN5bWJvbHtcYmV0YX0kIHNvIHRoYXQgdGhlIGxpa2VsaWhvb2QgdG8gb2JzZXJ2ZSB0aGUgc2FtcGxlIHVuZGVyIHRoZSBzdGF0aXN0aWNhbCBtb2RlbCBpcyBtYXhpbWl6ZWQuCgpJdCBpcyBlYXNpZXIgYW5kIGVxdWl2YWxlbnQgdG8gbWF4aW1pemUgdGhlIGxvZy1saWtpaG9vZAoKJCRcdGV4dHthcmdtYXh9X3tcYm9sZHN5bWJvbHtcYmV0YX19IGwoXGJvbGRzeW1ib2x7XG11fSBcdmVydCBcbWF0aGJme3l9KSQkCgokJApcZnJhY3tccGFydGlhbCAgbChcYm9sZHN5bWJvbHtcbXV9IFx2ZXJ0IFxtYXRoYmZ7eX0pfXsKXHBhcnRpYWx7XGJvbGRzeW1ib2x7XGJldGF9fX09MAokJAoKJFxmcmFje1xwYXJ0aWFsICBsKFxib2xkc3ltYm9se1xtdX0gXHZlcnQgXG1hdGhiZnt5fSl9ewpccGFydGlhbHtcYm9sZHN5bWJvbHtcYmV0YX19fSQgaXMgYWxzbyByZWZlcnJlZCB0byBhcyB0aGUgc2NvcmUgZnVuY3Rpb24uCgojIyMgU2NvcmUgZnVuY3Rpb24KCiQkClNfaShcdGhldGFfaSk9IFxmcmFje1xwYXJ0aWFsIGwoXHRoZXRhX2ksXHBoaVx2ZXJ0IHlfaSl9e1xwYXJ0aWFsIFx0aGV0YV9pfQokJAoKJCQKU19pKFx0aGV0YV9pKT0gXGZyYWN7XHBhcnRpYWwgbChcdGhldGFfaSxccGhpXHZlcnQgeV9pKX17XHBhcnRpYWwgXHRoZXRhX2l9PVxmcmFje3lfaSAtIFxtdV9pfXthKFxwaGkpfQokJAoKd2hlbiBjYW5vbmljYWwgbGluayBmdW5jdGlvbiBpcyB1c2VkOgoKLSAkXG11X2k9Yl5ccHJpbWUoXHRoZXRhX2kpJCAKCgpSZWdyZXNzaW9uIChjaGFpbiBydWxlIGFuZCAkaT0xLFxsZG90cyxuJCBpLmkuZCBvYnNlcnZhdGlvbnMpCgpcYmVnaW57ZXFuYXJyYXkqfQpTKFxib2xkc3ltYm9se1xiZXRhfSkmPSZcZnJhY3tccGFydGlhbCAgXHN1bVxsaW1pdHNfe2k9MX1ebiBcbGVmdFx7IFxmcmFje3lfaSBcdGhldGFfaSAtIGIoXHRoZXRhX2kpfXthKFxwaGkpfStjKHlfaSxccGhpKVxyaWdodFx9fXtccGFydGlhbCBcYmV0YX1cXAomPSZcc3VtXGxpbWl0c197aT0xfV5uXGZyYWN7XHBhcnRpYWwgIFxsZWZ0XHsgXGZyYWN7eV9pIFx0aGV0YV9pIC0gYihcdGhldGFfaSl9e2EoXHBoaSl9K2MoeV9pLFxwaGkpXHJpZ2h0XH19e1xwYXJ0aWFsIFx0aGV0YX1cZnJhY3tccGFydGlhbCBcdGhldGF9e1xwYXJ0aWFsXG11fVxmcmFje1xwYXJ0aWFsXG11fXtccGFydGlhbFxldGF9XGZyYWN7XHBhcnRpYWxcZXRhfXtccGFydGlhbFxiZXRhfVxcCiY9JlxzdW1cbGltaXRzX3tpPTF9Xm5cZnJhY3t5X2ktXG11X2l9e2EoXHBoaSl9XGZyYWN7MX17Yl57XHByaW1lXHByaW1lfShcdGhldGEpfVxmcmFje1xwYXJ0aWFsXG11fXtccGFydGlhbFxldGF9XG1hdGhiZnt4fV50XFwKJj0mXG1hdGhiZntYfV5UXG1hdGhiZntBfVxsZWZ0KFxtYXRoYmZ7eX0tXGJvbGRzeW1ib2x7XG11fVxyaWdodCkKXGVuZHtlcW5hcnJheSp9CgoKLSAkXGJvbGRzeW1ib2x7QX0kIGlzIGEgZGlhZ29uYWwgbWF0cml4OiAkYV97aWl9PVxsZWZ0KFx0ZXh0e3Zhcn1beV9pXVxmcmFje1xwYXJ0aWFsIFxldGFfaX17XHBhcnRpYWwgXG11X2l9XHJpZ2h0KV57LTF9JCwgJFxib2xkc3ltYm9se3l9PVt5XzEsXGxkb3RzLCB5X25dXlQkLCAkXGJvbGRzeW1ib2x7XG11fT1bXG11XzEsXGxkb3RzLFxtdV9uXV5UJCAKCiMjIyMgUG9pc3NvbiBFeGFtcGxlIAoKCkZvciBwb2lzc29uIGRhdGE6ICRhKFxwaGkpYl57XHByaW1lXHByaW1lfShcdGhldGEpPVxtdSQgYW5kICRcZnJhY3tccGFydGlhbCBcbXV9e1xwYXJ0aWFsIFxldGF9PVxtdSQuIFNvICRcbWF0aGJme0F9PVxtYXRoYmZ7SX0kIGFuZAoKJCQgUyhcYmV0YSk9XG1hdGhiZntYfV5UIFxsZWZ0XHtcbWF0aGJme1l9LVxib2xkc3ltYm9se1xtdX1ccmlnaHRcfSQkCgojIyMgU29sdmUgU2NvcmUgRXF1YXRpb25zCgpGaW5kICBwYXJhbWV0ZXIgZXN0aW1hdG9yICAkXGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19JCBzbyB0aGF0CiQkIFMoXGJvbGRzeW1ib2x7XGJldGF9KSA9IFxtYXRoYmZ7MH0kJAokJFxtYXRoYmZ7WH1eVFxtYXRoYmZ7QX1cbGVmdChcbWF0aGJme3l9LVxib2xkc3ltYm9se1xtdX1ccmlnaHQpID1cbWF0aGJmezB9JCQKUHJvYmxlbSEgTm9uIGxpbmVhciBpbiAkXGJldGEkIGR1ZSB0byAKCi0gbGluayBmdW5jdGlvbjogJFxib2xkc3ltYm9se1xtdX09aF57LTF9KFxldGEpJCAKLSAkYV97aWl9PVxsZWZ0KFx0ZXh0e3Zhcn1beV9pXVxmcmFje1xwYXJ0aWFsIFxldGFfaX17XHBhcnRpYWwgXG11X2l9XHJpZ2h0KV57LTF9JAoKJFxyaWdodGFycm93JCBGaW5kIHJvb3RzIG9mIHNjb3JlIGVxdWF0aW9uIGJ5IHVzaW5nIE5ld3Rvbi1SYXBoc29uIG1ldGhvZC4KCiMjIyBOZXd0b24tUmFwaHNvbgoKYGBge3IgZWNobz1GQUxTRSwgZmlnLmNhcD0gIk5ld3Rvbi1SYXBoc29uIGFsZ29yaXRobTogVGhlIGFsZ29yaXRobSBzdGFydHMgYXQgYW4gaW5pdGlhbCBndWVzcyBiayBmb3IgdGhlIHJvb3Qgb2YgdGhlIHNjb3JlIGZ1bmN0aW9uIFMuIEl0IHdhbGtzIGFsb25nIHRoZSB0YW5nZW50IGxpbmUgb2YgdGhlIHNjb3JlIGZ1bmN0aW9uIGluIFMoYmspICB0byBtb3ZlIGludG8gdGhlIGRpcmVjdGlvbiB3aGVyZSB0aGUgc2NvcmUgZnVuY3Rpb24gYmVjb21lcyB6ZXJvIChhbmQgd2hlcmUgdGhlIGxvZy1saWtlbGlob29kIGZ1bmN0aW9uIGlzIG1heGltYWwpLiBUaGUgbmV3IGVzdGltYXRlIG9mIHRoZSByb290IGlzIHRha2VuIGF0IGJrKzEgd2hlcmUgdGhlIHRhbmdlbnQgbGluZSBiZWNvbWVzIHplcm8uIEl0IHRoZW4gY2FsY3VsYXRlcyB0aGUgc2NvcmUgZm9yIHRoZSB1cGRhdGVkIHBhcmFtZXRlciBlc3RpbWF0b3IgYW5kIHRoZSB3aG9sZSBwcm9jZXNzIGlzIHJlcGVhdGVkIHVudGlsIHRoZSByb290IGlzIGZvdW5kLiJ9ClMgPC0gZnVuY3Rpb24oYmV0YSkgKGJldGEgLSAzKV4yIApkUyA8LSBmdW5jdGlvbihiZXRhKSAyKihiZXRhLTMpCmRTbGluZSA8LSBmdW5jdGlvbihiZXRhLCBiZXRhaykgZFMoYmV0YWspICpiZXRhICsgUyhiZXRhaykgLSBkUyhiZXRhaykgKiBiZXRhawoKYmV0YSA8LSBzZXEoLTIxLDE1LGxlbmd0aD0xMDApCmJldGFrIDwtIC0yMApiZXRhazEgPC0gYmV0YWsgLSAxL2RTKGJldGFrKSpTKGJldGFrKQpiZXRhU2VxRGsgPC0gc2VxKGJldGFrLGJldGFrMSxsZW5ndGg9MTAwKQpwTlIgPC0gcXBsb3QoYmV0YSwgUyhiZXRhKSwgZ2VvbT0ibGluZSIpICsKICBhbm5vdGF0ZSgibGluZSIseD1iZXRhU2VxRGsseT1kU2xpbmUoYmV0YVNlcURrLGJldGFrKSxsaW5ldHlwZSA9ICJkYXNoZWQiLGNvbD0icmVkIikgKwogICAgYW5ub3RhdGUoImxpbmUiLHg9cmVwKGJldGFrMSwyKSx5PWMoMCxTKGJldGFrMSkpLGxpbmV0eXBlID0gImRhc2hlZCIsY29sPSJyZWQiKSArCiAgICBhbm5vdGF0ZSgicG9pbnQiLHg9YmV0YWsseT1TKGJldGFrKSxjb2w9InJlZCIpICsKICB0aGVtZV9idygpCmJldGFOcyA8LSBiZXRhazEKZm9yIChpIGluIDE6NSkKewpiZXRhayA8LSBiZXRhazEKYmV0YWsxIDwtIGJldGFrIC0gMS9kUyhiZXRhaykqUyhiZXRhaykKYmV0YU5zIDwtIGMoYmV0YU5zLGJldGFrMSkKYmV0YVNlcURrIDwtIHNlcShiZXRhayxiZXRhazEsbGVuZ3RoPTEwMCkKcE5SIDwtIHBOUiArCiAgICBhbm5vdGF0ZSgibGluZSIseD1iZXRhU2VxRGsseT1kU2xpbmUoYmV0YVNlcURrLGJldGFrKSxsaW5ldHlwZSA9ICJkYXNoZWQiLGNvbD0icmVkIikgKwogICAgYW5ub3RhdGUoImxpbmUiLHg9cmVwKGJldGFrMSwyKSx5PWMoMCxTKGJldGFrMSkpLGxpbmV0eXBlID0gImRhc2hlZCIsY29sPSJyZWQiKSAKfQpwTlIgKyAKICBhbm5vdGF0ZSgidGV4dCIseD0tMjAseT1TKC0yMCkrNDAsbGFiZWw9cGFzdGUwKCJTKGJldGFba10pIiksY29sPSJyZWQiLHBhcnNlPVRSVUUpICsKICBhbm5vdGF0ZSgidGV4dCIseD1iZXRhTnNbMToyXSx5PVMoYmV0YU5zWzE6Ml0pKzQwLGxhYmVsPXBhc3RlMCgiUyhiZXRhW2srIiwxOjIsIl0pIiksY29sPSJyZWQiLHBhcnNlPVRSVUUpICAgKwogIGFubm90YXRlKCJ0ZXh0Iix4PWJldGFOc1sxOjNdLHk9cmVwKC00MCwzKSxsYWJlbD1wYXN0ZTAoImJldGFbaysiLDE6MywiXSIpLGNvbD0icmVkIixwYXJzZT1UUlVFKSArCiAgYW5ub3RhdGUoInBvaW50Iix4PWJldGFOcyx5PVMoYmV0YU5zKSxjb2w9InJlZCIpICsKICBhbm5vdGF0ZSgidGV4dCIseD0tMjAseT00MDAsIGxhYmVsPSJmcmFjKHBhcnRpYWxkaWZmKlMsIHBhcnRpYWxkaWZmKmJldGEpKicgfCcqYmV0YVtrXSIsIGNvbD0icmVkIixwYXJzZT1UUlVFKSArCiAgeGxhYihleHByZXNzaW9uKGJldGEpKSArCiAgeWxhYihleHByZXNzaW9uKFMoYmV0YSkpKQpgYGAKCk5ld3RvbiBSYXBoc29uIGFsZ29yaXRobSB0byBmaW5kIHRoZSByb290IG9mIHRoZSBzY29yZSBmdW5jdGlvbi4gCgoxLiBDaG9vc2UgaW5pdGlhbCBwYXJhbWV0ZXIgZXN0aW1hdGUgJFxib2xkc3ltYm9se1xiZXRhfV5rPVxib2xkc3ltYm9se1xiZXRhfV4wJAoyLiBDYWxjdWxhdGUgc2NvcmUgJFMoXGJvbGRzeW1ib2x7XGJldGF9KVx2ZXJ0X3tcYm9sZHN5bWJvbHtcYmV0YX09XGJvbGRzeW1ib2x7XGJldGF9Xmt9JAozLiBDYWxjdWxhdGUgZGVyaXZhdGl2ZSBvZiB0aGUgZnVuY3Rpb24gZm9yIHdoaWNoIHlvdSB3YW50IHRvIGNhbGN1bGF0ZSB0aGUgcm9vdHMKNC4gV2FsayBhbG9uZyBmaXJzdCBkZXJpdmF0aXZlIHVudGlsIGxpbmUgKHBsYW5lKSBvZiB0aGUgZGVyaXZhdGl2ZSBjcm9zc2VzIHplcm8KNS4gVXBkYXRlIHRoZSBiZXRhcyAkXGJvbGRzeW1ib2x7XGJldGF9XntrKzF9JAo2LiBJdGVyYXRlIGZyb20gc3RlcCAyIC0gNSB1bnRpbCBjb252ZXJnZW5jZS4KCgojIyMjIERlcml2YXRpdmUgb2YgU2NvcmUgCgpXZSBoYXZlIHRvIGltcGxlbWVudCBhbiBpbnRlcmF0aXZlIGFsZ29yaXRobSBmb3Igb3B0aW1pc2F0aW9uLiBUbyBtYWtlIHRoaW5ncyB0cmFjdGFibGUgd2Ugd2lsbCBhY3QgYXMgaWYgJFxtYXRoYmZ7QX0kIGlzIGtub3duIGFuZCBmaXggaXQgdXNpbmcgdGhlIGN1cnJlbnQgdmFsdWVzIG9mICRcYm9sZHN5bWJvbHtcYmV0YX1eayQuIE5vdGUsIHRoYXQgZm9yIFBvaXNzb24gcmVncmVzc2lvbiAkXG1hdGhiZntBfT1cbWF0aGJme0l9JC4KClxiZWdpbntlcW5hcnJheSp9ClxmcmFje1xwYXJ0aWFsIFMoXGJvbGRzeW1ib2x7XGJldGF9KX17XHBhcnRpYWwgXGJvbGRzeW1ib2x7XGJldGF9fSAmPSYgXGZyYWN7IFxtYXRoYmZ7WH1eVFxtYXRoYmZ7QX0gXGxlZnRce1xtYXRoYmZ7WX0tXGJvbGRzeW1ib2x7XG11fVxyaWdodFx9fXtccGFydGlhbCBcYm9sZHN5bWJvbHtcYmV0YX19XFwKJj0mIC0gXG1hdGhiZntYfV5UIFxtYXRoYmZ7QX1cbGVmdFsKXGJlZ2lue2FycmF5fXtjY2NjfSBcZnJhY3tccGFydGlhbCBcbXVfMX17XHBhcnRpYWwgXGV0YV8xfSAmMCZcbGRvdHMmMFxcCiAwJlxmcmFje1xwYXJ0aWFsIFxtdV8yfXtccGFydGlhbCBcZXRhXzJ9ICZcbGRvdHMmMFxcClx2ZG90cyZcdmRvdHMmXHZkb3RzJlx2ZG90c1xcCjAmMCZcbGRvdHMmIFxmcmFje1xwYXJ0aWFsIFxtdV9ufXtccGFydGlhbCBcZXRhX259XFwKXGVuZHthcnJheX1ccmlnaHRdIFxmcmFje1xwYXJ0aWFsIFxib2xkc3ltYm9se1xldGF9fXtccGFydGlhbCBcYm9sZHN5bWJvbHtcYmV0YX19XFwKJj0mLVxtYXRoYmZ7WH1eVFxtYXRoYmZ7V1h9ClxlbmR7ZXFuYXJyYXkqfQoKIyMjIyBEZWZpbmUgZXF1YXRpb24gb2YgVGFuZ2VudCBMaW5lIChQbGFuZSkKCi0gV2Uga25vdyB0d28gcG9pbnRzIG9mIHRoZSB0YW5nZW50IHBsYW5lICQoXGJvbGRzeW1ib2x7XGJldGF9XmssUyhcYm9sZHN5bWJvbHtcYmV0YX1eaykpJCBhbmQgJChcYm9sZHN5bWJvbHtcYmV0YX1ee2srMX0sMCkkCi0gV2Uga25vdyB0aGUgZGlyZWN0aW9uIG9mIHRoZSBwbGFuZSAkU15ccHJpbWUoXGJvbGRzeW1ib2x7XGJldGF9KT1cZnJhY3tccGFydGlhbCBTKFxib2xkc3ltYm9se1xiZXRhfSl9e1xwYXJ0aWFsIFxib2xkc3ltYm9se1xiZXRhfX0kCi0gRXF1YXRpb24gb2YgUGxhbmU6CiQkUyhcYm9sZHN5bWJvbHtcYmV0YX0pPXtcYWxwaGF9XzArU15ccHJpbWVcdmVydF97XGJvbGRzeW1ib2x7XGJldGF9Xmt9IFxib2xkc3ltYm9se1xiZXRhfSQkCgotIEdldCAkXGJvbGRzeW1ib2x7XGJldGF9X3trKzF9JApcYmVnaW57ZXFuYXJyYXkqfQpcbWF0aGJmezB9Jj0me1xhbHBoYX1fMCtTXlxwcmltZVx2ZXJ0X3tcYm9sZHN5bWJvbHtcYmV0YX1ee2t9fSBcYm9sZHN5bWJvbHtcYmV0YX1ee2srMX1cXApcYm9sZHN5bWJvbHtcYmV0YX1ee2srMX0mPSYtXGxlZnQoU157XHByaW1lfVx2ZXJ0X3tcYm9sZHN5bWJvbHtcYmV0YX1ee2t9fVxyaWdodCleey0xfXtcYWxwaGF9XzBcXApcZW5ke2VxbmFycmF5Kn0KCi0gR2V0ICR7XGFscGhhfV8wJApcYmVnaW57ZXFuYXJyYXkqfQpTKFxib2xkc3ltYm9se1xiZXRhfV5rKSY9Jlxib2xkc3ltYm9se1xhbHBoYX1fMCtTXlxwcmltZVx2ZXJ0X3tcYm9sZHN5bWJvbHtcYmV0YX1ea30gXGJvbGRzeW1ib2x7XGJldGF9XmtcXAp7XGFscGhhfV8wJj0mLVNeXHByaW1lXHZlcnRfe1xib2xkc3ltYm9se1xiZXRhfV5rfSBcYm9sZHN5bWJvbHtcYmV0YX1eayArIFMoXGJvbGRzeW1ib2x7XGJldGF9XmspXFwKXGVuZHtlcW5hcnJheSp9CgotIEdldCAkXGJvbGRzeW1ib2x7XGJldGF9X3trKzF9JAoKXGJlZ2lue2VxbmFycmF5Kn0KXGJvbGRzeW1ib2x7XGJldGF9XntrKzF9Jj0mXGJvbGRzeW1ib2x7XGJldGF9XmstXGxlZnQoU157XHByaW1lfVx2ZXJ0X3tcYm9sZHN5bWJvbHtcYmV0YX1ee2t9fVxyaWdodCleey0xfVMoXGJvbGRzeW1ib2x7XGJldGF9XmspXFwKXGJvbGRzeW1ib2x7XGJldGF9XntrKzF9Jj0mXGJvbGRzeW1ib2x7XGJldGF9XmsrIFxsZWZ0KFxtYXRoYmZ7WH1eVFxtYXRoYmZ7V1h9XHJpZ2h0KV57LTF9IFMoXGJvbGRzeW1ib2x7XGJldGF9XmspClxlbmR7ZXFuYXJyYXkqfQoKV2l0aCAkSihcYm9sZHN5bWJvbHtcYmV0YX0pPUkoXGJvbGRzeW1ib2x7XGJldGF9KT1cbWF0aGJme1h9XlRcbWF0aGJme1dYfSQgIHRoZSBGaXNoZXIgaW5mb3JtYXRpb24gbWF0cml4LgoKIyMjIEZpc2hlciBTY29yaW5nCgpCZWNhdXNlIHdlIHVzZSB0aGUgY2Fub25pY2FsIG1vZGVsIHBhcmFtZXRlcnMgdGhlIG9ic2VydmVkICBGaXNoZXIgaW5mb3JtYXRpb24gbWF0cml4IGVxdWFscyB0aGUgZXhwZWN0ZWQgIEZpc2hlciBpbmZvcm1hdGlvbiBtYXRyaXggJEooXGJvbGRzeW1ib2x7XGJldGF9KT1JKFxib2xkc3ltYm9se1xiZXRhfSkkLgpJbmRlZWQsIHRoZSBvYnNlcnZlZCBGaXNoZXIgaW5mb3JtYXRpb24gbWF0cml4IGlzIG5vdCBkZXBlbmRpbmcgb24gdGhlIG9ic2VydmF0aW9ucywgYnV0IG9ubHkgb24gdGhlIGRlc2lnbiBhbmQgdGhlIHZhcmlhbmNlIG9mIHRoZSBkYXRhICh2aWEgdGhlIHdlaWdodHMpLgoKSGVuY2UsIE5ld3Rvbi1SYXBoc29uIGlzIGVxdWl2YWxlbnQgdG8gRmlzaGVyIHNjb3Jpbmcgd2hlbiB0aGUgY2Fub25pY2FsIGxpbmsgZnVuY3Rpb24gaXMgdXNlZC4KCk5vdGUsIHRoYXQgdGhlIEZpc2hlciBtYXRyaXgsIG1pbnVzIHNlY29uZCBkZXJpdmF0aXZlIChvciBoZXNzaWFuKSBvZiB0aGUgbGlrZWxpaG9vZCB0byB0aGUgbW9kZWwgcGFyYW1ldGVycywgaXMgYWxzbyB0aGUgaW52ZXJzZSBvZiB0aGUgdmFyaWFuY2UgY292YXJpYW5jZSBtYXRyaXggb2YgdGhlIG1vZGVsIHBhcmFtZXRlcnMuIEl0IGlzIHRodXMgcmVsYXRlZCB0byB0aGUgcHJlY2lzaW9uLgoKCiMjIyBJdGVyYXRpdmVseSBSZXdlaWdodGVkIExlYXN0IFNxdWFyZXMgKElSTFMpLgoKV2UgY2FuIHJld3JpdGUgTmV3dG9uIFJhcGhzb24gb3IgRmlzaGVyIHNjb3JpbmcgYXMgSVJMUy4KClxiZWdpbntlcW5hcnJheSp9Clxib2xkc3ltYm9se1xiZXRhfV57aysxfSY9Jlxib2xkc3ltYm9se1xiZXRhfV5rKyBcbGVmdChcbWF0aGJme1h9XlRcbWF0aGJme1dYfVxyaWdodCleey0xfSBTKFxib2xkc3ltYm9se1xiZXRhfV5rKVxcClxib2xkc3ltYm9se1xiZXRhfV57aysxfSY9Jlxib2xkc3ltYm9se1xiZXRhfV5rKyBcbGVmdChcbWF0aGJme1h9XlRcbWF0aGJme1dYfVxyaWdodCleey0xfSBcbWF0aGJme1h9XlRcbWF0aGJme0F9IFxsZWZ0KFxtYXRoYmZ7WX0tXGJvbGRzeW1ib2x7XG11fVxyaWdodClcXApcYm9sZHN5bWJvbHtcYmV0YX1ee2srMX0mPSYgXGxlZnQoXG1hdGhiZntYfV5UXG1hdGhiZntXWH1ccmlnaHQpXnstMX1cbWF0aGJme1h9XlRcbWF0aGJme1dYfVxib2xkc3ltYm9se1xiZXRhfV5rKyBcbGVmdChcYm9sZHN5bWJvbHtYfV5UXG1hdGhiZntXWH1ccmlnaHQpXnstMX0gXG1hdGhiZntYfV5UIFxtYXRoYmZ7V31cZnJhY3tccGFydGlhbCBcZXRhfXtccGFydGlhbCBcbXV9ICBcbGVmdChcbWF0aGJme1l9LVxib2xkc3ltYm9se1xtdX1ccmlnaHQpXFwKXGJvbGRzeW1ib2x7XGJldGF9XntrKzF9Jj0mIFxsZWZ0KFxtYXRoYmZ7WH1eVFxtYXRoYmZ7V1h9XHJpZ2h0KV57LTF9XG1hdGhiZntYfV5UXG1hdGhiZntXfSBcbGVmdFtcbWF0aGJme1h9XGJvbGRzeW1ib2x7XGJldGF9XmsgKyBcZnJhY3tccGFydGlhbCBcZXRhfXtccGFydGlhbCBcbXV9ICBcbGVmdChcbWF0aGJme1l9LVxib2xkc3ltYm9se1xtdX1ccmlnaHQpClxyaWdodF1cXApcYm9sZHN5bWJvbHtcYmV0YX1ee2srMX0mPSYgXGxlZnQoXG1hdGhiZntYfV5UXG1hdGhiZntXWH1ccmlnaHQpXnstMX1cbWF0aGJme1h9XlRcbWF0aGJme1d6fQpcZW5ke2VxbmFycmF5Kn0KCndpdGggJFxtYXRoYmZ7en09XGxlZnRbXG1hdGhiZntYfVxib2xkc3ltYm9se1xiZXRhfV5rICsgXGZyYWN7XHBhcnRpYWwgXGV0YX17XHBhcnRpYWwgXG11fSAgXGxlZnQoXG1hdGhiZntZfS1cYm9sZHN5bWJvbHtcbXV9XHJpZ2h0KVxyaWdodF0kCgpTbyB3ZSBjYW4gZml0IHRoZSBtb2RlbCBieSBwZXJmb3JtaW5nIGl0ZXJhdGl2ZSByZWdyZXNzaW9ucyBvZiB0aGUgcHNldWRvIGRhdGEgJFxtYXRoYmZ7en0kIG9uICRcbWF0aGJme1h9JC4KSW4gZWFjaCBpdGVyYXRpb24gd2Ugd2lsbCB1cGRhdGUgJFxtYXRoYmZ7en0kLCB0aGUgd2VpZ2h0cyAkXG1hdGhiZntXfSQgYW5kIHRoZSBtb2RlbCBwYXJhbWV0ZXJzLgoKRm9yIFBvaXNzb24gZGF0YSAKCi0gJFxmcmFje1xwYXJ0aWFsIFxldGF9e1xwYXJ0aWFsIFxtdX09XGZyYWN7XHBhcnRpYWxcbG9nIFxtdX17XHBhcnRpYWxcbXV9PVxmcmFjezF9e1xtdX09XGV4cCgtXGV0YSkkICAKLSAkXG1hdGhiZntXfT1cbWF0aGJme0F9XGZyYWN7XHBhcnRpYWx7XG11fX17e1xwYXJ0aWFsIFxldGF9fSQgaXMgYSBkaWFnb25hbCBtYXRyaXggd2l0aCAkW1xmcmFje1xwYXJ0aWFse1xtdV9pfX17e1xwYXJ0aWFsIFxldGFfaX19XV97aWl9PVtcbXVfaV1fe2lpfT1bXGV4cChcZXRhX2kpXV97aWl9JCBvbiBpdHMgZGlhZ29uYWwgZWxlbWVudHMuCgoKIyMjIFZhcmlhbmNlLUNvdmFyaWFuY2UgTWF0cml4IG9mIE1lYW4gTW9kZWwgUGFyYW1ldGVycz8KCkluIHRoZSBJUldMUyBhbGdvcml0aG0sIHRoZSBkYXRhIGlzIHdlaWdodGVkIGFjY29yZGluZyB0byB0aGUgdmFyaWFuY2Ugb2YgJFxtYXRoYmZ7WX0kLiBXZSBjb3JyZWN0IGZvciB0aGUgZmFjdCB0aGF0IHRoZSBkYXRhIGFyZSBoZXRlcm9zY2VkYXN0aWMuCgpDb3VudCBkYXRhIGhhdmUgYSBtZWFuIHZhcmlhbmNlIHJlbGF0aW9uIChlLmcuIGluIFBvaXNzb24gY2FzZSAkXHRleHR7RX1cbGVmdFtZIFxyaWdodF09XHRleHR7dmFyfVxsZWZ0W1kgXHJpZ2h0XT1cbXUkKS4KVGhlIElSV0xTIGFsc28gY29ycmVjdHMgZm9yIHRoZSBzY2FsZSBwYXJhbWV0ZXIgJFxwaGkkIGluICRcbWF0aGJme1d9JC4gKE5vdGUgdGhhdCB0aGUgc2NhbGUgcGFyYW1ldGVyIGZvciBQb2lzc29uIGlzICRccGhpPTEkKS4KClNvIElSV0xTIHRoZSB2YXJpYW5jZS1jb3ZhcmlhbmNlIG1hdHJpeCBmb3IgdGhlIG1vZGVsIHBhcmFtZXRlciBlcXVhbHMKJCRcbWF0aGJme1xTaWdtYX1fe1xoYXRcYmV0YX09XGxlZnQoXG1hdGhiZntYfV5UXG1hdGhiZntXWH1ccmlnaHQpXnstMX0uJCQKCk5vdGUsIHRoYXQgdGhlIEZpc2hlciBJbmZvcm1hdGlvbiBNYXRyaXggZXF1YWxzIHRoZSBpbnZlcnNlIG9mIHRoZSB2YXJpYW5jZS1jb3ZhcmlhbmNlIG1hdHJpeCBvZiB0aGUgZXhwZXJpbWVudC4KVGhlIGxhcmdlciB0aGUgRmlzaGVyIEluZm9ybWF0aW9uIE1hdHJpeCB0aGUgbW9yZSBpbmZvcm1hdGlvbiB3ZSBoYXZlIG9uIHRoZSBleHBlcmltZW50IHRvIGVzdGltYXRlIHRoZSBtb2RlbCBwYXJhbWV0ZXJzLgpGSU0gJFx1cGFycm93JCwgcHJlY2lzaW9uICRcdXBhcnJvdyQsICRcdGV4dHtTRX1cZG93bmFycm93JAoKIyMgUG9pc3NvbiBFeGFtcGxlIAoKCiMjIyBJbml0aWFsIEVzdGltYXRlCgpUaGlzIGlzIGEgdmVyeSBwb29yIGluaXRpYWwgZXN0aW1hdGUgdXNlZCB0byBpbGx1c3RyYXRlIHRoZSBhbGdvcml0aG0uCk90aGVyd2lzZSBjb252ZXJnZW5jZSBmb3IgdGhpcyBzaW1wbGUgZXhhbXBsZSBpcyB3YXkgdG9vIHF1aWNrCgpgYGB7cn0KaXRlcmF0aW9uPTAKYmV0YXM8LWMobG9nKG1lYW4oeSkpLDAsMCkKcGxvdChiZXRhc1RydWUsCiAgICAgeWxhYj1leHByZXNzaW9uKGJldGEpLAogICAgIHlsaW09YygwLDQpLAogICAgIHBjaD0xOSwKICAgICB0eXBlPSJiIiwgCiAgICAgbWFpbj1wYXN0ZTAoImxpa2VsaWhvb2QgcmVhbCBiZXRhPSIsCiAgICAgICAgICAgICAgICAgcm91bmQoc3VtKGRwb2lzKHksZXhwKGV0YVRydWUpLGxvZz1UUlVFKSksMSksIlxubGlrZWxpaG9vZCBmaXQ9Iiwgcm91bmQoc3VtKGRwb2lzKHksZXhwKHhobHAlKiViZXRhcyksbG9nPVRSVUUpKSwxKSkKKQpsaW5lcyhiZXRhcyx0eXBlPSJiIixsdHk9MiApCmBgYAoKIyMjIEl0ZXJhdGl2ZWx5IFJld2VpZ2h0ZWQgTGVhc3QgU3F1YXJlcwoKIyMjIyBQc2V1ZG8gRGF0YQoKJCR6X2k9IFxldGFfaSArIFxmcmFje1xwYXJ0aWFsIFxldGFfaX17XHBhcnRpYWwgXG11X2l9KHlfaSAtXG11X2kpJCQKJCR6X2k9IFxldGFfaSArIGVeey1cZXRhX2l9IHlfaSAtMSQkCgojIyMjIFdlaWdodCBNYXRyaXg/CgokJFt3X3tpaX1dPSB2YXJfe3lfaX1eey0xfSBcbGVmdChcZnJhY3tccGFydGlhbCBcbXV9e1xwYXJ0aWFsIFxldGF9XHJpZ2h0KV4yJCQKJCRbd197aWl9XT0gZV57XGV0YV9pfSQkCgojIyMjIFJ1biBVcGRhdGUgU3RlcCBNdWx0aXBsZSBUaW1lcwoKRmlyc3QgMyB0aW1lcyAoY29sb3JzIGFyZSBibGFjayAwLCByZWQgaXRlcmF0aW9uIDEsIGdyZWVuIGl0ZXJhdGlvbiAyLCBibHVlIGl0ZXJhdGlvbiAzKQoKYGBge3J9CnBsb3QoYmV0YXNUcnVlLHlsYWI9ZXhwcmVzc2lvbihiZXRhKSx5bGltPWMoMCw0KSxwY2g9MTksdHlwZT0iYiIpCmxpbmVzKGJldGFzLHR5cGU9ImIiLGx0eT0yKQoKY2F0KCJcbmxpa2VsaWhvb2QgVFJVRT0iLCByb3VuZChzdW0oZHBvaXMoeSxleHAoeGhscCUqJWJldGFzVHJ1ZSksbG9nPVRSVUUpKSwxKSkKY2F0KCJcbmxpa2VsaWhvb2QgaW5pdGlhbCBmaXQ9Iiwgcm91bmQoc3VtKGRwb2lzKHksZXhwKHhobHAlKiViZXRhcyksbG9nPVRSVUUpKSwxKSkKCiNDYWxjdWxhdGUgY3VycmVudCBldGEKZXRhPC14aGxwJSolYmV0YXMKCml0ZXJhdGlvbj0wCmZvciAoaSBpbiAxOjMpCnsKI3N0YXJ0IElSTFMgVVBEQVRFIFNURVAKaXRlcmF0aW9uPWl0ZXJhdGlvbisxCiNjYWxjdWxhdGUgcHNldWRvIGRhdGEgYmFzZWQgb24gY3VycmVudCBiZXRhcwp6PWV0YStleHAoLWV0YSkqKHktZXhwKGV0YSkpCiNjYWxjdWxhdGUgbmV3IHdlaWdodHM6IGRpYWdvbmFsIGVsZW1lbnRzCnc8LWMoZXhwKGV0YSkpCgojdXBkYXRlIGJldGFzCmxtVXBkYXRlPC1sbSh6fi0xK3hobHAsd2VpZ2h0PXcpCiNldGE8LXhobHAlKiViZXRhcwpldGE8LWxtVXBkYXRlJGZpdHRlZApiZXRhczwtbG1VcGRhdGUkY29lZgpsaW5lcyhiZXRhcyx0eXBlPSJiIixjb2w9aXRlcmF0aW9uKzEscGNoPWl0ZXJhdGlvbixsdHk9MikKY2F0KCJcbmxpa2VsaWhvb2QgY3VycmVudCBmaXQ9Iiwgcm91bmQoc3VtKGRwb2lzKHksZXhwKHhobHAlKiViZXRhcyksbG9nPVRSVUUpKSwxKSkKfQpgYGAKCgojIyBDb21wYXJpc29uIHdpdGggR0xNIEZ1bmN0aW9uCgojIyMgU21hcnRlciBJbml0aWFsaXNhdGlvbgpgYGB7cn0KejwtbG9nKHkrLjUpCmJldGFzPC1sbSh6fi0xK3hobHApJGNvZWYKcGxvdChiZXRhc1RydWUseWxhYj1leHByZXNzaW9uKGJldGEpLHlsaW09YygwLDQpLHBjaD0xOSx0eXBlPSJiIikKbGluZXMoYmV0YXMsY29sPTIsdHlwZT0iYiIsbHR5PTIpCiNjYWxjdWxhdGUgY3VycmVudCBldGEKZXRhPC14aGxwJSolYmV0YXMKCmNhdCgiXG5saWtlbGlob29kIFRSVUU9Iiwgcm91bmQoc3VtKGRwb2lzKHksZXhwKHhobHAlKiViZXRhc1RydWUpLGxvZz1UUlVFKSksMSkpCmNhdCgiXG5saWtlbGlob29kIGluaXRpYWwgZml0PSIsIHJvdW5kKHN1bShkcG9pcyh5LGV4cCh4aGxwJSolYmV0YXMpLGxvZz1UUlVFKSksMSkpCmBgYAoKIyMjIEV2YWx1YXRpb24gU3RvcHBpbmcgQ3JpdGVyaW9uCgotIFJlc2lkdWFsIGRldmlhbmNlOiBJcyAyIGxvZyBvZiBMUiBiZXR3ZWVuIGJlc3QgcG9zc2libGUgZml0IGFuZCBjdXJyZW50IGZpdAokJExSPVxmcmFje0xfXHRleHR7YmVzdH19e0xfXHRleHR7Y3VycmVudH19JCQKJCREPTIgKFxsb2cgTF9cdGV4dHtiZXN0fS0gXGxvZyBMX1x0ZXh0e2N1cnJlbnR9KSQkCiQkRD0yIChsX1x0ZXh0e2Jlc3R9LWxfXHRleHR7Y3VycmVudH0pJCQKLSBCZXN0IGZpdDogJFxtdT15JAotIE9wdGltYWwgcG9pc3NvbjoKJCQgbF9cdGV4dHtiZXN0fT1cc3VtXGxlZnRbeV9pIFxsb2coeV9pKSAtIHlfaSAtIFxsb2dcbGVmdCh5X2khXHJpZ2h0KVxyaWdodF0kJAotIEN1cnJlbnQgZml0CiQkIGxfXHRleHR7Y3VycmVudH09XHN1bSBcbGVmdFt5X2kgXGV0YV9pIC1lXntcZXRhX2l9IC0gbG9nXGxlZnQoeV9pIVxyaWdodClccmlnaHRdJCQKLSBEZXZpYW5jZSBEOgokJEQgPSAyIFxzdW0gXGxlZnRbIHlfaSBsb2coeV9pKSAtIHlfaSBcZXRhX2kgLSAoeV9pIC1lXntcZXRhX2l9KVxyaWdodF0kJAotIFByb2JsZW0gdG8gY2FsY3VsYXRlIGl0IGlmIHk9MCBidXQgYnkgYXBwbHkgbCdIb3BpdGFsJ3MgcnVsZSB3ZSBrbm93CiQkXGxpbV97eV9pIFx0byAwfSB5X2kgXGxvZyh5X2kpID0wJCQKCmBgYHtyfQp5bG9neTwtZnVuY3Rpb24oeSkKewpyZXR1cm4oaWZlbHNlKHk9PTAscmVwKDAsbGVuZ3RoKHkpKSx5KmxvZyh5KSkpCn0KCmRldmlhbmNlPC0yKnN1bSh5bG9neSh5KS15KmV0YS0oeS1leHAoZXRhKSkpCgpkZXZpYW5jZU9sZDwtMWUzMApgYGAKCgojIyMgUnVuIFVwZGF0ZSBTdGVwIHVudGlsIENvbnZlcmdlbmNlCgpgYGB7cn0KcGxvdChiZXRhc1RydWUseWxhYj1leHByZXNzaW9uKGJldGEpLHlsaW09YygwLDQpLHBjaD0xOSx0eXBlPSJiIikKbGluZXMoYmV0YXMsdHlwZT0iYiIsbHR5PTIpCgp0b2w8LTFlLTYKaXRlcmF0aW9uPTAKd2hpbGUoKChkZXZpYW5jZU9sZC1kZXZpYW5jZSkvZGV2aWFuY2VPbGQpPnRvbCkKewojc3RhcnQgSVJMUyBVUERBVEUgU1RFUAppdGVyYXRpb249aXRlcmF0aW9uKzEKI2NhbGN1bGF0ZSBwc2V1ZG8gZGF0YSBiYXNlZCBvbiBjdXJyZW50IGJldGFzCno9ZXRhK2V4cCgtZXRhKSooeS1leHAoZXRhKSkKI2NhbGN1bGF0ZSBuZXcgd2VpZ2h0czogZGlhZ29uYWwgZWxlbWVudHMKdzwtYyhleHAoZXRhKSkKCiN1cGRhdGUgYmV0YXMKbG1VcGRhdGU8LWxtKHp+LTEreGhscCx3ZWlnaHQ9dykKI2V0YTwteGhscCUqJWJldGFzCmV0YTwtbG1VcGRhdGUkZml0dGVkCmJldGFzPC1sbVVwZGF0ZSRjb2VmCmxpbmVzKGJldGFzLHR5cGU9ImIiLGNvbD1pdGVyYXRpb24rMSxwY2g9aXRlcmF0aW9uLGx0eT0yKQoKI2NyaXRlcmlvbiBmb3IgY29udmVyZ2VuY2UKZGV2aWFuY2VPbGQ8LWRldmlhbmNlCmRldmlhbmNlPC0yKnN1bSh5bG9neSh5KS15KmV0YS0oeS1leHAoZXRhKSkpCmNhdCgiaXRlcmF0aW9uIixpdGVyYXRpb24sIkRldmlhbmNlIE9sZCIsZGV2aWFuY2VPbGQsIkRldmlhbmNlIiwgZGV2aWFuY2UsIlxuIikKfQpgYGAKCiMjIyBWYXJpYW5jZSAkXGJldGEkPwoKJCRcU2lnbWFfe1xiZXRhfT1cbGVmdChcbWF0aGJme1h9XlRcbWF0aGJme1d9IFxtYXRoYmZ7WH1ccmlnaHQpXnstMX0kJAoKYGBge3J9CnZhckJldGE9c29sdmUodCh4aGxwKSUqJWRpYWcodyklKiV4aGxwKQpgYGAKCiMjIyBDb21wYXJpc29uIHdpdGggR0xNIGZpdAoKVXNlIC0xIGJlY2F1c2UgaW50ZXJjZXB0IGlzIGFscmVhZHkgaW4geGhscApgYGB7cn0KZ2xtZml0PWdsbSh5fi0xK3hobHAsZmFtaWx5PXBvaXNzb24pCmNvbXA9ZGF0YS5mcmFtZShnbG1maXQ9YyhnbG1maXQkZGV2aWFuY2UsZ2xtZml0JGNvZWYsc3VtbWFyeShnbG1maXQpJGNvZWZbLDJdKSxvdXJGaXQ9YyhkZXZpYW5jZSxiZXRhcyxzcXJ0KGRpYWcodmFyQmV0YSkpKSkKcm93Lm5hbWVzKGNvbXApPWMoImRldmlhbmNlIixwYXN0ZSgiYmV0YSIsMTozLHNlcD0iIikscGFzdGUoInNlIiwxOjMsc2VwPSIiKSkKY29tcApgYGAKCgojIyBIeXBvdGhlc2lzIHRlc3Rpbmc6IExhcmdlIHNhbXBsZSB0aGVvcnkKCiMjIyBXYWxkIHRlc3QKCi0gRm9sbG93cyBpbW1lZGlhdGVseSBmcm9tIHRoZSBpbmZvcm1hdGlvbiBtYXRyaXggZm9yIGdlbmVyYWxpemVkIGxpbmVhciBtb2RlbHMKIFxbSShcYm9sZHN5bWJvbHtcYmV0YX0pID0gXG1hdGhiZntYfV5UXG1hdGhiZntXWH1cXSAKIAogc28gbGFyZ2Ugc2FtcGxlIGRpc3RyaWJ1dGlvbiBvZiB0aGUgbWF4aW11bSBsaWtlbGlob29kIGVzdGltYXRvciAkXGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19JCBpcyBtdWx0aXZhcmlhdGUgbm9ybWFsClxbClxoYXR7XGJvbGRzeW1ib2x7XGJldGF9fSBcc2ltIE1WTlxsZWZ0W1xib2xkc3ltYm9se1xiZXRhfSxcbGVmdChcbWF0aGJme1h9XlRcbWF0aGJme1dYfVxyaWdodCleey0xfVxyaWdodF0KXF0KCldlIGNhbiBwZXJmb3JtIGEgV2FsZCBUZXN0IGZvciBhIHNpbmdsZSBtb2RlbCBwYXJhbWV0ZXIgCgokJApXID0gXGZyYWN7XGhhdFxiZXRhX219e1xoYXR7XHRleHR7c2V9fV97XGhhdFxiZXRhX219fSBcYXBwcm94IE4oMCwxKVx2ZXJ0IEhfMAokJAp0byB0ZXN0IGZvciAKCiQkCkhfMDogXGJldGFfcD0wIFxsZWZ0cmlnaHRhcnJvdyBIXzE6XGJldGFfcFxuZXEwCiQkCgoKQWdhaW4sIHdlIGNhbiBhbHNvIGFzc2VzcyBjb250cmFzdHMhIEluZGVlZCwgbGluZWFyIGNvbWJpbmF0aW9ucyBvZiBtb2RlbCBwYXJhbWV0ZXIgZXN0aW1hdG9ycyBhbHNvIGZvbGxvdyBhIG5vcm1hbCBkaXN0cmlidXRpb24uIAoKJCQKXG1hdGhiZntMfV5UXGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19IFxzaW0gTlxsZWZ0W1xtYXRoYmZ7TH1eVFxib2xkc3ltYm9se1xiZXRhfSxcbWF0aGJme0x9XlRcaGF0e1xib2xkc3ltYm9se1xTaWdtYX19X3tcaGF0e1xib2xkc3ltYm9se1xiZXRhfX19XG1hdGhiZntMfVxyaWdodF0KJCQKCldpdGggJFxtYXRoYmZ7TH0kIGEgdmVjdG9yIGZvciBhIHNpbmdsZSBjb250cmFzdC4gCgokJApXID0gXGZyYWN7XG1hdGhiZntMfV5UXGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19fXtcaGF0e1x0ZXh0e3NlfX1fe1xtYXRoYmZ7TH1eVFxoYXR7XGJvbGRzeW1ib2x7XGJldGF9fX19IFxhcHByb3ggTigwLDEpXHZlcnQgSF8wCiQkCnRlc3RpbmcgZm9yIAokJApIXzA6IFxtYXRoYmZ7TH1eVFxib2xkc3ltYm9se1xiZXRhfT0wIFxsZWZ0cmlnaHRhcnJvdyBIXzE6XG1hdGhiZntMfV5UXGJvbGRzeW1ib2x7XGJldGF9XG5lcTAKJCQKCldlIGNhbiBhbHNvIHRlc3QgZm9yIG11bHRpcGxlIGNvbnRyYXN0cyBzaW11bHRhbmVvdXNseSwgZS5nLiBieSBhc3N1bWluZyB0aGF0IG11bHRpcGxlIG1vZGVsIHBhcmFtZXRlcnMgYXJlIHplcm8uIFN1cHBvc2UgdGhhdCAkXG1hdGhiZntMfSQgaXMgdGhlIGNvbnRyYXN0IG1hdHJpeCB0aGF0IGNvcnJlc3BvbmRzIHRlc3RpbmcgZm9yICRjJCBtb2RlbCBwYXJhbWV0ZXJzLCBzaW11bHRhbmVvdXNseS4gIFRoZW4gCgokJApcbWF0aGJme0x9XlRcaGF0e1xib2xkc3ltYm9se1xiZXRhfX0gXHNpbSBNVk5cbGVmdFtcbWF0aGJme0x9XlRcYm9sZHN5bWJvbHtcYmV0YX0sXG1hdGhiZntMfV5UXGhhdHtcYm9sZHN5bWJvbHtcU2lnbWF9fV97XGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19fVxtYXRoYmZ7TH1ccmlnaHRdCiQkCgphbmQgCgokJCAKVyA9IFxtYXRoYmZ7TH1eVFxoYXR7XGJvbGRzeW1ib2x7XGJldGF9fVxsZWZ0KFxtYXRoYmZ7TH1eVFxoYXR7XGJvbGRzeW1ib2x7XFNpZ21hfX1fe1xoYXR7XGJvbGRzeW1ib2x7XGJldGF9fX1cbWF0aGJme0x9XHJpZ2h0KV57LTF9XGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19XG1hdGhiZntMfSBcc2ltIFxjaGleMl9jXHZlcnQgSF8wCiQkCnRvIHRlc3QgZm9yIAoKJCQKSF8wOiBcbWF0aGJme0x9XlRcYm9sZHN5bWJvbHtcYmV0YX09XG1hdGhiZnswfSBcbGVmdHJpZ2h0YXJyb3cgSF8xOlxtYXRoYmZ7TH1eVFxib2xkc3ltYm9se1xiZXRhfT1cbWF0aGJmezB9XG5lcTAKJCQKCkluIGdlbmVyYWwsIHdoZW4gd2UgdGVzdCBmb3IgJGNcZ2VxMSQgY29udHJhc3RzLCB0aGVuIHRoZSB0ZXN0IHN0YXRpc3RpYyAkV+KIvFxjaGleMl9yfEhfMCQsIHdpdGggJHIkIHRoZSByYW5rIG9mIHRoZSBjb250cmFzdCBtYXRyaXguCgoKIyMjICBMaWtlbGlob29kIHJhdGlvIHRlc3QKClRoZSBsaWtlbGlob29kIHJhdGlvIHRlc3QgKExSVCkgbWVhc3VyZXMgdGhlIGRpc2NyZXBhbmN5IGluIGxvZy1saWtlbGlob29kIGJldHdlZW4gb3VyIGN1cnJlbnQgbW9kZWwgKHNvbWV0aW1lcyBhbHNvIHJlZmVycmVkIHRvIGFzIGZ1bGwgbW9kZWwpIGFuZCBhIHJlZHVjZWQgbW9kZWwgKHNvbWV0aW1lcyBhbHNvIHJlZmVycmVkIHRvIGFzIG51bGwgb3IgYWx0ZXJuYXRpdmUgbW9kZWwpLiAKClRoZSByZWR1Y2VkIG1vZGVsIG11c3QgYmUgbmVzdGVkIGluIChhbmQgdGhlcmVmb3JlIG9mIGxvd2VyIGRpbWVuc2lvbiBhcyBjb21wYXJlZCB0bykgdGhlIGZ1bGwgbW9kZWwuIAoKV2hpbGUgYWRkaW5nIG1vcmUgY292YXJpYXRlcyB3aWxsIGFsd2F5cyBleHBsYWluIG1vcmUgdmFyaWFiaWxpdHkgaW4gb3VyIHJlc3BvbnNlIHZhcmlhYmxlLCB0aGUgTFJUIHRlc3RzIHdoZXRoZXIgdGhpcyBpcyBhY3R1YWxseSBzaWduaWZpY2FudC4gCgpGb3IgZXhhbXBsZSwgaW4gdGhlIGV4YW1wbGUgb2YgZ2VuZSBkaWZmZXJlbnRpYWwgZXhwcmVzc2lvbiBiZXR3ZWVuIGhlYWx0aHkgdmVyc3VzIHR1bW9yYWwgdGlzc3VlLCB0aGUgZnVsbCBtb2RlbCBjb3VsZCBiZSBhIEdMTSB3aGVyZSB0aGUgbWVhbiBpcyBtb2RlbGVkIGFjY29yZGluZyB0byBhbiBpbnRlcmNlcHQgYW5kIGEgdGlzc3VlIGluZGljYXRvciB2YXJpYWJsZSAoaGVhbHRoeSAvIHR1bW9yKSwgd2hpbGUgdGhlIGFsdGVybmF0aXZlIG1vZGVsIGNvdWxkIGJlIGEgR0xNIHdpdGgganVzdCBhbiBpbnRlcmNlcHQuIEluZGVlZCwgaWYgdGhlIGdlbmUgaXMgc2ltaWxhcmx5IGV4cHJlc3NlZCBiZXR3ZWVuIGhlYWx0aHkgYW5kIHR1bW9yIHRpc3N1ZSwgdGhlIGxvZy1saWtlbGlob29kIG9mIHRoZSBhbHRlcm5hdGl2ZSBtb2RlbCB3aWxsIGRlY3JlYXNlIG9ubHkgYSBsaXR0bGUgYXMgY29tcGFyZWQgdG8gdGhlIGZ1bGwgbW9kZWwuIAoKQXMgdGhlIG5hbWUgc3VnZ2VzdHMsIHRoZSBsaWtlbGlob29kIHJhdGlvIHRlc3QgYXNzZXNzZXMgd2hldGhlciB0aGUgcmF0aW8gb2YgdGhlIGxvZy1saWtlbGlob29kcyBwcm92aWRlcyBzdWZmaWNpZW50IGV2aWRlbmNlIGZvciBhIHdvcnNlIGZpdCBvZiB0aGUgYWx0ZXJuYXRpdmUgdmVyc3VzIGZ1bGwgbW9kZWwKCiAkJAogXGxhbWJkYT0yXGxlZnRbbChcaGF0e1xib2xkc3ltYm9se1xiZXRhfX1fXHRleHR7ZnVsbH0pLTJsKFxoYXR7XGJvbGRzeW1ib2x7XGJldGF9fV9cdGV4dHswfSlccmlnaHRdCiAkJCAKIAogICAgQXN5bXB0b3RpY2FsbHksIHVuZGVyIHRoZSBudWxsIGh5cG90aGVzaXMgaXQgY2FuIGJlIHNob3duIHRoYXQKICAgJCQgTCBcc2ltIFxjaGlfY14yIHwgSF8wLCAkJAogICB3aXRoICRjJCB0aGUgbnVtYmVyIG9mIHBhcmFtZXRlcnMgZHJvcHBlZCBpbiB0aGUgYWx0ZXJuYXRpdmUgbW9kZWwgdmVyc3VzIHRoZSBmdWxsIG1vZGVsLiAKICAgCkxldCAkXG1hdGhiZntDfSQgZGVub3RlIHRoZSAkYyBcdGltZXMgcCQgY29udHJhc3QgbWF0cml4IGRlbm90aW5nIHRoZSBjb250cmFzdCBmb3IgdGhlIHBhcmFtZXRlcnMgYmVpbmcgZHJvcHBlZCwgdGhlIG51bGwgYW5kIGFsdGVybmF0aXZlIGh5cG90aGVzaXMgYXJlIGFzIGluIHRoZSBXYWxkIHRlc3Qgc2V0dGluZzoKICAgJCQgSF8wOiBcbWF0aGJme0N9IFxiZXRhID0gMCQkCiAgICQkIEhfMTogXG1hdGhiZntDfSBcYmV0YSBcbmUgMCQkCiAgIAoKIC0gSXQgaXMgaW1wb3J0YW50IHRvIGtlZXAgaW4gbWluZCB0aGF0IHN0YW5kYXJkIHN0YXRpc3RpY2FsIGluZmVyZW5jZSB0aGVvcnkgaW4gR0xNcyB3b3JrcyAqKmFzeW1wdG90aWNhbGx5IGluIHRlcm1zIG9mIHRoZSBzYW1wbGUgc2l6ZSoqLgoKVGh1cyB3ZSBuZWVkIG1hbnkgZGF0YSBwb2ludHMgaW4gb3JkZXIgZm9yIHRoZSB0aGVvcnkgdG8gaG9sZCBpbiBwcmFjdGljZS4gSW4gb3JkZXIgZm9yIHRoZSAkcCQtdmFsdWVzIHRvIGJlIGNvcnJlY3QsIG91ciBwYXJhbWV0cmljIChkaXN0cmlidXRpb25hbCkgYXNzdW1wdGlvbnMgYXMgd2VsbCBhcyB0aGUgaW5kZXBlbmRlbmNlIGFzc3VtcHRpb24sIG11c3QgYWxzbyBob2xkLgoKIC0gSW4gYnVsayBSTkEtc2VxLCB3ZSBhcmUgb2Z0ZW4gd29ya2luZyB3aXRoIGEgbGltaXRlZCBudW1iZXIgb2Ygc2FtcGxlcyBhbmQgc28gd2UgdHlwaWNhbGx5IGRvIG5vdCBleHBlY3QgYXN5bXB0b3RpYyB0aGVvcnkgdG8gaG9sZCB5ZXQuIEluIHNpbmdsZS1jZWxsIFJOQS1zZXEsIHdlIG9mdGVuIHBlcmZvcm0gc2V2ZXJhbCBwcmVwcm9jZXNzaW5nIHN0ZXBzIGJlZm9yZSBjYWxjdWxhdGluZyAkcCQtdmFsdWVzIGZvciBlYWNoIGdlbmUgYW5kIHNvIHdlIG1heSBiZSAndXNpbmcgdGhlIGRhdGEgbXVsdGlwbGUgdGltZXMnLiBSYXRoZXIgdGhhbiBhdHRhY2hpbmcgc3Ryb25nIHByb2JhYmlsaXN0aWMgaW50ZXJwcmV0YXRpb25zIHRvIHRoZSAkcCQtdmFsdWVzLCB3ZSB0aGVyZWZvcmUgYWR2aWNlIHRvIHZpZXcgdGhlICRwJC12YWx1ZXMgc2ltcGx5IGFzIHVzZWZ1bCBudW1lcmljYWwgc3VtbWFyaWVzIGZvciByYW5raW5nIHRoZSBnZW5lcyBmb3IgZnVydGhlciBpbnNwZWN0aW9uIGluIGdlbm9taWNzIGFwcGxpY2F0aW9ucy4KIApgYGB7ciBlY2hvPUZBTFNFLCBmaWcud2lkdGg9MC41LCBmaWcuY2FwdGlvbj0iRGlmZmVyZW5jZSBiZXR3ZWVuIFdhbGQgYW5kIExSVCB0ZXN0IixmaWcuYWxpZ249J2NlbnRlcid9CmluY2x1ZGVfZ3JhcGhpY3MoIi4vaW1hZ2VzX3NlcXVlbmNpbmcvbGlrVGVzdHMucG5nIikKYGBgCiAKCiMgRWRnZVIKCltNY0NhcnRoeSBhbmQgU215dGgsIDIwMTJdKGh0dHBzOi8vd3d3Lm5jYmkubmxtLm5paC5nb3YvcG1jL2FydGljbGVzL1BNQzMzNzg4ODIvKQoKYGBge3IgZmlnLndpZHRoPS45OSwgZWNobz1GQUxTRX0Ka25pdHI6OmluY2x1ZGVfZ3JhcGhpY3MoIi4vZmlncy9NY0NhcnRoeVNteXRoMjAxMi5wbmciKQpgYGAKCgpgYGB7ciBmaWcud2lkdGg9Ljk5LCBlY2hvPUZBTFNFfQprbml0cjo6aW5jbHVkZV9ncmFwaGljcygiLi9maWdzL01jQ2FydGh5U215dGgyMDEyX3Rlc3RpbmcucG5nIikKYGBgCgojIEVkZ2VSIC0gUXVhc2ktTGlrZWxpaG9vZAoKW0x1bmQgZXQgYWwuIDIwMTJdKGh0dHBzOi8vcHVibGljYXRpb25zLndlaGkuZWR1LmF1L2RvY3VtZW50YXNwZGYvMjU2LnBkZikKCkZvciBxdWFzaS1saWtlbGlob29kIHdlIGRvIG5vdCBzcGVjaWZ5IHRoZSBmdWxsIGRpc3RyaWJ1dGlvbiwgb25seSB0aGUgZmlyc3QgdHdvIG1vbWVudHM6IHRoZSBtZWFuIGFuZCB2YXJpYW5jZS4KCiQkClxsZWZ0XHsKXGJlZ2lue2FycmF5fXtsY2x9CkVbeV97aWd9XHZlcnQgXG1hdGhiZnt4fV97aWd9XSY9JlxtdV97aWd9XFwKbG9nKFxtdV97aWd9KSY9JlxldGFfe2lnfVxcClxldGFfe2lnfSY9JiBcbWF0aGJme3h9X3tpfV5UXGJvbGRzeW1ib2x7XGJldGF9KyBcbG9nIE5faVxcClx0ZXh0e1Zhcn1beV97aWd9XHZlcnQgXG1hdGhiZnt4fV97aWd9XSY9JlxzaWdtYV4yX2dcbGVmdChcbXVfe2lnfStccGhpXG11X3tpZ31eMlxyaWdodCkKXGVuZHthcnJheX1ccmlnaHQuCiQkCgpXZSB3aWxsIGxvb2stdXAgdGhlIGRldGFpbHMgaW4gdGhlIHBhcGVyLiAKCgoKCiMgTGltbWEgLSBWb29tCgpbTGF3IGV0IGFsLiAoMjAxMykuIEdlbm9tZSBCaW9sb2d5XShodHRwczovL2dlbm9tZWJpb2xvZ3kuYmlvbWVkY2VudHJhbC5jb20vYXJ0aWNsZXMvMTAuMTE4Ni9nYi0yMDE0LTE1LTItcjI5KQoKLSBDb3VudCBtb2RlbHMgdnMgdHJhbnNmb3JtYXRpb246IFBvaXNzb24gY291bnRzLCAkXHNxcnQoeSkkICBzdGFiaWxpc2VzIHRoZSB2YXJpYW5jZSwgaW5zdWZmaWNpZW50IGZvciBuZWdhdGl2ZSBiaW5vbWlhbC4gCkxvZyB0cmFuc2Zvcm1hdGlvbjogdGhlIHRyYW5zZm9ybWVkIGRhdGEgYXJlIHN0aWxsIGhldGVyb3NjZWRhc3RpYy4kXHJpZ2h0YXJyb3ckIGxpbW1hLXZvb20KLSBVc2Ugbm9ybWFsaXplZCBsb2ctY3BtIExpbW1hIHBpcGVsaW5lIGZvciBzZXF1ZW5jaW5nCgpQcm9ibGVtOiBjb3VudHMgaGF2ZSBhIG1lYW4gdmFyaWFuY2UgcmVsYXRpb25zaGlwOiBoZXRlcm9zY2VkYXN0aWMKCkhvdyBkbyB3ZSBkZWFsIHdpdGggaGV0ZXJvc2NlZGFzdGljaXR5IGluIHRyYWRpdGlvbmFsIGxpbmVhciBtb2RlbHM/CgpUd28gc3RhZ2UgYXBwcm9hY2g6CgoxLiBTdGFnZSBJCgogIC0gT0xTCiAgLSBFc3RpbWF0ZSB2YXJpYW5jZXMgYXQgZWFjaCBkYXRhIHBvaW50CiAgLSBVc2UgdmFyaWFuY2VzIGFzIHdlaWdodHM6ICRXPVx0ZXh0e2RpYWd9WzEvXGhhdFxzaWdtYV9pXjJdJAoKMi4gU3RhZ2UgSUkgV0xTICRcdGV4dHthcmdtaW59X3tcYm9sZHN5bWJvbHtcYmV0YX19IFx7IChcbWF0aGJme3l9LVxtYXRoYmZ7WH1cYm9sZHN5bWJvbHtcYmV0YX0pXlRcbWF0aGJme1d9IChcbWF0aGJme3l9LVxtYXRoYmZ7WH1cYm9sZHN5bWJvbHtcYmV0YX0pXH0kCgoKUG9ydCB0aGlzIGlkZWEgdG8gUk5BLXNlcSBwaXBlbGluZQoKYGBge3IgZmlnLndpZHRoPS45OSwgZWNobz1GQUxTRX0Ka25pdHI6OmluY2x1ZGVfZ3JhcGhpY3MoIi4vZmlncy9saW1tYVZvb21QYXBlckNodW5rMS5wbmciKQpgYGAKCmBgYHtyIGZpZy53aWR0aD0uOTksIGVjaG89RkFMU0V9CmtuaXRyOjppbmNsdWRlX2dyYXBoaWNzKCIuL2ZpZ3MvbGltbWFWb29tUGFwZXJDaHVuazIucG5nIikKYGBgCgpgYGB7ciBmaWcud2lkdGg9Ljk5LCBlY2hvPUZBTFNFfQprbml0cjo6aW5jbHVkZV9ncmFwaGljcygiLi9maWdzL2xpbW1hVm9vbVBhcGVyRmlnMi5wbmciKQpgYGAKCgoKIyBJbmRlcGVuZGVudCBGaWx0ZXJpbmcKCkluZGVwZW5kZW50IGZpbHRlcmluZyBpcyBhIHN0cmF0ZWd5IHRvIHJlbW92ZSBmZWF0dXJlcyAoaW4gdGhpcyBjYXNlLCBnZW5lcykgcHJpb3IgdG8gdGhlIGFuYWx5c2lzLiBSZW1vdmFsIG9mIHRoZXNlIGZlYXR1cmVzIG1heSBsb3dlciB0aGUgbXVsdGlwbGUgdGVzdGluZyBjb3JyZWN0aW9uIGZvciBvdGhlciBnZW5lcyB0aGF0IHBhc3MgdGhlIGZpbHRlci4gV2UgdHJ5IHRvIHJlbW92ZSBnZW5lcyB0aGF0IGhhdmUgYSBsb3cgcG93ZXIgdG8gYmUgZm91bmQgc3RhdGlzdGljYWxseSBzaWduaWZpY2FudCwgYW5kL29yIHRoYXQgYXJlIGJpb2xvZ2ljYWxseSBsZXNzIHJlbGV2YW50LiAKQSBjb21tb24gZmlsdGVyaW5nIHN0cmF0ZWd5IGlzIHRvIHJlbW92ZSBnZW5lcyB3aXRoIGEgZ2VuZXJhbGx5IGxvdyBleHByZXNzaW9uLCBhcyBsb3cgY291bnRzIGhhdmUgbG93ZXIgcmVsYXRpdmUgdW5jZXJ0YWludHkgKGhlbmNlIGxvd2VyIHN0YXRpc3RpY2FsIHBvd2VyKSwgYW5kIG1heSBiZSBjb25zaWRlcmVkIGJpb2xvZ2ljYWxseSBsZXNzIHJlbGV2YW50LgoKSW1wbGVtZW50YXRpb24gaW4gZWRnZVIuIAoKYGBge3J9Cj9maWx0ZXJCeUV4cHIKYGBgCgpgYGB7cn0Kc3VwcHJlc3NQYWNrYWdlU3RhcnR1cE1lc3NhZ2VzKHsKICBsaWJyYXJ5KGxpbW1hKQogIGxpYnJhcnkoZWRnZVIpCiAgbGlicmFyeShERVNlcTIpCn0pCgpkZHMgPC0gbWFrZUV4YW1wbGVERVNlcURhdGFTZXQoKQpzaW1Db3VudHMgPC1jb3VudHMoZGRzKQpncm91cCA8LSBkZHMkY29uZGl0aW9uCmRnZSA8LSBlZGdlUjo6REdFTGlzdChzaW1Db3VudHMpCmRlc2lnbiA8LSBtb2RlbC5tYXRyaXgofmdyb3VwKQprZWVwIDwtIGZpbHRlckJ5RXhwcihkZ2UsIGRlc2lnbikKdGFibGUoa2VlcCkKYGBgCgpgYGB7cn0KbGliLnNpemUgPC0gZGdlJHNhbXBsZXMkbGliLnNpemUgKiBkZ2Ukc2FtcGxlcyRub3JtLmZhY3RvcnMKY3BtTWluQ291bnQgPC0gMTAvbWVkaWFuKGxpYi5zaXplKSoxZTYKc3VtbWFyeShncm91cCkKbWluU2FtcFNpemUgPC0gbWluKHN1bW1hcnkoZ3JvdXApKQptaW5TYW1wU2l6ZQprZWVwIDwtIHJvd1N1bXMoY3BtKGRnZSkgPiBjcG1NaW5Db3VudCkgPj0gbWluU2FtcFNpemUKdGFibGUoa2VlcCkKYGBgCgpgYGB7cn0KbGV2ZXJhZ2UgPC0gZGVzaWduJSolIHNvbHZlKHQoZGVzaWduKSUqJWRlc2lnbiklKiV0KGRlc2lnbikgJT4lZGlhZygpCjEvbGV2ZXJhZ2UKbWluKDEvbGV2ZXJhZ2UpCmBgYAoKSW5kZXBlbmRlbnQgZmlsdGVyaW5nIGhhcyBiZWVuIGZvcm1hbGl6ZWQgYnkgW0JvdXJnb24gKmV0IGFsLiogKDIwMTApXShodHRwczovL3d3dy5wbmFzLm9yZy9jb250ZW50LzEwNy8yMS85NTQ2KS4KCmBgYHtyLCBlY2hvPUZBTFNFLCBmaWcuY2FwPXBhc3RlKCJGaWd1cmUgMSBmcm9tIEJvdXJnb24gKmV0IGFsLiogKDIwMTApLiIpLCBmaWcud2lkdGg9MC45OX0KIyBBbGwgZGVmYXVsdHMKaW5jbHVkZV9ncmFwaGljcygiLi9pbWFnZXNfc2VxdWVuY2luZy9pbmRlcGVuZGVudEZpbHRlcmluZy5wbmciKQpgYGAKCiAtLS0KClRoZSBjb25jZXB0IG9mIGluZGVwZW5kZW50IGZpbHRlcmluZyBjYW4gYmUgc3VtbWFyaXplZCBhcyBmb2xsb3dzOgoKIC0gRm9yIGVhY2ggZmVhdHVyZSB3ZSBjYWxjdWxhdGUgdHdvIHN0YXRpc3RpY3MsICRTX0YkIGFuZCAkU19UJCwgcmVzcGVjdGl2ZWx5IHVzZWQgZm9yIHR3byBzdGFnZXM6IGZpbHRlcmluZyBhbmQgdGVzdGluZyAoZS5nLiwgZGlmZmVyZW50aWFsIGV4cHJlc3Npb24pLgogLSBJbiBvcmRlciBmb3IgYSBmZWF0dXJlIHRvIGJlIGRlZW1lZCBzaWduaWZpY2FudCwgYm90aCBvZiBpdHMgc3RhdGlzdGljcyBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBzb21lIGN1dC1vZmYuCiAtIFdlIHdhbnQgdG8gY29udHJvbCB0aGUgdHlwZSBJIGVycm9yIHJhdGUgb2YgdGhlIHNlY29uZCBzdGFnZSAodGVzdGluZykuIEJ1dCBub3RlIHRoYXQgKip0aGUgc2Vjb25kIHN0YWdlIGlzIGNvbmRpdGlvbmFsIG9uIHRoZSBmaXJzdCBzdGFnZSoqLCBhcyB3ZSBvbmx5IHRlc3QgZmVhdHVyZXMgcGFzc2luZyB0aGUgZmlsdGVyLCBhbmQgYmFzaWNhbGx5IGlnbm9yZSB0aGUgZmFjdCB0aGF0IGZpbHRlcmluZyB3YXMgcGVyZm9ybWVkLiBJbmRlZWQsIG9uZSBjcml0aWNpc20gaXMgdGhhdCBjb21wdXRpbmcgYW5kIGNvcnJlY3RpbmcgdGhlICRwJC12YWx1ZXMgYXMgaWYgZmlsdGVyaW5nIGhhZCBub3QgYmVlbiBwZXJmb3JtZWQgbWF5IGxlYWQgdG8gb3Zlcm9wdGltaXN0aWMgYWRqdXN0ZWQgJHAkLXZhbHVlcy4KIC0gW0JvdXJnb24gKmV0IGFsLiogKDIwMTApXShodHRwczovL3d3dy5wbmFzLm9yZy9jb250ZW50LzEwNy8yMS85NTQ2KSBzaG93IHRoYXQgZmlsdGVyaW5nIGlzIG9ubHkgYXBwcm9wcmlhdGUgKGkuZS4sIGRvZXMgbm90IGluZmxhdGUgdHlwZSBJIGVycm9yIHJhdGUpIGlmIHRoZSBjb25kaXRpb25hbCBudWxsIGRpc3RyaWJ1dGlvbiBvZiB0ZXN0IHN0YXRpc3RpY3MgZm9yIGZlYXR1cmVzIHBhc3NpbmcgdGhlIGZpbHRlciBpcyB0aGUgc2FtZSBhcyB0aGUgdW5jb25kaXRpb25hbCBudWxsIGRpc3RyaWJ1dGlvbi4gVGhlcmVmb3JlLCAqKmZpbHRlcmluZyBpcyBhcHByb3ByaWF0ZSBpZiB0aGUgc3RhdGlzdGljIHVzZWQgZm9yIGZpbHRlcmluZyBpcyBpbmRlcGVuZGVudCBvZiB0aGUgc3RhdGlzdGljIHVzZWQgZm9yIHRlc3RpbmcgdW5kZXIgdGhlIG51bGwgaHlwb3RoZXNpcyoqLgogCmBgYHtyLCBlY2hvPUZBTFNFLCBmaWcuY2FwPXBhc3RlKCJGaWd1cmUgMiBmcm9tIEJvdXJnb24gKmV0IGFsLiogKDIwMTApLiIpLCBmaWcud2lkdGg9MC45OSxmaWcuYWxpZ249J2NlbnRlcid9CiMgQWxsIGRlZmF1bHRzCmluY2x1ZGVfZ3JhcGhpY3MoIi4vaW1hZ2VzX3NlcXVlbmNpbmcvaW5kZXBlbmRlbnRGaWx0ZXJpbmcyLnBuZyIpCmBgYAogIC0tLQogIApMZXQncyB0cnkgYSBjb3VwbGUgb2YgZXhhbXBsZXMgdG8gZ2V0IHNvbWUgaW50dWl0aW9uIHVzaW5nIHNpbXVsYXRlZCBkYXRhLgoKYGBge3J9CnN1cHByZXNzUGFja2FnZVN0YXJ0dXBNZXNzYWdlcyhsaWJyYXJ5KERFU2VxMikpCnNldC5zZWVkKDI0KQpkZHMgPC0gREVTZXEyOjptYWtlRXhhbXBsZURFU2VxRGF0YVNldCgpCnNpbUNvdW50cyA8LSBjb3VudHMoZGRzKQpncm91cCA8LSBkZHMkY29uZGl0aW9uCmBgYAoKIyMgQSBEZXBlbmRlbnQgVGVzdCBTdGF0aXN0aWMKCmBgYHtyfQpmaWx0ZXJTdGF0RWZmZWN0U2l6ZSA8LSBhYnMocm93TWVhbnMoc2ltQ291bnRzWyxncm91cCA9PSAiQSJdKSAtIHJvd01lYW5zKHNpbUNvdW50c1ssZ3JvdXAgPT0gIkIiXSkpCnRlc3RTdGF0IDwtIGdlbmVmaWx0ZXI6OnJvd3R0ZXN0cyhzaW1Db3VudHMsIGdyb3VwKQoKIyMgdW5jb25kaXRpb25hbCBkaXN0cmlidXRpb24KcGxvdChkZW5zaXR5KHRlc3RTdGF0JHN0YXRpc3RpYywgbmEucm09VFJVRSksCiAgICAgeGxhYiA9ICJUZXN0IHN0YXRpc3RpYyIsCiAgICAgbWFpbiA9ICJVbmNvbmRpdGlvbmFsIGRpc3RyaWJ1dGlvbiIpCgojIyBjb25kaXRpb25hbCBkaXN0cmlidXRpb246IHZlcnkgZGlmZmVyZW50IQptZWFuKGZpbHRlclN0YXRFZmZlY3RTaXplID4gMSkKaGlzdChmaWx0ZXJTdGF0RWZmZWN0U2l6ZSwgYnJlYWtzPTQwKQphYmxpbmUodj0xLCBjb2w9InJlZCIpCmtlZXBFZmZlY3RTaXplIDwtIGZpbHRlclN0YXRFZmZlY3RTaXplID4gMQpwbG90KGRlbnNpdHkodGVzdFN0YXQkc3RhdGlzdGljW2tlZXBFZmZlY3RTaXplXSwgbmEucm09VFJVRSksCiAgICAgeGxhYiA9ICJUZXN0IHN0YXRpc3RpYyIsCiAgICAgbWFpbiA9ICJDb25kaXRpb25hbCBkaXN0cmlidXRpb24iKQpgYGAKCgojIyBBbiBJbmRlcGVuZGVudCBUZXN0IFN0YXRpc3RpYwoKYGBge3J9CmZpbHRlclN0YXRHbG9iYWxNZWFuIDwtIHJvd01lYW5zKHNpbUNvdW50cykKbWVhbihmaWx0ZXJTdGF0R2xvYmFsTWVhbiA+IDUpICMgd2UgcmVtb3ZlIGEgc2ltaWxhciBmcmFjdGlvbgprZWVwR2xvYmFsTWVhbiA8LSBmaWx0ZXJTdGF0R2xvYmFsTWVhbiA+IDUKCiMjIHVuY29uZGl0aW9uYWwgZGlzdHJpYnV0aW9uCnBsb3QoZGVuc2l0eSh0ZXN0U3RhdCRzdGF0aXN0aWMsIG5hLnJtPVRSVUUpLAogICAgIHhsYWIgPSAiVGVzdCBzdGF0aXN0aWMiLAogICAgIG1haW4gPSAiVW5jb25kaXRpb25hbCBkaXN0cmlidXRpb24iKQoKIyMgY29uZGl0aW9uYWwgZGlzdHJpYnV0aW9uOiB0aGUgc2FtZS4KcGxvdChkZW5zaXR5KHRlc3RTdGF0JHN0YXRpc3RpY1trZWVwR2xvYmFsTWVhbl0sIG5hLnJtPVRSVUUpLAogICAgIHhsYWIgPSAiVGVzdCBzdGF0aXN0aWMiLAogICAgIG1haW4gPSAiQ29uZGl0aW9uYWwgZGlzdHJpYnV0aW9uIikKYGBgCgoKIyBOb3JtYWxpemF0aW9uCgpOb3JtYWxpemF0aW9uIGlzIG5lY2Vzc2FyeSB0byBjb3JyZWN0IGZvciBzZXZlcmFsIHNvdXJjZXMgb2YgdGVjaG5pY2FsIHZhcmlhdGlvbjoKCiAtICoqRGlmZmVyZW5jZXMgaW4gc2VxdWVuY2luZyBkZXB0aCoqIGJldHdlZW4gc2FtcGxlcy4gU29tZSBzYW1wbGVzIGdldCBzZXF1ZW5jZWQgZGVlcGVyIGluIHRoZSBzZW5zZSB0aGF0IHRoZXkgY29uc2lzdCBvZiBtb3JlIChtYXBwZWQpIHJlYWRzIGFuZCB0aGVyZWZvcmUgY2FuIGJlIGNvbnNpZGVyZWQgdG8gY29udGFpbiBhIGhpZ2hlciBhbW91bnQgb2YgaW5mb3JtYXRpb24sIHdoaWNoIHdlIHNob3VsZCBiZSB0YWtpbmcgaW50byBhY2NvdW50LiBJbiBhZGRpdGlvbiwgaWYgYSBzYW1wbGUgaXMgc2VxdWVuY2VkIGRlZXBlciwgaXQgaXMgbmF0dXJhbCB0aGF0IHRoZSBjb3VudHMgZm9yIGVhY2ggZ2VuZSB3aWxsIGJlIGhpZ2hlciwgamVvcGFyZGl6aW5nIGEgZGlyZWN0IGNvbXBhcmlzb24gb2YgdGhlIGV4cHJlc3Npb24gY291bnRzLgogLSAqKkRpZmZlcmVuY2VzIGluIFJOQSBwb3B1bGF0aW9uIGNvbXBvc2l0aW9uKiogYmV0d2VlbiBzYW1wbGVzLiBBcyBhbiBleHRyZW1lIGV4YW1wbGUsIHN1cHBvc2UgdGhhdCB0d28gc2FtcGxlcyBoYXZlIGJlZW4gc2VxdWVuY2VkIHRvIHRoZSBleGFjdCBzYW1lIGRlcHRoLiBPbmUgc2FtcGxlIGlzIGNvbnRhbWluYXRlZCBhbmQgaGFzIGEgdmVyeSBoaWdoIGNvbmNlbnRyYXRpb24gb2YgdGhlIGNvbnRhbWluYW50IGNETkEgYmVpbmcgc2VxdWVuY2VkLCBidXQgb3RoZXJ3aXNlIHRoZSB0d28gc2FtcGxlcyBhcmUgaWRlbnRpY2FsLiBTaW5jZSB0aGUgY29udGFtaW5hbnQgd2lsbCBiZSB0YWtpbmcgdXAgYSBzaWduaWZpY2FudCBwcm9wb3J0aW9uIG9mIHRoZSByZWFkcyBiZWluZyBzZXF1ZW5jZWQsIHRoZSBjb3VudHMgd2lsbCBub3QgYmUgZGlyZWN0bHkgY29tcGFyYWJsZSBiZXR3ZWVuIHRoZSBzYW1wbGVzLiBIZW5jZSwgd2UgbWF5IGFsc28gd2FudCB0byBjb3JyZWN0IGZvciBkaWZmZXJlbmNlcyBpbiB0aGUgY29tcG9zaXRpb24gb2YgdGhlIFJOQSBwb3B1bGF0aW9uIG9mIHRoZSBzYW1wbGVzLgogLSAqKk90aGVyIHRlY2huaWNhbCB2YXJpYXRpb24qKiBzdWNoIGFzIHNhbXBsZS1zcGVjaWZpYyBHQy1jb250ZW50IG9yIHRyYW5zY3JpcHQgbGVuZ3RoIGVmZmVjdHMgbWF5IGFsc28gYmUgYWNjb3VudGVkIGZvci4KIAogCmBgYHtyfQpkYXRhKCJwYXJhdGh5cm9pZEdlbmVzU0UiLCBwYWNrYWdlPSJwYXJhdGh5cm9pZFNFIikKc2UxIDwtIHBhcmF0aHlyb2lkR2VuZXNTRQpybShwYXJhdGh5cm9pZEdlbmVzU0UpCgpjb2xEYXRhKHNlMSkgJT4lIAogIGFzLmRhdGEuZnJhbWUoKSAlPiUgCiAgZmlsdGVyKGR1cGxpY2F0ZWQoZXhwZXJpbWVudCkpIApgYGAKClRoZXJlIGFyZSB0ZWNobmljYWwgcmVwZWF0cyBpbiB0aGUgZGF0YS4gCgpXZSBtZW50aW9uZWQgcHJldmlvdXMgbGVjdHVyZXMgdGhhdCB3ZSBjYW4gc3VtIG92ZXIgdGVjaG5pY2FsIHJlcGVhdHMsIGJlY2F1c2UgdGVjaGljYWwgcmVwZWF0cyBhcmUgUG9pc3NvbiBhbmQgdGhlIHN1bSBvZiB0d28gUG9pc3NvbiB2YXJpYWJsZXMgaXMgYWdhaW4gUG9pc3Nvbi4gCgpgYGB7cn0KZHVwRXhwcyA8LSBjb2xEYXRhKHNlMSkgJT4lIAogIGFzLmRhdGEuZnJhbWUoKSAlPiUgCiAgZmlsdGVyKGR1cGxpY2F0ZWQoZXhwZXJpbWVudCkpICAlPiUgCiAgcHVsbChleHBlcmltZW50KQoKY291bnRzIDwtIGFzc2F5cyhzZTEpJGNvdW50cwpuZXdDb3VudHMgPC0gY291bnRzCmNkIDwtIGNvbERhdGEoc2UxKQpmb3Ioc3MgaW4gMTpsZW5ndGgoZHVwRXhwcykpewogICMgY2hlY2sgd2hpY2ggc2FtcGxlcyBhcmUgZHVwbGljYXRlcwogIHJlbGV2YW50SWQgPC0gd2hpY2goY29sRGF0YShzZTEpJGV4cGVyaW1lbnQgPT0gZHVwRXhwc1tzc10pCiAgIyBzdW0gY291bnRzCiAgbmV3Q291bnRzWyxyZWxldmFudElkWzFdXSA8LSByb3dTdW1zKGNvdW50c1sscmVsZXZhbnRJZF0pCiAgIyBrZWVwIHdoaWNoIGNvbHVtbnMgLyByb3dzIHRvIHJlbW92ZS4KICBpZihzcyA9PSAxKXsKICAgIHRvUmVtb3ZlIDwtIHJlbGV2YW50SWRbMl0KICB9IGVsc2UgewogICAgdG9SZW1vdmUgPC0gYyh0b1JlbW92ZSwgcmVsZXZhbnRJZFsyXSkKICB9Cn0KCiMgcmVtb3ZlIGFmdGVyIHN1bW1pbmcgY291bnRzIChvdGhlcndpc2UgSURzIGdldCBtaXhlZCB1cCkKbmV3Q291bnRzIDwtIG5ld0NvdW50c1ssLXRvUmVtb3ZlXQpuZXdDRCA8LSBjZFstdG9SZW1vdmUsXQoKIyBDcmVhdGUgbmV3IFN1bW1hcml6ZWRFeHBlcmltZW50CnNlIDwtIFN1bW1hcml6ZWRFeHBlcmltZW50KGFzc2F5cyA9IGxpc3QoImNvdW50cyIgPSBuZXdDb3VudHMpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sRGF0YSA9IG5ld0NELAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0YWRhdGEgPSBtZXRhZGF0YShzZTEpKQoKdHJlYXRtZW50IDwtIGNvbERhdGEoc2UpJHRyZWF0bWVudAp0YWJsZSh0cmVhdG1lbnQpCmBgYAoKYGBge3J9CnFwbG90KGNvbFN1bXMoYXNzYXlzKHNlKSRjb3VudHMpLzFlNiwgZ2VvbT0iaGlzdG9ncmFtIiwgYmlucz0xMCxjb2w9ImJsYWNrIikgKwogIHRoZW1lKGxlZ2VuZC5wb3NpdGlvbiA9ICJub25lIikgKwogIHhsYWIoImxpYnNpemUgKG1pbGxpb24gcmVhZHMpIikKCnFwbG90KAogIGNvbERhdGEoc2UpJHRyZWF0bWVudDpjb2xEYXRhKHNlKSR0aW1lLAogIGNvbFN1bXMoYXNzYXlzKHNlKSRjb3VudHMpLzFlNixnZW9tPSJib3hwbG90IgogICkgKwogIHhsYWIoInRyZWF0bWVudCIpKwogIHlsYWIoImxpYnNpemUgKG1pbGxpb24gcmVhZHMpIikKCnFwbG90KAogIGNvbERhdGEoc2UpJHBhdGllbnQsCiAgY29sU3Vtcyhhc3NheXMoc2UpJGNvdW50cykvMWU2LGdlb209ImJveHBsb3QiCiAgKSArCiAgeGxhYigiUGF0aWVudCIpKwogIHlsYWIoImxpYnNpemUgKG1pbGxpb24gcmVhZHMpIikKYGBgCgpgYGB7cn0KbWEyU2FtcCA8LSBmdW5jdGlvbihjb3VudE14LGxpYlNpemU9TlVMTCkgewpzdG9waWZub3QoImBjb3VudE14YCBpcyBub3QgYSBtYXRyaXggd2l0aCB0d28gY29sdW1ucyIgPSBuY29sKGNvdW50TXgpID09IDIpCkEgPC0gY291bnRNeCAlPiUgbG9nMiAlPiUgcm93TWVhbnMKaWYoaXMubnVsbChsaWJTaXplKSkgCiAgTSA8LSBjb3VudE14ICU+JSBsb2cyICU+JSBhcHBseSguLDEsZGlmZikgCmVsc2UgCiAgTSA8LSBjb3VudE14ICU+JSBsb2cyICU+JSBhcHBseSguLDEsZGlmZikgLSBsaWJTaXplICU+JSBsb2cyICU+JSBkaWZmCncgPC0gY291bnRNeFssMV09PW1pbihjb3VudE14WywxXSkgfCBjb3VudE14WywyXT09bWluKGNvdW50TXhbLDJdKQppZiAoYW55KHcpKSB7CiAgICAgICAgICAgIEFbd10gPC0gcnVuaWYoc3VtKHcpLCBtaW4gPSAtMSwgbWF4ID0gLjEpCiAgICAgICAgICAgIE1bd10gPC0gbG9nMihjb3VudE14W3csMl0gKyAxKSAtIGxvZzIoY291bnRNeFt3LDFdICsgMSkKfQpNQXBsb3QgPC0gcXBsb3QoQSwgTSwgY29sPXcpICsKICB0aGVtZShsZWdlbmQucG9zaXRpb24gPSAibm9uZSIpICsgCiAgc2NhbGVfY29sb3JfbWFudWFsKHZhbHVlcyA9IGMoImJsYWNrIiwib3JhbmdlIikpICsKICB4bGFiKCJBOiBsb2cyIEF2ZXJhZ2UiKSArCiAgeWxhYigiTTogbG9nMiBGb2xkIENoYW5nZSIpCgpNQXBsb3QgKwogIGdlb21fYWJsaW5lKGludGVyY2VwdD0wLHNsb3BlPTAsY29sPSJibHVlIikgKwogIGdlb21fYWJsaW5lKGludGVyY2VwdD1tZWRpYW4oTVshd10sbmEucm09VFJVRSksc2xvcGU9MCxjb2w9InJlZCIpCn0KYGBgCgpMZXTigJlzIHRha2UgYSBsb29rIGF0IGhvdyBjb21wYXJhYmxlIGRpZmZlcmVudCByZXBsaWNhdGVzIGFyZSBpbiB0aGUgQ29udHJvbCBjb25kaXRpb24gYXQgNDhoIGluIG91ciBkYXRhc2V0LiBXZSB3aWxsIGludmVzdGlnYXRlIHRoaXMgdXNpbmcgTUQtcGxvdHMgKG1lYW4tZGlmZmVyZW5jZSBwbG90cyBhcyBpbnRyb2R1Y2VkIGJ5IER1ZG9pdCBldCBhbC4gKDIwMDIpKSwgYWxzbyBzb21ldGltZXMgcmVmZXJyZWQgdG8gYXMgTUEtcGxvdHMuCgpgYGB7cn0KaWRzIDwtIHdoaWNoKGNvbERhdGEoc2UpJHRyZWF0bWVudCA9PSJDb250cm9sIiAmIGNvbERhdGEoc2UpJHRpbWUgPT0gIjQ4aCIpCmlkcwpjb2xTdW1zKGFzc2F5cyhzZSkkY291bnRzWyxpZHNdKSAvIDFlNgpgYGAKCmBgYHtyfQpwYWlyQ29tYiA8LSBjb21ibigKICBpZHMsIAogIG09MikKcGxvdHMgPC0gYXBwbHkocGFpckNvbWIsMixmdW5jdGlvbih4KSBtYTJTYW1wKGFzc2F5KHNlKVsseF0pICsgZ2d0aXRsZShwYXN0ZSgic2FtcGxlcyIseFsyXSwidnMiLCB4WzFdKSkpCmRvLmNhbGwoImdyaWQuYXJyYW5nZSIsYyhwbG90cyxuY29sPTMpKQpgYGAKCldlIHNlZSBjbGVhciBiaWFzIGZvciBzb21lIHBhaXJ3aXNlIGNvbXBhcmlzb25zLiBGb3IgZXhhbXBsZSwgaW4gdGhlIGZpcnN0IHBsb3QgY29tcGFyaW5nIHNhbXBsZSA4IHZlcnN1cyBzYW1wbGUgMiwgdGhlIGxvZyBmb2xkLWNoYW5nZXMgYXJlIGJpYXNlZCBkb3dud2FyZHMuIFRoaXMgbWVhbnMgdGhhdCwgb24gYXZlcmFnZSwgYSBnZW5lIGlzIGxvd2VyIGV4cHJlc3NlZCBpbiBzYW1wbGUgOCB2ZXJzdXMgc2FtcGxlIDIuIExvb2tpbmcgYXQgdGhlIGxpYnJhcnkgc2l6ZXMsIHdlIGNhbiBpbmRlZWQgc2VlIHRoYXQgdGhlIGxpYnJhcnkgc2l6ZSBmb3Igc2FtcGxlIDIgaXMgYWJvdXQgJDExw5cxMF42JCB3aGlsZSBpdCBpcyBvbmx5IGFib3V0ICQ3w5cxMF42JCBmb3Igc2FtcGxlIDghIFRoaXMgaXMgYSBjbGVhciBsaWJyYXJ5IHNpemUgZWZmZWN0IHRoYXQgd2Ugc2hvdWxkIHRha2UgaW50byBhY2NvdW50LgoKCldlIGNhbiBzb2x2ZSB0aGVzZSBpc3N1ZXMgYnkgaW50cm9kdWNpbmcgb2Zmc2V0cyBpbiBvdXIgbW9kZWwuCgokJAogIFxsZWZ0XHsKICBcYmVnaW57YXJyYXl9e2NjY30KICBZX3tnaX0gJiBcc2ltICYgUG9pKFxtdV97Z2l9KSBcXAogIFxsb2cgXG11X3tnaX0gJiA9ICYgXGV0YV97Z2l9IFxcCiAgXGV0YV97Z2l9ICYgPSAmIFxtYXRoYmZ7WH1eVF9pIFxiZXRhX2cgKyBsb2coT197Z2l9KSBcXAogIFxlbmR7YXJyYXl9CiAgXHJpZ2h0LgogICQkCiAgCgpgYGB7cn0KbGliU2l6ZSA8LSBjb2xTdW1zKGFzc2F5KHNlKSkKcGxvdHMyIDwtIGFwcGx5KHBhaXJDb21iLDIsZnVuY3Rpb24oeCkgbWEyU2FtcChhc3NheShzZSlbLHhdLGxpYlNpemUgPSBsaWJTaXplW3hdKSArIGdndGl0bGUocGFzdGUoInNhbXBsZXMiLHhbMl0sInZzIiwgeFsxXSkpKQpkby5jYWxsKCJncmlkLmFycmFuZ2UiLGMocGxvdHMyLG5jb2w9MykpCmBgYAoKIyMgVE1NIG1ldGhvZCAoZGVmYXVsdCBvZiBgZWRnZVJgKQoKW1JvYmluc29uIGFuZCBPc2hsYWNrICgyMDEwKS4gR2Vub21lIEJpb2xvZ3ldKGh0dHBzOi8vZ2Vub21lYmlvbG9neS5iaW9tZWRjZW50cmFsLmNvbS9hcnRpY2xlcy8xMC4xMTg2L2diLTIwMTAtMTEtMy1yMjUpCgpgYGB7ciBmaWcud2lkdGg9MC41LCBmaWcuYWxpZ249J2NlbnRlcicsIGZpZy5jYXA9PSIgUm9iaW5zb24gYW5kIE9zaGxhY2sgKDIwMTApLiBHZW5vbWUgQmlvbG9neS4ifQprbml0cjo6aW5jbHVkZV9ncmFwaGljcygiLi9maWdzL2VkZ2VSTm9ybUludHJvLnBuZyIpCmBgYAoKLSBPbiB0aGUgcGxvdCB3ZSBzZWUgYSBjbGVhciBlZmZlY3Qgb24gYWxsIGdlbmVzCi0gQ29ycmVjdGluZyBmb3IgbGlicmFyeSBzaXplIHRlbmRzIHRvIG92ZXIgY29ycmVjdC4gCi0gU29tZSBERSBnZW5lcyBhcmUgaGlnaGx5IGFidW5kYW50IGFuZCBkZXRlcm1pbmUgdGhlIGxpYnJhcnkgc2l6ZSB0byBhIGxhcmdlIGV4dGVuZAoKVGhlIHRyaW1tZWQgbWVhbiBvZiBNLXZhbHVlcyAoVE1NKSBtZXRob2QgaW50cm9kdWNlZCBieSBbUm9iaW5zb24gJiBPc2hsYWNrICgyMDEwKV0oaHR0cHM6Ly9nZW5vbWViaW9sb2d5LmJpb21lZGNlbnRyYWwuY29tL2FydGljbGVzLzEwLjExODYvZ2ItMjAxMC0xMS0zLXIyNSkgaXMgYSBub3JtYWxpemF0aW9uIHByb2NlZHVyZSB0aGF0IGNhbGN1bGF0ZXMgYSBzaW5nbGUgbm9ybWFsaXphdGlvbiBmYWN0b3IgZm9yIGVhY2ggc2FtcGxlLiBBcyB0aGUgbmFtZSBzdWdnZXN0cywgaXQgaXMgYmFzZWQgb24gYSB0cmltbWVkIG1lYW4gb2YgZm9sZC1jaGFuZ2VzICgkTSQtdmFsdWVzKSBhcyB0aGUgc2NhbGluZyBmYWN0b3IuIEEgdHJpbW1lZCBtZWFuIGlzIGFuIGF2ZXJhZ2UgYWZ0ZXIgcmVtb3ZpbmcgYSBzZXQgb2YgYGBleHRyZW1lJycgdmFsdWVzLiAKU3BlY2lmaWNhbGx5LCBUTU0gY2FsY3VsYXRlcyBhIG5vcm1hbGl6YXRpb24gZmFjdG9yICRGX2leeyhyKX0kIGFjcm9zcyBnZW5lcyAkZyQgZm9yIGVhY2ggc2FtcGxlICRpJCBhcyBjb21wYXJlZCB0byBhIHJlZmVyZW5jZSBzYW1wbGUgJHIkLAokJApcbG9nXzIoRl9pXnsocil9KSA9IFxmcmFje1xzdW1fe2cgXGluIHtcY2FsIEd9Xip9IHdfe2dpfV5yIE1fe2dpfV5yfXtcc3VtX3tnIFxpbiB7XGNhbCBHfV4qfSB3X3tnaX1ecn0sCiQkCndoZXJlICRNX3tnaX1eciQgcmVwcmVzZW50cyB0aGUgJFxsb2dfMiQtZm9sZC1jaGFuZ2Ugb2YgdGhlIGdlbmUgZXhwcmVzc2lvbiBmcmFjdGlvbiBhcyBjb21wYXJlZCB0byBhIHJlZmVyZW5jZSBzYW1wbGUgJHIkLCBpLmUuLAokJCBNX3tnaX1eciA9IFxsb2dfMlxsZWZ0KCBcZnJhY3tZX3tnaX0gLyBOX2l9eyBZX3tncn0gLyBOX3J9IFxyaWdodCksICQkCmFuZCAkd197Z2l9XnIkIHJlcHJlc2VudHMgYSBwcmVjaXNpb24gd2VpZ2h0IGNhbGN1bGF0ZWQgYXMKJCQKIHdfe2dpfV5yID0gXGZyYWN7Tl9pIC0gWV97Z2l9fXtOX2kgWV97Z2l9fSArIFxmcmFje05fciAtIFlfe2dyfX17Tl9yIFlfe2dyfX0sCiQkCmFuZCAke1xjYWwgR31eKiQgcmVwcmVzZW50cyB0aGUgc2V0IG9mIGdlbmVzIGFmdGVyIHRyaW1taW5nIHRob3NlIHdpdGggdGhlIG1vc3QgZXh0cmVtZSBhdmVyYWdlIGV4cHJlc3Npb24uIFRoZSB3ZWlnaHRzIHNlcnZlIHRvIGFjY291bnQgZm9yIHRoZSBmYWN0IHRoYXQgZm9sZC1jaGFuZ2VzIGZvciBnZW5lcyB3aXRoIGxvd2VyIHJlYWQgY291bnRzIGFyZSBtb3JlIHZhcmlhYmxlLgoKVGhlIHByb2NlZHVyZSBvbmx5IHRha2VzIGdlbmVzIGludG8gYWNjb3VudCB3aGVyZSBib3RoICRZX3tnaX0+MCQgYW5kICRZX3tncn0+MCQuIEJ5IGRlZmF1bHQsIFRNTSB0cmltcyBnZW5lcyB3aXRoIHRoZSAkMzBcJSQgbW9zdCBleHRyZW1lICRNJC12YWx1ZXMgYW5kICQ1XCUkIG1vc3QgZXh0cmVtZSBhdmVyYWdlIGdlbmUgZXhwcmVzc2lvbiwgYW5kIGNob29zZXMgYXMgcmVmZXJlbmNlICRyJCB0aGUgc2FtcGxlIHdob3NlIHVwcGVyLXF1YXJ0aWxlIGlzIGNsb3Nlc3QgdG8gdGhlIGFjcm9zcy1zYW1wbGUgYXZlcmFnZSB1cHBlci1xdWFydGlsZS4gVGhlIG5vcm1hbGl6ZWQgY291bnRzIGFyZSB0aGVuIGdpdmVuIGJ5ICRcdGlsZGV7WX1fe2dpfSA9IFlfe2dpfSAvIE5faV5zJCwgd2hlcmUgCiQkTl9pXnMgPSBcZnJhY3tOX2kgRl9pXnsocil9fXtcc3VtX3tpPTF9Xm4gTl9pIEZfaV57KHIpfS9ufS4kJAoKVE1NIG5vcm1hbGl6YXRpb24gbWF5IGJlIHBlcmZvcm1lZCBmcm9tIHRoZSBgY2FsY05vcm1GYWN0b3JzYCBmdW5jdGlvbiBpbXBsZW1lbnRlZCBpbiBgZWRnZVJgOgoKYGBge3J9CmRnZSA8LSBlZGdlUjo6Y2FsY05vcm1GYWN0b3JzKHNlKQpkZ2Ukc2FtcGxlcyAjbm9ybWFsaXphdGlvbiBmYWN0b3JzIGFkZGVkIHRvIGNvbERhdGEKYGBgCgpMZXQncyBjaGVjayBob3cgb3VyIE1ELXBsb3RzIGxvb2sgbGlrZSBhZnRlciBub3JtYWxpemF0aW9uLiBOb3RlIHRoYXQsIHdlIGNhbiByZXdyaXRlIHRoZSBHTE0gYXMKJCQgXGxvZ1xsZWZ0KCBcZnJhY3tcbXVfe2dpfX17Tl9pXnN9IFxyaWdodCkgPSBcbWF0aGJme1h9X2leVCBcYmV0YV9nICQkCmFuZCBzbyAkXGZyYWN7XG11X3tnaX19e05faV5zfSQgY2FuIGJlIGNvbnNpZGVyZWQgYXMgYW4gJ29mZnNldC1jb3JyZWN0ZWQgY291bnQnLgoKV2Ugc2VlIHRoYXQgYWxsIE1ELXBsb3RzIGFyZSBub3cgbmljZWx5IGNlbnRlcmVkIGFyb3VuZCBhIGxvZy1mb2xkLWNoYW5nZSBvZiB6ZXJvIQoKYGBge3J9CiMjIG5vcm1hbGl6ZQplZmZMaWJTaXplIDwtIGRnZSRzYW1wbGVzJGxpYi5zaXplICogZGdlJHNhbXBsZXMkbm9ybS5mYWN0b3JzCiNub3JtQ291bnRUTU0gPC0gc3dlZXAoYXNzYXlzKHNlKSRjb3VudHMsIDIsIEZVTj0iLyIsIGVmZkxpYlNpemUpCgpwbG90c05vcm0gPC0gYXBwbHkocGFpckNvbWIsMixmdW5jdGlvbih4KSAKICBtYTJTYW1wKGFzc2F5cyhzZSkkY291bnRzWyx4XSwgZWZmTGliU2l6ZVt4XSkgKyBnZ3RpdGxlKHBhc3RlKCJzYW1wbGVzIix4WzJdLCJ2cyIsIHhbMV0pKSkKZG8uY2FsbCgiZ3JpZC5hcnJhbmdlIixjKHBsb3RzTm9ybSxuY29sPTMpKQpgYGAKCgojIyBNZWRpYW4tb2YtUmF0aW9zIE1ldGhvZCAoZGVmYXVsdCBvZiBgREVTZXEyYCkKClRoZSBtZWRpYW4tb2YtcmF0aW9zIG1ldGhvZCBpcyB1c2VkIGluIGBERVNlcTJgIGFzIGRlc2NyaWJlZCBpbiBbTG92ZSAqZXQgYWwuKiAoMjAxNCldKGh0dHBzOi8vZ2Vub21lYmlvbG9neS5iaW9tZWRjZW50cmFsLmNvbS9hcnRpY2xlcy8xMC4xMTg2L3MxMzA1OS0wMTQtMDU1MC04KS4KSXQgYXNzdW1lcyB0aGF0IHRoZSBleHBlY3RlZCB2YWx1ZSAkXG11X3tnaX0gPSBFKFlfe2dpfSkkIGlzIHByb3BvcnRpb25hbCB0byB0aGUgdHJ1ZSBleHByZXNzaW9uIG9mIHRoZSBnZW5lLCAkcV97Z2l9JCwgc2NhbGVkIGJ5IGEgbm9ybWFsaXphdGlvbiBmYWN0b3IgJHNfe2l9JCBmb3IgZWFjaCBzYW1wbGUsCiQkIFxtdV97Z2l9ID0gc197aX1xX3tnaX0uICQkCgpUaGUgbm9ybWFsaXphdGlvbiBmYWN0b3IgJHNfe2l9JCBpcyB0aGVuIGVzdGltYXRlZCB1c2luZyB0aGUgbWVkaWFuLW9mLXJhdGlvcyBtZXRob2QgY29tcGFyZWQgdG8gYSBzeW50aGV0aWMgcmVmZXJlbmNlIHNhbXBsZSAkciQgZGVmaW5lZCBiYXNlZCBvbiBnZW9tZXRyaWMgbWVhbnMgb2YgY291bnRzIGFjcm9zcyBzYW1wbGVzCiQkCnNfaSA9IFx0ZXh0e21lZGlhbn1fe1x7e2c6WV57Kn1fe2dyfSBcbmUgMH1cfX0gXGZyYWN7WV97Z2l9fXtZXnsqfV97Z3J9fSwKJCQKd2l0aCAKJCQgWV57Kn1fe2dyfSA9IFxsZWZ0KCBccHJvZF97aT0xfV5uIFlfe2dpfSBccmlnaHQpXnsxL259LiAkJAoKV2UgY2FuIHRoZW4gdXNlIHRoZSBzaXplIGZhY3RvcnMgJHNfaSQgYXMgb2Zmc2V0cyB0byB0aGUgR0xNLgoKTWVkaWFuLW9mLXJhdGlvcyBub3JtYWxpemF0aW9uIGlzIGltcGxlbWVudGVkIGluIHRoZSBgREVTZXEyYCBwYWNrYWdlOgoKYGBge3J9CmRkcyA8LSBERVNlcTI6OkRFU2VxRGF0YVNldEZyb21NYXRyaXgoY291bnREYXRhID0gYXNzYXlzKHNlKSRjb3VudHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sRGF0YSA9IGNvbERhdGEoc2UpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2lnbiA9IH4gMSkgI2p1c3QgYWRkIGludGVyY2VwdCB0byBzaG93Y2FzZSBub3JtYWxpemF0aW9uCmRkcyA8LSBERVNlcTI6OmVzdGltYXRlU2l6ZUZhY3RvcnMoZGRzKQpzaXplRmFjdG9ycyhkZHMpCmBgYAoKWW91IG1heSBhbHNvIHdhbnQgdG8gY2hlY2sgb3V0IHRoZSBbU3RhdFF1ZXN0IHZpZGVvIG9uIERFU2VxMiBub3JtYWxpemF0aW9uXShodHRwczovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PVVGQjk5M3h1ZlVVKS4KCiMjIyBDb21wYXJpbmcgVE1NIHdpdGggREVTZXEyIE5vcm1hbGl6YXRpb24KCldlIGNhbiBjb21wYXJlIHRoZSBzaXplIGZhY3RvcnMgZm9yIGJvdGggbm9ybWFsaXphdGlvbnMgdG8gdmVyaWZ5IGlmIHRoZXkgYWdyZWUgb24gdGhlIG5vcm1hbGl6YXRpb24gZmFjdG9ycy4gTm90ZSB3ZSBuZWVkIHRvIHNjYWxlIHRoZSBlZmZlY3RpdmUgbGlicmFyeSBzaXplcyBmcm9tIGBlZGdlUmAgdG8gZW5mb3JjZSBhIHNpbWlsYXIgc2NhbGUgYXMgdGhlIHNpemUgZmFjdG9ycyBmcm9tIGBERVNlcTJgLiBXaGlsZSBiZWxvdyB3ZSBhcmUgdXNpbmcgYW4gYXJpdGhtZXRpYyBtZWFuLCBhIGdlb21ldHJpYyBtZWFuIG1heSBiZSB1c2VkIGFzIHdlbGwsIHdoaWNoIHdpbGwgYmUgbW9yZSByb2J1c3QgdG8gb3V0bHlpbmcgZWZmZWN0aXZlIGxpYnJhcnkgc2l6ZXMuCgpgYGB7cn0KcGxvdChlZmZMaWJTaXplIC8gbWVhbihlZmZMaWJTaXplKSwgc2l6ZUZhY3RvcnMoZGRzKSwKICAgICB4bGFiID0gImVkZ2VSIHNpemUgZmFjdG9yIiwKICAgICB5bGFiID0gIkRFU2VxMiBzaXplIGZhY3RvciIpCmBgYAoKIyBBbGlhc2luZwoKU3VwcG9zZSB3ZSBhcmUgd29ya2luZyB3aXRoIHRoZSBmb2xsb3dpbmcgZXhwZXJpbWVudGFsIGRlc2lnbiBvbiBjb2xvbiBjYW5jZXIuIFN0dWR5aW5nIHRoZSBlZmZlY3Qgb2YgYSBkcnVnIG9uIGdlbmUgZXhwcmVzc2lvbiwgcmVzZWFyY2hlcnMgZ2F0aGVyIFJOQS1zZXEgZGF0YSBmcm9tIGZvdXIgY29sb24gY2FuY2VyIHBhdGllbnRzIGFuZCBmb3VyIGhlYWx0aHkgaW5kaXZpZHVhbHMuIEZvciBlYWNoIGluZGl2aWR1YWwsIHRoZXkgb2J0YWluIFJOQS1zZXEgZGF0YSBmcm9tIGEgYmxvb2Qgc2FtcGxlIGJlZm9yZSBhcyB3ZWxsIGFzIHR3byB3ZWVrcyBhZnRlciB0YWtpbmcgYSBkYWlseSBkb3NlIG9mIHRoZSBkcnVnLiBUaGUgcmVzZWFyY2ggcXVlc3Rpb24gcmVsYXRlcyB0byBkaWZmZXJlbnRpYWwgZXhwcmVzc2lvbiBhZnRlciB2cy4gYmVmb3JlIHRha2luZyB0aGUgZHJ1ZywgaW4gcGFydGljdWxhciB3aGV0aGVyIHRoaXMgaXMgZGlmZmVyZW50IGZvciB0aGUgZGlzZWFzZWQgdmVyc3VzIGhlYWx0aHkgZ3JvdXAgKGkuZS4sIHRoZSBpbnRlcmFjdGlvbiBiZXR3ZWVuIHRpbWUgKGJlZm9yZS9hZnRlciB0YWtpbmcgdGhlIGRydWcpIGFuZCBkaXNlYXNlIHN0YXR1cyAoaGVhbHRoeS9jb2xvbiBjYW5jZXIpKS4KCkluIHRlcm1zIG9mIHRoZSBtb2RlbCBtYXRyaXgsIHdlIGNvdWxkIGltYWdpbmUgYSBkZXNpZ24gc3VjaCBhcyBgIH4gcGF0aWVudCArIGRpc2Vhc2UqdGltZWAsIHdoZXJlIAoKIC0gYGRpc2Vhc2VgIGlzIGEgYmluYXJ5IGluZGljYXRvciByZWZlcnJpbmcgdG8gY29sb24gY2FuY2VyIHZlcnN1cyBjb250cm9sIHNhbXBsZS4KIC0gYHRpbWVgIGRlZmluZXMgaWYgdGhlIHNhbXBsZSBpcyB0YWtlbiBiZWZvcmUgb3IgYWZ0ZXIgdGFraW5nIHRoZSBkcnVnLgogLSBgcGF0aWVudGAgZGVmaW5lcyB0aGUgaW5kaXZpZHVhbCBkb25vciB0aGUgc2FtcGxlIGNvbWVzIGZyb20uCgpUaGUgcmVzZWFyY2ggcXVlc3Rpb24gY291bGQgdGhlbiBhbW91bnQgdG8gdGVzdGluZyB0aGUgYGRpc2Vhc2UgKiB0aW1lYCBpbnRlcmFjdGlvbi4KCkxldCdzIHRyeSB0aGlzLCBieSBzaW11bGF0aW5nIHJhbmRvbSBkYXRhIGZvciBvbmUgZ2VuZS4KCmBgYHtyfQpzZXQuc2VlZCgyKQojIDIgc2FtcGxlcyBwZXIgcGF0aWVudCBmb3IgOCBwYXRpZW50cwpwYXRpZW50IDwtIGZhY3RvcihyZXAobGV0dGVyc1sxOjhdLCBlYWNoPTIpKSAKIyBmaXJzdCBmb3VyIGFyZSBoZWFsdGh5LCBuZXh0IGZvdXIgYXJlIGRpc2Vhc2VkCmRpc2Vhc2UgPC0gZmFjdG9yKGMocmVwKCJoZWFsdGh5Iiw4KSwgcmVwKCJjYW5jZXIiLDgpKSwgbGV2ZWxzPWMoImhlYWx0aHkiLCAiY2FuY2VyIikpIAojIG9uZSBiZWZvcmUgYW5kIG9uZSBhZnRlciBzYW1wbGUgZm9yIGVhY2gKdGltZSA8LSBmYWN0b3IocmVwKGMoImJlZm9yZSIsICJhZnRlciIpLCA4KSwgbGV2ZWxzPWMoImJlZm9yZSIsICJhZnRlciIpKSAKCnRhYmxlKHBhdGllbnQsIGRpc2Vhc2UsIHRpbWUpCgojIyBzaW11bGF0ZSBkYXRhIGZvciBvbmUgZ2VuZQpuIDwtIDE2CnkgPC0gcnBvaXMobiA9IG4sIGxhbWJkYSA9IDUwKQoKIyMgZml0IGEgUG9pc3NvbiBtb2RlbAptIDwtIGdsbSh5IH4gcGF0aWVudCArIGRpc2Vhc2UqdGltZSwKICAgICAgICAgZmFtaWx5ID0gInBvaXNzb24iKQpzdW1tYXJ5KG0pCmBgYAoKIC0tLQogCldlIGZpbmQgdGhhdCBvbmUgb2YgdGhlIGNvZWZmaWNpZW50cyBpcyBgTkFgISBUaGlzIGlzIG9idmlvdXNseSBub3QgYmVjYXVzZSB3ZSdyZSBkZWFsaW5nIHdpdGggYE5BYCB2YWx1ZXMgaW4gdGhlIGRhdGEgYXMgd2UndmUganVzdCBzaW11bGF0ZWQgdGhlIHJlc3BvbnNlIHZhcmlhYmxlIG91cnNlbHZlcy4gV2hhdCdzIGdvaW5nIG9uPwoKT25lIG9mIHRoZSBwYXJhbWV0ZXJzLCBpbiB0aGlzIGNhc2UgdGhlIHBhcmFtZXRlciBkaXN0aW5ndWlzaGluZyBjYW5jZXIgZnJvbSBoZWFsdGh5IHBhdGllbnRzICoqY2Fubm90IGJlIGVzdGltYXRlZCBhcyBpdCBpcyBhIGxpbmVhciBjb21iaW5hdGlvbiBvZiBvdGhlciBwYXJhbWV0ZXJzKiouIEluIG91ciBjYXNlLCBlc3RpbWF0aW5nIHRoZSBkaXNlYXNlZCBlZmZlY3Qgd291bGQgdXNlIGluZm9ybWF0aW9uIHRoYXQgaXMgYWxyZWFkeSB1c2VkIHRvIGVzdGltYXRlIHRoZSBwYXRpZW50LWxldmVsIGludGVyY2VwdHMuIEluIG90aGVyIHdvcmRzLCAqKm9uY2UgeW91IGtub3cgdGhlIHBhdGllbnQsIHlvdSBpbW1lZGlhdGVseSBhbHNvIGtub3cgdGhlIGRpc2Vhc2Ugc3RhdHVzKiosIHNvIGVzdGltYXRpbmcgdGhlIGRpc2Vhc2VkIHZzIGhlYWx0aHkgZWZmZWN0IG9uIHRvcCBvZiB0aGUgcGF0aWVudCBlZmZlY3QgcHJvdmlkZXMgbm8gYWRkaXRpb25hbCBpbmZvcm1hdGlvbiBpZiB3ZSBoYXZlIGFscmVhZHkgZXN0aW1hdGVkIHRoZSBwYXRpZW50LWxldmVsIGVmZmVjdHMuIFRoaXMgY29uY2VwdCBpcyBjYWxsZWQgYWxpYXNpbmcsIGFuZCBpcyBhIGNvbW1vbiB0ZWNobmljYWwgaXNzdWUgaW4gJ29taWNzIGV4cGVyaW1lbnRzIHdpdGggY29tcGxleCBleHBlcmltZW50YWwgZGVzaWducy4gCgogLS0tCgpXaGlsZSB0byB1bmRlcnN0YW5kIHRoZSBvcmlnaW4gb2YgdGhlIGFsaWFzaW5nIGl0IGlzIGNydWNpYWwgdG8gdW5kZXJzdGFuZCB0aGUgcmVsYXRpb25zaGlwIGJldHdlZW4gdGhlIHZhcmlhYmxlcyBpbiB0aGUgZXhwZXJpbWVudGFsIGRlc2lnbiwgd2UgY2FuIGFsc28gaW52ZXN0aWdhdGUgaXQgaW4gZGV0YWlsIHVzaW5nIHRoZSBgYWxpYXNgIGZ1bmN0aW9uLCB0byBnaXZlIHVzIGFuIGlkZWEuCgpgYGB7cn0KYWxpYXMobSkKYGBgCgpXZSBzZWUgdGhhdCB0aGUgZWZmZWN0IGBkaXNlYXNlY2FuY2VyYCBpcyBhIGxpbmVhciBjb21iaW5hdGlvbiBvZiB0aGUgcGF0aWVudC1zcGVjaWZpYyBlZmZlY3RzIG9mIHRoZSBjYW5jZXIgcGF0aWVudHMuIFRoaXMgbWFrZXMgc2Vuc2UhCgogLS0tIAoKRm9yIGNsYXJpdHksIGxldCdzIHJlcHJvZHVjZSB0aGlzIHVzaW5nIG91ciBkZXNpZ24gbWF0cml4LgoKYGBge3J9ClggPC0gbW9kZWwubWF0cml4KH4gcGF0aWVudCArIGRpc2Vhc2UqdGltZSkgIyB0aGlzIGlzIHRoZSBkZXNpZ24gdXNlZCBpbiBnbG0oKQoKIyMgdGhlc2UgYXJlIGluZGVlZCBpZGVudGljYWwuClhbLCJkaXNlYXNlY2FuY2VyIl0KWFssInBhdGllbnRlIl0gKyBYWywicGF0aWVudGYiXSArIFhbLCJwYXRpZW50ZyJdICsgWFssInBhdGllbnRoIl0KYGBgCgpTaW5jZSBvbmUgb2Ygb3VyIHBhcmFtZXRlcnMgaXMgYSBsaW5lYXIgY29tYmluYXRpb24gb2Ygb3RoZXIgcGFyYW1ldGVycywgaXQgY2Fubm90IGJlIGVzdGltYXRlZCBzaW11bHRhbmVvdXNseSB3aXRoIHRoZSBvdGhlciBwYXJhbWV0ZXJzLiBJbiB0aGlzIGNhc2UsIHdlIGNhbiBhY3R1YWxseSBkcm9wIHRoZSBgZGlzZWFzZWAgbWFpbiBlZmZlY3QgZnJvbSB0aGUgbW9kZWwsIHNpbmNlIHdlIGtub3cgdGhhdCBpdCBpcyBhbHJlYWR5IGluY2x1ZGVkIGluIHRoZSBgcGF0aWVudGAgZWZmZWN0LgoKIC0tLQoKV2Ugd2lsbCBoYXZlIHRvIGNhcmVmdWxseSBjb25zdHJ1Y3Qgb3VyIGRlc2lnbiBtYXRyaXggaW4gb3JkZXIgdG8gYWNjb3VudCBmb3IgYWxsIGltcG9ydGFudCBzb3VyY2VzIG9mIHZhcmlhdGlvbiB3aGlsZSBzdGlsbCBhbGxvd2luZyB1cyB0byBhbnN3ZXIgdGhlIHJlc2VhcmNoIHF1ZXN0aW9uIG9mIGludGVyZXN0LiBUaGUgYWxpYXNpbmcgZXhwbG9yYXRpb24gYWJvdmUgaGFzIG1hZGUgaXQgY2xlYXIgd2UgbWF5IGRyb3AgdGhlIGBkaXNlYXNlYCBtYWluIGVmZmVjdCwgc28gbGV0J3Mgc3RhcnQgYnkgY29uc3RydWN0aW5nIHRoaXMgZGVzaWduIG1hdHJpeC4KCmBgYHtyfQpYIDwtIG1vZGVsLm1hdHJpeCh+IHBhdGllbnQgKyB0aW1lICsgZGlzZWFzZTp0aW1lKQoKbTIgPC0gZ2xtKHkgfiAtMSArIFgsCiAgICAgICAgIGZhbWlseSA9ICJwb2lzc29uIikKc3VtbWFyeShtMikKYWxpYXMobTIpCmBgYAoKV2UgYXJlIHN0aWxsIGNvbmZyb250ZWQgd2l0aCBhbGlhc2luZyBhcyB0aGUgbW9kZWwgbWF0cml4IGNvbnRhaW5zIGFuIGludGVyYWN0aW9uIGVmZmVjdCBgdGltZWJlZm9yZTpkaXNlYXNlY2FuY2VyYCBhcyB3ZWxsIGFzIGB0aW1lYWZ0ZXI6ZGlzZWFzZWNhbmNlcmAsIHdoaWxlIG9ubHkgdGhlIGxhdHRlciBpcyByZWxldmFudC4gSW5kZWVkLCB3ZSBrbm93IHRoYXQgd2UgY2FuIGRlcml2ZSB0aGUgYHRpbWViZWZvcmU6ZGlzZWFzZWNhbmNlcmAgZWZmZWN0IGJ5IGF2ZXJhZ2luZyB0aGUgcGF0aWVudCBlZmZlY3RzIG9mIHRoZSBjYW5jZXIgcGF0aWVudHMuCgogLS0tCgpgYGB7cn0KWCA8LSBYWywhY29sbmFtZXMoWCkgJWluJSAidGltZWJlZm9yZTpkaXNlYXNlY2FuY2VyIl0KCgojIyBmaXQgYSBQb2lzc29uIG1vZGVsCm0yIDwtIGdsbSh5IH4gLTEgKyBYLAogICAgICAgICBmYW1pbHkgPSAicG9pc3NvbiIpCnN1bW1hcnkobTIpCmBgYAoKV2Ugc2VlIHRoYXQgYWxsIGNvZWZmaWNpZW50cyBjYW4gbm93IGJlIGVzdGltYXRlZC4gVGhlIGB0aW1lYWZ0ZXJgIGVmZmVjdCBtYXkgYmUgaW50ZXJwcmV0ZWQgYXMgdGhlIHRpbWUgZWZmZWN0IGZvciBoZWFsdGh5IHBhdGllbnRzLCB3aGlsZSB0aGUgYHRpbWVhZnRlcjpkaXNlYXNlY2FuY2VyYCBlZmZlY3QgbWF5IGJlIGludGVycHJldGVkIGFzIHRoZSBkaWZmZXJlbmNlIGluIHRoZSB0aW1lIGVmZmVjdCBmb3IgY2FuY2VyIHBhdGllbnRzIGFzIGNvbXBhcmVkIHRvIGhlYWx0aHkgcGF0aWVudHMsIGkuZS4sIGl0IGlzIHRoZSByZWxldmFudCBpbnRlcmFjdGlvbiBlZmZlY3Qgd2UgYXJlIGludGVyZXN0ZWQgaW4uIAoK</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("sequencing_technicalDE.Rmd");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
